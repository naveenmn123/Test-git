-- ==================================================
-- Method reference
-- ApproveFieldChangeRequest -> Core   
-- BeApproveFieldChangeRequest -> Client Portal   
-- =================================================== 
DROP PROCEDURE IF EXISTS `SP_APPROVE_FIELD_CHANGE_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_APPROVE_FIELD_CHANGE_REQUEST`(
iRID bigint,
iCID bigint,	
iConsultantID bigint,
iApproverStatus tinyint,
tRemarks text,
iIsERApproved smallint,
iApprover2 tinyint,
iFixedApproverID BIGINT,
iUserID BIGINT,
out iStatus smallint,
out tStatusMsg text,
out iIsFinalApprover TINYINT,
OUT iChangeType TINYINT
)
BEGIN
	declare iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID bigint default 0;
	DECLARE iBranchDmID , iContractDmID , iClientDMID , iStaffingID, iRequestID,iBusinessAnchorID, iCostCenterManagerID,iType,iBUManagerID,iBUSalesAnchorID BIGINT default 0;
	DECLARE CondQry text default '' ;
    
	set iStatus = 0;
    set tStatusMsg = "";
	set iIsFinalApprover = 0;
	set iChangeType = 0;
    
    SELECT StaffingID, RequestID INTO iStaffingID, iRequestID 
		FROM ebnp_cons_field_change_approval WHERE RID = iRID AND CID=iCID AND ConsultantID=iConsultantID limit 1;       
	
	  SELECT si.ContactID, h.ERManagerID, si.ReportingPerson1ID, si.ReportingPerson2ID, c.AnchorID, IFNULL(p.ProjectPartnerID, h.ERManagerID) as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	, 
					IFNULL(bu.AnchorID,0) AS BusinessAnchor, IFNULL(Cuc.ManagerID, 0) as CostCenterManagerID ,
                    IFNULL(bu.EmpManagerID,0) AS EmpManagerID, IFNULL(bu.SalesAnchorID,0) AS SalesAnchorID
		INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
				iClientDMID, iContractDmID, iBranchDmID, iBusinessAnchorID, iCostCenterManagerID ,iBUManagerID,iBUSalesAnchorID

        from ebnp_cand_staffing_info si 
        JOIN ebnp_cand_hr_details h ON h.ConsultantID = si.ConsultantID and h.CID = si.CID 
		join ebnp_client_contracts c on c.RID = si.ContractID and c.CID = si.CID 
		join ebnp_clients cl on cl.RID = c.ClientID and cl.CID = si.CID 
		left join (select p.RID, p.ProjectPartnerID, p.ContractID from ebnp_client_contract_project p 
							left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
                         where p.CID = iCID order by t.RID desc, p.RID desc limit 1)
        p on p.ContractID = c.RID
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=cl.CID 
        LEFT JOIN ebnp_clients bu on bu.RID = si.BUID AND bu.CID = si.CID 
        LEFT JOIN ebnpsm_customer_cc Cuc on Cuc.RID = si.BillingCostCenterID AND Cuc.CustomerID = si.CID 
        WHERE si.CID = iCID AND si.RID = iStaffingID limit 1 ;
	
	
    UPDATE ebnp_cons_field_change_approval SET Remarks = tRemarks, RequestStatus = iApproverStatus, ModifiedUserID=iUserID 
					 WHERE RID = iRID AND CID=iCID  ;          
	
    SELECT IFNULL(ChangeType,0) INTO iChangeType FROM ebnp_consultant_field_change_request WHERE CID = iCID AND RID = iRequestID ;
    
    IF iIsERApproved = 0 and iApprover2 > 0 and iApproverStatus = 1 
			and not exists(select RID from ebnp_cons_field_change_approval where  RequestID = iRequestID AND StaffingID = iStaffingID AND RequestStatus = 0 and ApproverType = iApprover2
				AND ( (ApproverType in (14,15,16) AND ApproverID = iFixedApproverID) OR ApproverType not in (14,15,16) ) ) then	
        BEGIN
			INSERT INTO ebnp_cons_field_change_approval (CID, ConsultantID, StaffingID, RequestID, ApproverType, ApproverID,CreatedUserID) 
												VALUES (iCID, iConsultantID, iStaffingID, iRequestID, iApprover2, (case iApprover2 when 1 then iContactID WHEN 2 THEN iERManagerID
																								WHEN 3 then iReportingPerson1ID when 4 then iReportingPerson2ID 
																								WHEN 5 then iContractAnchorID when 6 then iProjectPartnerID
																								when 7 then iClientAnchorID WHEN 9 THEN iClientDMID
																								WHEN 10 THEN iBranchDmID  WHEN 11 THEN iContractDmID 
																								WHEN 12 THEN iBusinessAnchorID WHEN 13 THEN iCostCenterManagerID 
																								WHEN 14 THEN iFixedApproverID WHEN 15 THEN iFixedApproverID 
																								WHEN 16 THEN iFixedApproverID WHEN 17 then iBUManagerID WHEN 18 then iBUSalesAnchorID 
																								else 0 end), iUserID );
        END;
        
	ELSEIF iApprover2 = (select ApproverType from ebnp_cons_field_change_approval where RequestID = iRequestID AND StaffingID = iStaffingID AND  RequestStatus= 0 ORDER BY RID DESC LIMIT 1 ) and iApproverStatus = 1 then
		
			UPDATE ebnp_cons_field_change_approval set RequestStatus = iApproverStatus, ApproverID = iUserID where RID = iRID AND ConsultantID=iConsultantID ;
			UPDATE ebnp_consultant_field_change_request SET Status = iApproverStatus WHERE RID = iRequestID and CID = iCID;
			SET iIsFinalApprover = 1;
	elseif iApproverStatus = 1 AND not exists(select RID from ebnp_cons_field_change_approval where RequestID = iRequestID AND StaffingID = iStaffingID and RequestStatus = 0) then 
		BEGIN				
			update ebnp_cons_field_change_approval set RequestStatus = iApproverStatus, ApproverID =iUserID where RID = iRID AND ConsultantID=iConsultantID ;
			UPDATE ebnp_consultant_field_change_request SET Status = iApproverStatus  WHERE RID = iRequestID and CID = iCID;
            SET iIsFinalApprover = 1;
        END;        
	ELSE		  
		UPDATE ebnp_cons_field_change_approval SET Remarks = tRemarks, RequestStatus = iApproverStatus, ModifiedUserID=iUserID 
		 WHERE RID = iRID  AND CID=iCID AND ConsultantID=iConsultantID ;
         
		UPDATE ebnp_consultant_field_change_request SET Status = iApproverStatus  WHERE RID = iRequestID and CID = iCID;
        SET iIsFinalApprover = 1;
	END IF;  
    
    set iStatus = 1;
    set tStatusMsg = "Request status updated successfully";
    
END ;;
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_APPROVE_OFFER_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_APPROVE_OFFER_REQUEST`(
iRID bigint,
iCID bigint,
iConsultantID bigint,
iApproverStatus tinyint,
tOfferRemark text,
iIsERApproved smallint,
iApprover2 tinyint,
iFixedApproverID BIGINT,
iUserID BIGINT,
out iStatus smallint,
out tStatusMsg text
)
BEGIN
	declare iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID bigint default 0;
	DECLARE iBranchDmID , iContractDmID , iClientDMID , iStaffingID, iReqConsID,iBusinessAnchorID, iCostCenterManagerID BIGINT default 0;
	DECLARE iBUManagerID,iBUSalesAnchorID BIGINT ;
    
	set iStatus = 0;
    set tStatusMsg = "";
    
    SELECT StaffingID, ReqConsID INTO iStaffingID, iReqConsID 
		FROM ebnp_offer_approval WHERE RID = iRID AND CID=iCID AND ConsultantID=iConsultantID limit 1;       
	
	IF iStaffingID > 0 THEN 
	  SELECT si.ContactID, h.ERManagerID, si.ReportingPerson1ID, si.ReportingPerson2ID, c.AnchorID, IFNULL(p.ProjectPartnerID, h.ERManagerID) as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	, 
					IFNULL(bu.AnchorID,0) AS BusinessAnchor, IFNULL(Cuc.ManagerID, 0) as CostCenterManagerID,
                    IFNULL(bu.EmpManagerID,0) AS EmpManagerID,IFNULL(bu.SalesAnchorID,0) AS SalesAnchorID
		INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
				iClientDMID, iContractDmID, iBranchDmID, iBusinessAnchorID, iCostCenterManagerID , iBUManagerID,iBUSalesAnchorID

        from ebnp_cand_staffing_info si 
        JOIN ebnp_cand_hr_details h ON h.ConsultantID = si.ConsultantID and h.CID = si.CID 
		join ebnp_client_contracts c on c.RID = si.ContractID and c.CID = si.CID 
		join ebnp_clients cl on cl.RID = c.ClientID and cl.CID = si.CID 
		left join (select p.RID, p.ProjectPartnerID, p.ContractID from ebnp_client_contract_project p 
							left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
                         where p.CID = iCID order by t.RID desc, p.RID desc limit 1)
        p on p.ContractID = c.RID
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=cl.CID 
        LEFT JOIN ebnp_clients bu on bu.RID = si.BUID AND bu.CID = si.CID 
        LEFT JOIN ebnpsm_customer_cc Cuc on Cuc.RID = si.BillingCostCenterID AND Cuc.CustomerID = si.CID 
        WHERE si.CID = iCID AND si.RID = iStaffingID limit 1 ;
	ELSE
	  SELECT cr.ContactID, 0 as ERManagerID, 0 as ReportingPerson1ID, 0 as ReportingPerson2ID, c.AnchorID, 0 as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID				
		INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
				iClientDMID, iContractDmID, iBranchDmID  

        from ebnp_req_resumes si 
		JOIN ebnp_client_requirements cr ON cr.CID = si.CID AND cr.RID = si.ReqID  
		LEFT join ebnp_client_contracts c on c.RID = cr.ContractID and c.CID = si.CID 
		LEFT join ebnp_clients cl on cl.RID = si.ClientID  and cl.CID = si.CID 
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=si.CID        
        WHERE si.CID = iCID AND si.RID = iReqConsID limit 1 ;
	END IF;
	
    UPDATE ebnp_offer_approval SET OfferRemark = tOfferRemark, OfferStatus = iApproverStatus, ModifiedUserID=iUserID 
					 WHERE RID = iRID AND CID=iCID  ;          
	
    IF iIsERApproved = 0 and iApprover2 > 0 and iApproverStatus = 1 and 
				not exists(select RID from ebnp_offer_approval where  ((ReqConsID = iReqConsID AND iReqConsID > 0) OR (StaffingID = iStaffingID AND iStaffingID > 0)) AND Status = 0 
											and ApproverType = iApprover2 AND ((ApproverType in (14,15,16) AND ApproverID = iFixedApproverID) 
									OR ApproverType not in (14,15,16)) ) then
		BEGIN
			insert into ebnp_offer_approval (CID,  ConsultantID, StaffingID, ReqConsID, ApproverType, ApproverID,CreatedUserID) 
								    values (iCID,  iConsultantID, iStaffingID, iReqConsID, iApprover2, (case iApprover2 when 1 then iContactID WHEN 2 THEN iERManagerID
																					when 3 then iReportingPerson1ID when 4 then iReportingPerson2ID 
																					WHEN 5 then iContractAnchorID when 6 then iProjectPartnerID
																					when 7 then iClientAnchorID WHEN 9 THEN iClientDMID
																					WHEN 10 THEN iBranchDmID  WHEN 11 THEN iContractDmID 
                                                                                    WHEN 12 THEN iBusinessAnchorID WHEN 13 THEN iCostCenterManagerID 
                                                                                    WHEN 14 THEN iFixedApproverID WHEN 15 THEN iFixedApproverID 
																					WHEN 16 THEN iFixedApproverID when 17 then iBUManagerID when 18 then iBUSalesAnchorID
																					else 0 end), iUserID );
        END;
        
	ELSEIF iApprover2 = (select ApproverType from ebnp_offer_approval where ((ReqConsID = iReqConsID AND iReqConsID > 0) OR (StaffingID = iStaffingID AND iStaffingID > 0)) AND  Status= 0 ORDER BY RID DESC LIMIT 1 ) and iApproverStatus = 1 then
		
			UPDATE ebnp_offer_approval set OfferStatus = iApproverStatus, ApproverID =iUserID where RID = iRID AND ConsultantID=iConsultantID ;
			UPDATE ebnp_req_resumes_extend SET OfferApprovalStatus = (iApproverStatus + 1) WHERE ReqResumeID = iReqConsID and CID = iCID;

	elseif iApproverStatus = 1 AND not exists(select RID from ebnp_offer_approval where ((ReqConsID = iReqConsID AND iReqConsID > 0) OR (StaffingID = iStaffingID AND iStaffingID > 0)) and Status = 0) then 
		BEGIN				
			update ebnp_offer_approval set OfferStatus = iApproverStatus, ApproverID =iUserID where RID = iRID AND ConsultantID=iConsultantID ;
			UPDATE ebnp_req_resumes_extend SET OfferApprovalStatus = (iApproverStatus + 1) WHERE ReqResumeID = iReqConsID and CID = iCID;
        END;        
	ELSE		  
		UPDATE ebnp_offer_approval SET OfferRemark = tOfferRemark, OfferStatus = iApproverStatus, ModifiedUserID=iUserID 
		 WHERE RID = iRID  AND CID=iCID AND ConsultantID=iConsultantID ;
         
		UPDATE ebnp_req_resumes_extend SET OfferApprovalStatus = (iApproverStatus + 1) , OARemarks=tOfferRemark WHERE ReqResumeID = iReqConsID and CID = iCID;			
	END IF;  
    
    set iStatus = 2;
    set tStatusMsg = "Offer request status updated successfully";
    
END ;;
DELIMITER ;
-- ==================================================
-- Method reference
--  BeCopyContractDetails-> Core
-- ===================================================
DROP PROCEDURE IF EXISTS `SP_COPY_CONTRACT_DETAILS`;

DELIMITER ;;
CREATE PROCEDURE `SP_COPY_CONTRACT_DETAILS`(
iCID bigint,
iUserID bigint,
iContractID bigint,
iExpectedClientID bigint,
iExpectedBranchID  bigint,
iContactID bigint,
tContractNo TEXT,
dtStartDate DATE,
dtEndDate DATE,
iAnchorID bigint, 
out iStatusVal tinyint,
out tStatusMsg text ,
out iSavedID BIGINT 
)
BEGIN
	DECLARE  tValidStatusMsg  TEXT DEFAULT "";
    DECLARE iValidStatus TINYINT DEFAULT 0 ; 
	declare tPrefix, tSuffix, iAutoNumber,tContractCode text default "";
    DECLARE auRID,iSavedID BIGINT DEFAULT 0;
    
	set iStatusVal=0;
    set iSavedID=0;
    set tStatusMsg='';
     IF iCID = 0 OR NOT EXISTS (Select RID From ebnpsm_customer where RID = iCID) Then
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Customer");
    END IF;
     IF iUserID = 0 OR NOT EXISTS (Select RID From ebnpsm_customer_user where CustomerID = iCID and RID = iUserID) Then
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Customer User");
    END IF; 
	IF iContractID = 0 OR NOT EXISTS (Select RID From ebnp_client_contracts where CID = iCID and RID = iContractID) Then
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Contract");
    END IF;
	IF iExpectedClientID = 0 OR NOT EXISTS (Select RID From ebnp_clients where CID = iCID and RID = iExpectedClientID) Then
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Client");
    END IF;
    IF iExpectedBranchID > 0 AND NOT EXISTS (Select RID From ebnp_client_branchs Where RID = iExpectedBranchID AND ClientID = iExpectedClientID) THEN 
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Client Branch");
	END IF; 
    
    IF iContractID > 0 AND NOT EXISTS (Select RID From ebnp_client_contact  Where ClientID = iExpectedClientID AND  RID= iContactID) THEN 
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Client Contact");
	END IF; 
    
	 IF (tStatusMsg != "") THEN 
		Set iStatusVal = -5; 
        IF SUBSTRING(tStatusMsg, 1, 1) = '/' Then
			Set tStatusMsg = SUBSTRING(tStatusMsg, 2);
		END IF;
    ELSE 		    
			SET iValidStatus = 0;
            SET tValidStatusMsg = "";
			
			CALL SP_CHECK_DUPLICATE_CUSTOMER_CLIENT_CONTRACT (0, iCID, iExpectedClientID, iExpectedBranchID, iContactID,tContractNo, iValidStatus, tValidStatusMsg);
            
            IF (iValidStatus < 0) THEN
				BEGIN
					Set iStatusVal = iValidStatus;
					Set tStatusMsg = tValidStatusMsg;
				END;
			ELSE
				BEGIN 
					set tContractCode='';
					Select IFNULL(Prefix, ''), (CASE NumberLength WHEN 0 THEN (AutoNumber + 1) ELSE LPAD((AutoNumber + 1), NumberLength, 0) END) as AutoNumber, IFNULL(Suffix, ''), RID INTO tPrefix, iAutoNumber, tSuffix, auRID From ebnpm_client_contract_code_auto_number Where CID = iCID LIMIT 0, 1;
					
                    select FN_GET_AUTO_NUMBER_MULTIPLE_REPLACE(iCID,iUserID,iExpectedClientID,iExpectedBranchID,0,CONCAT(tPrefix, iAutoNumber, tSuffix),null ) into tContractCode;
					
                    UPDATE ebnpm_client_contract_code_auto_number Set AutoNumber = AutoNumber + 1 Where RID = auRID; 
					 
					INSERT INTO ebnp_client_contracts (CID, ClientID, BranchID, ContactID, ContractNo, ContractCode, StartDate, EndDate, BillingOptionID, InvoiceGroupTemplateID, AnchorID, PaymentDueDays, CreatedUserID, ModifiedUserID , HrOptionID , ConsCategoryID , EmpManagerID)
					 select iCID, iExpectedClientID,iExpectedBranchID, iContactID, tContractNo, tContractCode, dtStartDate, dtEndDate, BillingOptionID, InvoiceGroupTemplateID, iAnchorID, PaymentDueDays, iUserID, iUserID ,HrOptionID , ConsCategoryID , EmpManagerID from ebnp_client_contracts where RID=iContractID and CID=iCID;
					  set iSavedID=@@identity; 
					 
                      -- PO Line Items
                      INSERT INTO ebnp_client_contracts_poline_items (RefID, CID, ClientID, ContractID, POLineItemID, Rate, MarkDefault, CreatedUserID,MarkAsConsolidate, GroupTypeID, GroupTitleType, InvoiceGenAfterDOJ, InvoiceGenAfterFirstPayroll, effectiveMonth)
                      
                      SELECT  RefID, iCID, iExpectedClientID, iSavedID, POLineItemID, Rate, MarkDefault, iUserID,MarkAsConsolidate, GroupTypeID, GroupTitleType, InvoiceGenAfterDOJ, InvoiceGenAfterFirstPayroll ,effectiveMonth
                      FROM ebnp_client_contracts_poline_items WHERE Status=0 and IsDeleted = 0 and ContractID=iContractID and CID=iCID; 

                      -- OT Ratesetup
                      INSERT INTO ebnp_client_contract_ot_details (CID, ContractID, ClientID, OTType, WorkOTRate, WOOTRate, HOTRate, OHOTRate, CreatedUserID )
                      SELECT   iCID, iSavedID, iExpectedClientID, OTType, WorkOTRate, WOOTRate, HOTRate, OHOTRate, iUserID FROM ebnp_client_contract_ot_details WHERE ContractID=iContractID and CID=iCID;
                      --  sal header overrides 
					    INSERT INTO ebnp_client_contract_salary_header_master(CID, ClientID, ContractID, SalaryHeaderID, MinValue, `MaxValue`, ConsiderMaxSalCheck, BillingType, RoundOff, AppForPF, AppForESI, AppForPT, AppForLWF,  AppForOT, NotWithWorkPeriod, PayForZeroWork, PayBackToClient, ConsiderForMargin, ProrateOn26Days, CreatedUserID,  NotComputeESI, NotConsiderForESIGross, RoundUp, AppForExtDay, ConsiderMinWg)
																				   SELECT  iCID, iExpectedClientID, iSavedID, SalaryHeaderID, MinValue, `MaxValue`, ConsiderMaxSalCheck, BillingType, RoundOff, AppForPF, AppForESI, AppForPT, AppForLWF,  AppForOT, NotWithWorkPeriod, PayForZeroWork, PayBackToClient, ConsiderForMargin, ProrateOn26Days, iUserID , NotComputeESI, NotConsiderForESIGross, RoundUp, AppForExtDay, ConsiderMinWg FROM ebnp_client_contract_salary_header_master where ContractID=iContractID; 
					--  Sal/Reimburse
                      call SP_COPY_SAL_REIMB_DETAILS(iCID  ,iSavedID ,iExpectedClientID ,iContractID,iUserID ); 
                      -- contract options
                      INSERT  INTO ebnp_client_contracts_options(CID, ClientID, ContractID, StatutoryStateID, StatutoryLocationID, PayslipID, MandatoryPOToProcess, AllowToMarkShortFall, SkipMarkupOnEnDESI, 
																MinOverTimeHours, TrackTaskWithAttendance, LeaveCycleMonth, TransferCoolingPeriod, AllowPSAfterSalRelease, BankStatementType, CreatedUserID, CreatedDate, ModifiedUserID, ModifiedDate, ConsiderHalfYearlyPT, 
                                                                ComputePRLEnDMarkUp, ProcessExtDayWithSal, MandSelfieAttPunch, MandGeoFence, MandEarlyAttendance, MandAttendanceFrom , ReplacementPeriod , CostCenterID , DepositBankAccountID , MaxLimitType , MaxPeriodLimit,
                                                                MaxPresentHours , NoPayPaidStatusNotification , AdvClientMonthlyInvoice , MandatoryPOForPayout , MandatoryAllEmpForInvoice , FNFslipID , AllocatedHeadCount , RestrictHeadCount , SkipMultipleMarkUpForProcessMonth,
                                                                JobCategoryID , JobSubCategoryID , IndustryID , OTAmountonBillRate , ProrateInsuranceJoiningMonth , IncludeAllowanceRateCard , AllowExcessPayDaysThanActual , EnableTSAutoMailer , TemplateID ,TSAutoMailerTo,
                                                                TSAutoMailerFreq ,TSAutoWeekDay , TSAutoMonthlyDay , MilestoneNarrationID , ConsiderDOJTimesheetStartDate , PaybacktoClientAdjustType , PaybacktoClientAdjustCollection , ConsultantContractDays ,
                                                                EnableInventory , NoOTOnArrears , MinWageMandatory , WorkVenueID , TaskEscalationUserID , ConsiderShiftBillRate , ContractExtdTemplateID , EnableCandidatePaymentWorkflow , CanUpdateLWD , RCBComputewrtFractions , 
                                                                RCBComputewrtFractionsLen , AllowRMtoUpdateTeamAttendanceWithSelfie
                                                                )
						SELECT iCID, iExpectedClientID, iSavedID, StatutoryStateID, StatutoryLocationID, PayslipID, MandatoryPOToProcess, AllowToMarkShortFall, SkipMarkupOnEnDESI,
																MinOverTimeHours, TrackTaskWithAttendance, LeaveCycleMonth, TransferCoolingPeriod, AllowPSAfterSalRelease, BankStatementType, CreatedUserID, CreatedDate, ModifiedUserID, ModifiedDate, ConsiderHalfYearlyPT, 
                                                                ComputePRLEnDMarkUp, ProcessExtDayWithSal, MandSelfieAttPunch, MandGeoFence, MandEarlyAttendance, MandAttendanceFrom , ReplacementPeriod , CostCenterID , DepositBankAccountID , MaxLimitType , MaxPeriodLimit,
                                                                MaxPresentHours , NoPayPaidStatusNotification , AdvClientMonthlyInvoice , MandatoryPOForPayout , MandatoryAllEmpForInvoice , FNFslipID , AllocatedHeadCount , RestrictHeadCount , SkipMultipleMarkUpForProcessMonth , 
                                                                JobCategoryID , JobSubCategoryID , IndustryID , OTAmountonBillRate , ProrateInsuranceJoiningMonth , IncludeAllowanceRateCard , AllowExcessPayDaysThanActual , EnableTSAutoMailer , TemplateID , TSAutoMailerTo,
                                                                TSAutoMailerFreq , TSAutoWeekDay , TSAutoMonthlyDay , MilestoneNarrationID , ConsiderDOJTimesheetStartDate , PaybacktoClientAdjustType , PaybacktoClientAdjustCollection , ConsultantContractDays , 
                                                                EnableInventory , NoOTOnArrears , MinWageMandatory , WorkVenueID , TaskEscalationUserID , ConsiderShiftBillRate , ContractExtdTemplateID , EnableCandidatePaymentWorkflow , CanUpdateLWD , RCBComputewrtFractions ,
                                                                RCBComputewrtFractionsLen , AllowRMtoUpdateTeamAttendanceWithSelfie
                                                                FROM ebnp_client_contracts_options WHERE CID = iCID AND ContractID=iContractID;
                    
                    -- contract shifts 
					 insert	 into ebnp_client_contracts_shifts( CID, ClientID, ContractID, ShiftID, AllowanceCurrencyID, AllowanceRate, AllowanceRateUnit, AllowanceLimit, AllowanceLimitType, MarkUp, CreatedUserID )
					 select  iCID, iExpectedClientID, iSavedID, ShiftID, AllowanceCurrencyID, AllowanceRate, AllowanceRateUnit, AllowanceLimit, AllowanceLimitType, MarkUp, iUserID  from ebnp_client_contracts_shifts where ContractID=iContractID; 
                     
                     -- OT details
                     Insert into ebnp_client_contract_ot_details(CID ,ContractID ,ClientID , OTType ,WorkOTRate, WOOTRate ,HOTRate ,OHOTRate)
                     select CID , iSavedID , ClientID , OTType ,WorkOTRate, WOOTRate ,HOTRate ,OHOTRate 
                     from ebnp_client_contract_ot_details
                     where CID = iCID and ContractID = iContractID ;
                     
					Set tStatusMsg = "Details Copied successfully";
					SET iStatusVal = 2;
                END;
			END IF;
    END IF;
END ;;

DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_COPY_SAL_REIMB_DETAILS`;
DELIMITER ;;
CREATE PROCEDURE `SP_COPY_SAL_REIMB_DETAILS`(
iCID bigint,
iSavedID bigint,
iExpectedClientID bigint,
iContractID bigint,
iUserID bigint
)
BEGIN
	declare iNewSalID,iSalRID bigint default 0;    
	declare finished tinyint default 0;
	DECLARE Cont_Sal_Cur CURSOR FOR select RID from ebnp_client_contracts_salary_headers where CID = iCID and ContractID=iContractID;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1; 					   
	OPEN Cont_Sal_Cur;
		getContractSal: LOOP
			FETCH Cont_Sal_Cur INTO iSalRID;
			IF finished = 1 THEN 
				LEAVE getContractSal;
			END IF; 
            
			INSERT INTO ebnp_client_contracts_salary_headers ( CID, ClientID, ContractID, SalaryHeaderID, MarkUp, RatePerUnit, IsProofMandatory, ApplicableForPF, ApplicableForESI, ApplicableForLWF, ConsiderMinExemption, AllowToRaiseClaimInESS, ConsiderMinExemptionRate, CreatedUserID,  SlabIsRatePerUnit , MaxLimit)
			SELECT  iCID, iExpectedClientID, iSavedID, SalaryHeaderID, MarkUp, RatePerUnit, IsProofMandatory, ApplicableForPF, ApplicableForESI, ApplicableForLWF, ConsiderMinExemption, AllowToRaiseClaimInESS, ConsiderMinExemptionRate, iUserID,  SlabIsRatePerUnit  , MaxLimit FROM
			ebnp_client_contracts_salary_headers
			WHERE RID=iSalRID;
			SET iNewSalID=@@identity;
            
			INSERT INTO ebnp_client_contracts_reimbur_units( ConSalHeaderID, CID, ValueFrom, ValueTill, RatePerUnit, CreatedUserID)
			SELECT iNewSalID, iCID, ValueFrom, ValueTill, RatePerUnit, iUserID
			FROM ebnp_client_contracts_reimbur_units
			WHERE ConSalHeaderID=iSalRID ; 
                
		END LOOP getContractSal; 
	CLOSE Cont_Sal_Cur;
END ;;

DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_CP_GET_OFFER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_CP_GET_OFFER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iContactID BIGINT 
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID ,iOfferLetterID BIGINT DEFAULT 0;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0)  ,
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    
    
    SELECT OfferLetterID, ReqConsID INTO iOfferLetterID, iReqConsID FROM ebnp_offer_approval WHERE RID = iRID AND CID = iCID LIMIT 1;
    
	SET tQRY = CONCAT(' SELECT a.RID as RID,   						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat((case i.Salutation when 0 then "Mr." when 1 then "Ms." when 2 then "Dr." when 3 then "Prof." when 4 then "Mrs." end), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.ConsultantID ,   a.OfferLetterID as OfferRequestID, 		
						a.OfferStatus as Status, (CASE a.OfferStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.OfferRemark, "") as Remarks, 
                        
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,                        
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, 
							ifnull((select lc.LocationTitle from ebnpm_location lc where lc.RID = si.WorkingLocationID), "") as Locations,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as OfferedDesignation, 
							hr.PresentCTC as OfferedCTC, 
							hr.PresentCTC,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation, 

						"" as HikePercent, 
						"" as MarkUpPercent, 
							');
	ELSE 
		SET tQRY = CONCAT(tQRY,' 										
						r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
						(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
                        rq.ContactID,r.ClientID as ClientID,
                        ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
                        r.BranchID,
                        IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
                        ifnull(cc.ContractNo ,"") as ContractNo,
						ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
						ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
						
						IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
						
						rq.PlacementType as PlacementType, 
						(CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
						
						CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
						CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill,  " ", 
									ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
								as BillRateRange ,
						
						ifnull((select lc.LocationTitle from ebnpm_location lc where lc.RID = r.OfferedLocationID), "") as Locations,
						
						IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
						r.OfferedDesignationID, 
						IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
						r.ExpectedDOJ as ExpectedDOJ, 
						
						CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC,
						IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
						
						/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
									  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
									  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/
						
                        IFNULL(',dPercentageHike,',0.00) AS HikePercent,
						IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
						IFNULL(',dBillRate,' ),0.00) as BillRate,
                        
						"" as MarkUpPercent, 
						
                        ');    
     END IF;
    
	SET tQRY=CONCAT(tQRY,'
						i.Experience as YrsOfExp, 
                        FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverUser 
                                    
					FROM ebnp_offer_approval a 
					JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID  
                     ');
                                    
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');                        
	ELSE
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
                            ');
	 END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.ApproverID = ',iContactID,' 
							AND a.ApproverType in (1,14,17) AND a.RID = ',iRID,'  '); 
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');  
	
	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;
DELIMITER 
-- ==================================================
-- Method reference
-- SaveConsLeaveRequest -> ESS   
-- =================================================== 
DROP PROCEDURE IF EXISTS `SP_ESS_GET_CONS_LEAVE_REQUEST_DETAILS`;
DELIMITER $$
CREATE PROCEDURE `SP_ESS_GET_CONS_LEAVE_REQUEST_DETAILS`
(
iRID BIGINT,
iCID BIGINT
)
BEGIN
DECLARE iLeaveRequestID,iConsultantID BIGINT DEFAULT 0;

 select LeaveRequestID,ConsultantID into iLeaveRequestID,iConsultantID from ebnp_ess_consultant_leave_approve where RID=iRID AND CID=iCID;

     WITH mail_tempaltes AS (SELECT t.RID, t.CID, t.MailCC,t.MailBCC,t.MailSubject,MailBody,FromEmailID 
			FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 71 ORDER BY t.RID DESC LIMIT 1)
             SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,IFNULL(mt.FromEmailID,es.EMailID) AS FromEMail,ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_ess_consultant_leave a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.RID=iRID ;
                  
	-- Table 1 MAIL BODY AND MAIL SUBJECT           
				SELECT t.MailCC,t.MailBCC,t.CID
				FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 71 ORDER BY t.RID DESC LIMIT 1;
	
    -- Table 2 Mail Details			
			  select  
					c.CustomerTitle  as CustomerName,  	 
				    ifnull(es.LogoName, "") as LogoName, 
				    ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
                    IFNULL(es.EMailID,"") as FromEMail,
					IFNULL(c.CustomerShortName, "") as CustomerSName, 
					FN_GET_SMS_PROVIDER_KEY(c.RID) as `SMSDTLRegName`, 
					FN_GET_SMS_PROVIDER_SHT_KEY(c.RID) as `SMSDTLShtRegName`, 
					a.ConsultantID,l.LeaveNotes AS LeaveNotes,
					TRIM(Replace(concat((CASE i.Salutation When 0 Then "Mr." When 1 then "Ms." When 2 then "Dr." when 3 then "Prof." when 4 then "Mrs." Else "" END)
					, "" , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
					(CASE WHEN IFNULL(i.OfficialEMailID,"")!="" then  i.OfficialEMailID else  i.EMailID end) as ToEmail,
					i.MobileNo as MobileNo, i.EmployeeNo, 
					date_format(l.LeaveFrom, '%d-%b-%Y') as LeaveFrom,  date_format(l.LeaveTill, '%d-%b-%Y') as LeaveTill, 
					(case when l.LeaveID > 0 then (select DisplayName from ebnpm_leave where rid = l.LeaveID and CID = l.CID) 
						  when l.LeaveID = -1 then "LOP" WHEN l.LeaveID = -5 THEN "Comp Off" end) as LeaveName,
					l.NoofDays, 
					(case a.ApproveStatus when 0 then "Pending" WHEN 1 THEN "Approved" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END) as ApproverStatus,
						 -- to get approver Name
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverName,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(l.RID) as LevReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64, 
					c.ESSURL as ESSURLLink,
					a.ApproverComments as LeaveRejectNotes,
					IFNULL((SELECT RID FROM ebnpm_general_master WHERE CID = l.CID AND MasterType = 55 ORDER BY RID DESC LIMIT 1),0) as WhatsAppTempID,
					ifnull((SELECT TotaVar FROM ebnp_whatsapp_template WHERE CID = l.CID AND RID 
						in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 55 ) ),0) as TotaVar,
					ifnull((SELECT (case LangCode when 0 then "en" else "hi" end) FROM ebnp_whatsapp_template WHERE CID = l.CID 
							AND RID in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 55 ) ),0) as LanguageCode
					
					from ebnp_ess_consultant_leave l 
					LEFT join ebnp_ess_consultant_leave_approve a on l.CID = a.CID AND l.RID = a.LeaveRequestID AND a.ApproveStatus=0
					join ebnp_cand_personal_info i on i.CID = l.CID AND i.RID = l.ConsultantID
					join ebnpsm_customer c on c.RID = l.CID
                    LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=l.CID
					where l.CID = iCID AND l.RID = iRID;
    
    
      -- Approver MAIL DETAILS

     -- TABLE 3 FOR MAILBODY AND MAILSUBJECT
      WITH mail_tempaltes AS (SELECT t.RID, t.CID, t.MailCC,t.MailBCC,t.MailSubject,MailBody,FromEmailID 
			FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 65 ORDER BY t.RID DESC  LIMIT 1)
             SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,IFNULL(mt.FromEMailID,es.EMailID) AS FromEMail,ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_ess_consultant_leave a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.RID=iRID ;
                  
	    -- Table 4  MAIL CC
				  WITH all_cc as (
                  WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 65 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.MailCC as MailCC, mt.MailBCC as MailBCC, a.CID
				  FROM  ebnp_ess_consultant_leave_approve a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (select EmailID from ebnp_cand_personal_info WHERE CID=a.CID and RID=a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_ess_consultant_leave_approve a 
                  where  a.ApproverType in (3,4,9,10,11,16) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnp_client_contact WHERE CID=a.CID and RID = a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_ess_consultant_leave_approve a 
                  where  ApproverType in (1,14,17) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnpsm_customer_user WHERE CustomerID=a.CID and RID=a.ApproverID ) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_ess_consultant_leave_approve a 
                  where  ApproverType in (2,5,6,7,8,12,13,15,18) AND a.ConsultantID=iConsultantID
				  ) 
                  select group_concat(distinct if (ac.MailCC ='', null, ac.MailCC )) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_ess_consultant_leave a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND a.RID=iRID  AND a.ConsultantID=iConsultantID;
                  
                  -- Table 5 Mail Details
                  
                   select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType = 1 then 1 else 2 end) as ApproverType, a.ApproverID,
					ifnull(es.LogoPath, "") as LogoPath ,  IFNULL(es.EMailID,"") as FromEMail , c.CustomerTitle  as CustomerName , IFNULL(c.CustomerShortName, "") as CustomerSName,  	 
				    ifnull(es.LogoName, "") as LogoName , ifnull(es.LogoPath, "") as LogoUrl, 
					FN_GET_SMS_PROVIDER_KEY(c.RID) as `SMSDTLRegName`, 
					FN_GET_SMS_PROVIDER_SHT_KEY(c.RID) as `SMSDTLShtRegName`, 
					l.LeaveNotes AS LeaveNotes,
			    	-- to get approver Name
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
					-- to get approver Email
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1) as ToEMail,  
					-- to get approver Mobile
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,2) as MobileNo,
						
					TRIM(Replace(concat((CASE i.Salutation When 0 Then "Mr." When 1 then "Ms." When 2 then "Dr." when 3 then "Prof." when 4 then "Mrs." Else "" END)
					, "" , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, i.EmployeeNo, 
					date_format(l.LeaveFrom, '%d-%b-%Y') as LeaveFrom,  date_format(l.LeaveTill, '%d-%b-%Y') as LeaveTill,
					(case when l.LeaveID > 0 then (select DisplayName from ebnpm_leave where rid = l.LeaveID and CID = l.CID) when l.LeaveID = -1 then "LOP" WHEN l.LeaveID = -5 THEN "Comp Off" end) as LeaveName,
					 (case l.IsHalfDay when 1 then "Half Day" else "Full Day" end ) as `Day`, 
					l.NoofDays, 	
					to_base64(l.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(l.RID) as LevReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64, 
					c.ESSURL as ESSURLLink,  
					
					IFNULL((SELECT RID FROM ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ORDER BY RID DESC LIMIT 1 ),0) AS WhatsAppTempID,
					ifnull((SELECT TotaVar FROM ebnp_whatsapp_template WHERE CID = l.CID AND RID 
						in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ) ),0) as TotaVar,
					ifnull((SELECT (case LangCode when 0 then "en" else "hi" end) FROM ebnp_whatsapp_template WHERE CID = l.CID AND RID 
						in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ) ),0) as LanguageCode
					
					
					from ebnp_ess_consultant_leave l
					LEFT join ebnp_ess_consultant_leave_approve a on l.CID = a.CID AND l.RID = a.LeaveRequestID AND a.ApproveStatus=0
					join ebnp_cand_personal_info i on i.CID = a.CID AND i.RID = l.ConsultantID
					join ebnpsm_customer c on c.RID = l.CID
                    LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
					where l.CID = iCID AND l.RID = iRID;
                    
				  -- TABLE 6 FOR MAILBODY AND MAILSUBJECT
                  WITH mail_tempaltes AS (SELECT t.RID, t.CID, t.MailCC,t.MailBCC,t.MailSubject,MailBody,FromEmailID 
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 86 ORDER BY t.RID DESC LIMIT 1)
                  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,IFNULL(mt.FromEMailID,es.EMailID) AS FromEMail,ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_ess_consultant_leave a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.RID=iRID ;
                  
                  -- TABLE 7
                    SELECT "" AS MailCC ,"" AS MailBCC;
                     
                    -- Table 8 Action Mailer
                   select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType = 1 then 1 else 2 end) as ApproverType, a.ApproverID,
					c.CustomerTitle  as CustomerName,
					IFNULL(c.CustomerShortName, "") as CustomerSName, 	 
				    ifnull(es.LogoName, "") as LogoName, 
				    ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
                    IFNULL(es.EMailID,"") as FromEMail,
					FN_GET_SMS_PROVIDER_KEY(c.RID) as `SMSDTLRegName`, 
					FN_GET_SMS_PROVIDER_SHT_KEY(c.RID) as `SMSDTLShtRegName`, 
					l.LeaveNotes AS LeaveNotes,	
					-- to get approver Name
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
					-- to get approver Email
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1) as ToEMail,  
					-- to get approver Mobile
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,2) as MobileNo,
						
					TRIM(Replace(concat((CASE i.Salutation When 0 Then "Mr." When 1 then "Ms." When 2 then "Dr." when 3 then "Prof." when 4 then "Mrs." Else "" END)
					, "" , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, i.EmployeeNo, 
					date_format(l.LeaveFrom, '%d-%b-%Y') as LeaveFrom,  date_format(l.LeaveTill, '%d-%b-%Y') as LeaveTill,
					(case when l.LeaveID > 0 then (select DisplayName from ebnpm_leave where rid = l.LeaveID and CID = l.CID) when l.LeaveID = -1 then "LOP" WHEN l.LeaveID = -5 THEN "Comp Off" end) as LeaveName,
					 (case l.IsHalfDay when 1 then "Half Day" else "Full Day" end ) as `Day`, 
					l.NoofDays, 
					a.ApproverComments as LeaveRejectNotes, 
					to_base64(l.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(l.RID) as LevReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64, c.ESSURL as ESSURLLink,
					IFNULL((SELECT RID FROM ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ORDER BY RID DESC LIMIT 1 ),0) AS WhatsAppTempID,
					ifnull((SELECT TotaVar FROM ebnp_whatsapp_template WHERE CID = l.CID AND RID 
						in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ) ),0) as TotaVar,
					ifnull((SELECT (case LangCode when 0 then "en" else "hi" end) FROM ebnp_whatsapp_template WHERE CID = l.CID AND RID 
						in (select MAX(RID) from ebnpm_general_master WHERE CID = l.CID AND MasterType = 56 ) ),0) as LanguageCode
					
					
					from ebnp_ess_consultant_leave l
					LEFT join ebnp_ess_consultant_leave_approve a on l.CID = a.CID AND l.RID = a.LeaveRequestID AND a.ApproveStatus=0
					join ebnp_cand_personal_info i on i.CID = a.CID AND i.RID = l.ConsultantID
					join ebnpsm_customer c on c.RID = l.CID
                    LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
					where l.CID = iCID AND l.RID = iRID ;
				
			
END $$ 
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_ESS_GET_OFFER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_ESS_GET_OFFER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iConsultantID BIGINT  
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID ,iOfferLetterID, iApproverID BIGINT ;
    DECLARE iApproverType TINYINT ;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0) ,
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    SELECT OfferLetterID, ReqConsID, ApproverType, ApproverID INTO iOfferLetterID, iReqConsID, iApproverType , iApproverID
						FROM ebnp_offer_approval WHERE RID = iRID AND CID = iCID LIMIT 1;  
	
	SET tQRY = CONCAT(' SELECT a.RID as RID,   						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat((case i.Salutation when 0 then "Mr." when 1 then "Ms." when 2 then "Dr." when 3 then "Prof." when 4 then "Mrs." end), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.ConsultantID ,   a.OfferLetterID as OfferRequestID, 		
						a.OfferStatus as Status, (CASE a.OfferStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.OfferRemark, "") as Remarks, 
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,     
                            IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),"") AS WorkingLocation,
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as OfferedDesignation,
							
							"" as HikePercent, 
							"" as MarkUpPercent, 							
							');
	ELSE 
		SET tQRY = CONCAT(tQRY,' 										
						r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
						(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
                        0 as ContactID,r.ClientID as ClientID,
                        ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
                        IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=r.OfferedLocationID),"") AS WorkingLocation,
                        r.BranchID,
                        IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
                        ifnull(cc.ContractNo ,"") as ContractNo,
						ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
						ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
						IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
						rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
						ifnull(rq.JobDescription ,"") as JobDescription, 
						CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
						CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
						ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
						as BillRateRange ,
						ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
						where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
						IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
						r.OfferedDesignationID, 
						IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
						r.ExpectedDOJ as ExpectedDOJ, 
					
						CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC,
						
						IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
						/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
									  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
									  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/ 
						IFNULL(',dPercentageHike,',0.00) AS HikePercent,
						IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
						IFNULL(',dBillRate,' ),0.00) as BillRate,
						"" as MarkUpPercent,
	
						IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,
                        
                        ');    
     END IF;
    
	SET tQRY=CONCAT(tQRY,' a.ApproverID as ApproverID,
                           FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverUser 

						FROM ebnp_offer_approval a 
						JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID 
                        
						');
                        
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');                        
	ELSE 
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
                            ');
	 END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.RID = ',iRID,'  '); 							 
	
    IF iReqConsID = 0 THEN
		IF iApproverType IN (1,14,17) THEN
			SET tQRY=CONCAT(tQRY,' AND a.ApproverType IN (1,14,17) AND a.ApproverID = ',iApproverID,'	');
		ELSEIF iApproverType IN (3,4,9,10,11,16) THEN
			SET tQRY=CONCAT(tQRY,' AND a.ApproverType IN (3,4,9,10,11,16) AND a.ApproverID = ',iConsultantID,'	');
		END IF;
	ELSE 
		IF iApproverType IN (1,14,17) THEN
			SET tQRY=CONCAT(tQRY,' AND a.ApproverType IN (1,14,17) AND a.ApproverID = ',iApproverID,'	');
		ELSEIF iApproverType IN (9,10,11,16) THEN
			SET tQRY=CONCAT(tQRY,' AND a.ApproverType IN (9,10,11,16) AND a.ApproverID = ',iConsultantID,'	');
		END IF;
     END IF;
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');  

	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
	EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;
DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_GET_CAND_OFFER_BILLRATE_DTLS`;
DELIMITER $$
CREATE PROCEDURE `SP_GET_CAND_OFFER_BILLRATE_DTLS`(
iCID BIGINT,
iReqConsID BIGINT,
iConsultantID BIGINT,
iUserID BIGINT
)
BEGIN 

	IF NOT EXISTS (SELECT a.RID FROM ebnp_req_resumes_extend a WHERE a.CID = iCID AND a.ConsultantID = iConsultantID ) THEN -- AND a.ReqResumeID = iReqConsID
		INSERT INTO ebnp_req_resumes_extend(CID,ReqResumeID,ConsultantID,BillRateCurrencyID,BillRate,BillRateFrequencyID,CreatedUserID)
							SELECT sb.CID, sb.ReqConsID, sb.ConsultantID, sb.CurrencyID, sb.BillRate, sb.FrequencyID, iUserID
                            FROM ebnp_cand_staffing_bill_rate sb WHERE sb.CID = iCID  AND sb.ConsultantID = iConsultantID and sb.Status = 0 order by sb.rid desc limit 1; -- AND sb.ReqConsID = iReqConsID
    END IF;
    
    SELECT a.RID ,a.CID,a.ReqResumeID AS ReqConsID,a.ConsultantID,
		   a.BillRateCurrencyID, IFNULL(a.BillRate,0.00) as BillRate, a.BillRateFrequencyID
    FROM
    ebnp_req_resumes_extend a
    WHERE a.CID= iCID  AND a.ConsultantID = iConsultantID order by a.RID desc limit 1; -- AND a.ReqResumeID = iReqConsID
    
END $$
DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_GET_CLIENT_CONTRACT_REIMBURSEMENT_SALARY_LIST`;

DELIMITER ;;
CREATE PROCEDURE `SP_GET_CLIENT_CONTRACT_REIMBURSEMENT_SALARY_LIST`(
iContractID bigint, 
iCID bigint, 
iUserID bigint, 
iLanguageType smallint,  
tSearchKey Text)
BEGIN
	DECLARE tQry TEXT DEFAULT 0;
	Set tQry = CONCAT('Select c.RID, c.CID, 
						c.ClientID, IFNULL((Select ClientName From ebnp_clients Where RID = c.ClientID), "") as ClientName, 
						c.ContractID, cc.ContractCode, cc.ContractNo, 
						c.SalaryHeaderID, d.HeaderTitle as SalaryHeaderTitle, 
						e.RID as SalaryGroupHeaderID, e.Title as SalaryGroupHeaderTitle,
						c.MarkUp, c.RatePerUnit, c.IsProofMandatory,  
						c.ApplicableForPF as AppForPF, (CASE c.ApplicableForPF When 0 Then "NA" When 1 Then "Yes" When 2 Then "No" ELSE "" END) as StrAppForPF, 
						c.ApplicableForESI as AppForESI, (CASE c.ApplicableForESI When 0 Then "NA" When 1 Then "Yes" When 2 Then "No" ELSE "" END) as StrAppForESI, 
						c.ApplicableForLWF as AppForLWF, (CASE c.ApplicableForLWF When 0 Then "NA" When 1 Then "Yes" When 2 Then "No" ELSE "" END) as StrAppForLWF, 
						c.CreatedDate, c.CreatedUserID, IFNULL((Select FullName From ebnpsm_customer_user Where RID = c.CreatedUserID), "") as CreatedUser, 
						c.ModifiedDate, c.ModifiedUserID, IFNULL((Select FullName From ebnpsm_customer_user Where RID = c.ModifiedUserID), "") as ModifiedUser  ,
                        c.AllowToRaiseClaimInESS, c.ConsiderMinExemption, c.ConsiderMinExemptionRate, c.SlabIsRatePerUnit,
                        c.LimitType,(CASE c.LimitType WHEN 1 THEN "Per Month" WHEN 0 THEN "Per Entry" ELSE "" END) AS StrLimitType,
                        c.MaxLimit
                        
						From ebnp_client_contracts_salary_headers c 
						JOIN ebnp_client_contracts cc ON cc.RID = c.ContractID 
						JOIN ebnpm_salary_header d ON d.RID = c.SalaryHeaderID 
						JOIN ebnpm_salary_header_group e ON e.RID = d.HeaderGroupID 
						Where c.ContractID = ', iContractID, ' and c.CID = ', iCID);
    
    IF IFNULL(tSearchKey, '') != '' THEN
		Set tQry = CONCAT(tQry, ' (d.HeaderTitle LIKE "', tSearchKey, '%" OR d.DisplayName Like "', tSearchKey, '%" ) ');    
    END IF;
    
    Set @tQry = CONCAT(tQry, ' ORDER BY d.HeaderTitle');
    
    PREPARE qry From @tQry;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
 
    Set tQry = CONCAT('Select m.RID,m.ConSalHeaderID, c.CID,   m.ValueFrom,m.ValueTill,m.RatePerUnit 
						From ebnp_client_contracts_reimbur_units m
                        JOIN ebnp_client_contracts_salary_headers c on c.RID=m.ConSalHeaderID
						JOIN ebnp_client_contracts cc ON cc.RID = c.ContractID 
						JOIN ebnpm_salary_header d ON d.RID = c.SalaryHeaderID 
						JOIN ebnpm_salary_header_group e ON e.RID = d.HeaderGroupID 
						Where c.ContractID = ', iContractID, ' and c.CID = ', iCID);
    
    IF IFNULL(tSearchKey, '') != '' THEN
		Set tQry = CONCAT(tQry, ' (d.HeaderTitle LIKE "', tSearchKey, '%" OR d.DisplayName Like "', tSearchKey, '%" ) ');    
    END IF;
    
    Set @tQry = CONCAT(tQry, ' ORDER BY d.HeaderTitle');
    
    PREPARE qry From @tQry;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
END ;;

DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_GET_CONTRACT_CLIENT_OT_DETAILS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_CONTRACT_CLIENT_OT_DETAILS`(
iCID bigint,
iContractID bigint
)
BEGIN
	select c.RID, c.CID, c.ContractID, c.OTType,
    (case c.OTType when 0 then "Percentage" when 1 then "Per Hour Rate" else "" end) as StrOTType,
    c.WorkOTRate, c.WOOTRate, c.HOTRate, c.OHOTRate, 
    c.CreatedUserID, IFNULL((Select FullName From ebnpsm_customer_user Where RID = c.CreatedUserID), "") as CreatedUser, 
    c.CreatedDate,
    c.ModifiedUserID, IFNULL((Select FullName From ebnpsm_customer_user Where RID = c.ModifiedUserID), "") as ModifiedUser, 
    c.ModifiedDate 
	from ebnp_client_contract_ot_details c 
	where c.CID = iCID and c.ContractID = iContractID 
    ORDER BY c.OTType ;
    
END ;;

DELIMITER ;
-- ==================================================
-- Method reference
-- GetCPHRLetterApprovalDtls -> Client   
-- =================================================== 
DROP PROCEDURE IF EXISTS `SP_GET_CP_HR_LETTER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_CP_HR_LETTER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iUserID BIGINT  
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID BIGINT default 0;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0) ,
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    
    SELECT ReqConsID  INTO iReqConsID FROM ebnp_hr_letter_approval WHERE RID = iRID AND CID = iCID LIMIT 1;
	
	SET tQRY = CONCAT(' SELECT a.RID as RID,  a.CID, a.ConsultantID, a.ReqConsID, a.StaffingID,  						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.LetterStatus as Status, (CASE a.LetterStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.LetterRemark, "") as Remarks, a.LetterType,
                        (case a.LetterType when 0 then "Offer Letter" when 1 then "Appointment Letter" when 2 then "HR Letter" ELSE "" end) as StrLetterType,
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,                        
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,

							"" as HikePercent, 
							"" as MarkUpPercent, 
							
							');
	ELSE 
		SET tQRY = CONCAT(tQRY,' 										
							r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
							(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
							0 as ContactID,r.ClientID as ClientID,
							ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
							r.BranchID,
							IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
							ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
							ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
							IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
							rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
							ifnull(rq.JobDescription ,"") as JobDescription, 
							CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
							CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
							as BillRateRange ,
							ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
							where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
							IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
							r.OfferedDesignationID, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
							r.ExpectedDOJ as ExpectedDOJ, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

							CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC,
							
							IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
							/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/
                             IFNULL(',dPercentageHike,',0.00) AS HikePercent,
							 IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
							 IFNULL(',dBillRate,' ),0.00) as BillRate,            
							
							"" as MarkUpPercent, 
						
                        ');    
    END IF;
    
	SET tQRY=CONCAT(tQRY,'
                        FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverUser , a.HRLetterID,
						IFNULL(hd.LetterNo, "") as LetterNo, hd.DocumentName, IFNULL(hd.DocumentDetails, "") as DocumentDetails, 
						IFNULL(hd.DocumentPath, "") as Document, hd.RID as DocumentRID, hd.TemplateID,
						
                        -- 2- dig, 3- Esign
                        ifnull((Select (case when isnull(ds.RID) = false and isnull(es.RID) = false THEN 3 when isnull(ds.RID) = false then 1 when isnull(es.RID) = false then 2 else 0 end)
						FROM ebnp_cand_hr_documents hrd
                        JOIN ebnpm_templates t ON t.CID = hrd.CID AND t.RID = hrd.TemplateID
						LEFT JOIN ebnpm_templates_digital_signature ds ON ds.CID = t.CID and ds.TemplateID = t.RID and ds.IsDeleted = 0 AND ds.SignatureType = 2 and ds.ApproverLevel = (select count(RID) FROM ebnp_hr_letter_approval WHERE CID = hrd.CID and HRLetterID = hrd.RID and status = 0)
						LEFT JOIN ebnpm_templates_digital_signature es ON es.CID = t.CID and es.TemplateID = t.RID and es.IsDeleted = 0 AND es.SignatureType = 3 and es.ApproverLevel = (select count(RID) FROM ebnp_hr_letter_approval WHERE CID = hrd.CID and HRLetterID = hrd.RID and status = 0)
						Where hrd.CID = hd.CID AND hrd.RID = hd.RID limit 1),0)   as SignType
                                    
		FROM ebnp_hr_letter_approval a 
		JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID  
		JOIN ebnp_cand_hr_documents hd ON hd.CID = a.CID AND hd.RID = a.HRLetterID
                                    ');	
                                    
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');
	ELSE 
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
                            ');
	 END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.RID = ',iRID,'  '); 
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');
    
	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;
DELIMITER ;

-- ==================================================
-- Method reference
-- BeGetESSHRLetterApprovalDtls -> ESS   
-- =================================================== 

DROP PROCEDURE IF EXISTS `SP_GET_ESS_HR_LETTER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_ESS_HR_LETTER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iUserID BIGINT  
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID BIGINT ;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0) ,
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    SELECT ReqConsID  INTO iReqConsID FROM ebnp_hr_letter_approval WHERE RID = iRID AND CID = iCID LIMIT 1;
	
	SET tQRY = CONCAT(' SELECT a.RID as RID,  a.CID, a.ConsultantID, a.ReqConsID, a.StaffingID,  						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.LetterStatus as Status, (CASE a.LetterStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.LetterRemark, "") as Remarks, a.LetterType,
                        (case a.LetterType when 0 then "Offer Letter" when 1 then "Appointment Letter" when 2 then "HR Letter" ELSE "" end) as StrLetterType,
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,    
                            IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),"") AS WorkingLocation,
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,

							"" as HikePercent, 
							"" as MarkUpPercent, 
							
							');
	ELSE 
		SET tQRY = CONCAT(tQRY,' 										
							r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
							(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
							0 as ContactID,r.ClientID as ClientID,
							ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
                            IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=r.OfferedLocationID),"") AS WorkingLocation,
							r.BranchID,
							IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
							ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
							ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
							IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
							rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
							ifnull(rq.JobDescription ,"") as JobDescription, 
							CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
							CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
							as BillRateRange ,
							ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
							where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
							IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
							r.OfferedDesignationID, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
							r.ExpectedDOJ as ExpectedDOJ, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

							CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC,
							
							IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
							/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/
							
                            IFNULL(',dPercentageHike,',0.00) AS HikePercent,
							IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
							IFNULL(',dBillRate,' ),0.00) as BillRate,      
							
							"" as MarkUpPercent, 
						
                        ');    
     END IF;
    
	SET tQRY=CONCAT(tQRY,'
                        IFNULL((case  
								WHEN ApproverType in (1,14) then 
									(select IFNULL(concat(FN_GET_SALUTATION_TEXT(c.Salutation), " ", c.FirstName, " ", c.LastName), "")
									as Fullname from ebnp_client_contact c where c.CID = a.CID AND c.RID = a.ApproverID)
								WHEN ApproverType in (2,5,6,7,8,12,13,15) then 
									(select IFNULL(u.FullName, "") AS Fullname from ebnpsm_customer_user u where u.CustomerID = a.CID AND u.RID = a.ApproverID) 
								WHEN ApproverType in (3,4,9,10,11,16) then 
									(select ifnull(replace(concat(FN_GET_SALUTATION_TEXT(pi.Salutation), " ", pi.FirstName, " ", pi.MiddleName, " ", pi.LastName ), "  ", " "), "") 
                                    from ebnp_cand_personal_info pi where pi.CID = a.CID AND pi.RID = a.ApproverID)
								ELSE 
									""	end),"") as ApproverUser , a.HRLetterID,
						IFNULL(hd.LetterNo, "") as LetterNo, hd.DocumentName, IFNULL(hd.DocumentDetails, "") as DocumentDetails, 
						IFNULL(hd.DocumentPath, "") as Document, hd.RID as DocumentRID, hd.TemplateID,
						
                        -- Candidate level E-sign only is available
                        ifnull((Select (case when isnull(es.RID) = false then 2 else 0 end)
						FROM ebnp_cand_hr_documents hrd
                        JOIN ebnpm_templates t ON t.CID = hrd.CID AND t.RID = hrd.TemplateID
						LEFT JOIN ebnpm_templates_digital_signature es ON es.CID = t.CID and es.TemplateID = t.RID and es.IsDeleted = 0 AND es.SignatureType = 4 and es.ApproverLevel = (select count(RID) FROM ebnp_hr_letter_approval WHERE CID = hrd.CID and HRLetterID = hrd.RID and status = 0)
						Where hrd.CID = hd.CID AND hrd.RID = hd.RID limit 1),0) as SignType
                                    
		FROM ebnp_hr_letter_approval a 
		JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID  
		JOIN ebnp_cand_hr_documents hd ON hd.CID = a.CID AND hd.RID = a.HRLetterID
                                    ');	
                                    
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');
	ELSE 
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
                            ');
	 END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.RID = ',iRID,'  '); 
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');
    
	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;

DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_GET_ESS_ONBOARD_REQUEST_DTLS`;
DELIMITER $$
CREATE PROCEDURE `SP_GET_ESS_ONBOARD_REQUEST_DTLS`( 
iCID bigint,
iRID BIGINT,
iRequestID BIGINT,
iUserID BIGINT
)
BEGIN	
    DECLARE tQry TEXT;
    DECLARE iReqConsID,iStaffingID BIGINT;
    DECLARE iApproverType TINYINT;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0),
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    SELECT IFNULL(ReqConsID,0),IFNULL(StaffingID,0) INTO iReqConsID,iStaffingID FROM ebnp_cand_onboarding_initiate_approve WHERE RID = iRequestID LIMIT 1;  
    select IFNULL(ApproverType,0) INTO iApproverType FROM ebnp_cand_onboarding_initiate_approve_details WHERE RequestID = iRequestID AND RID = iRID AND CID=iCID order by RID desc LIMIT 1;
    
   SET tQry=CONCAT(' SELECT d.RID as ApproveRID,d.RequestID as OnBoardRequestID,a.ConsultantID, a.StaffingID,a.ReqConsID,						
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(pi.Salutation)," ", pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " ") )  as ConsultantName,
						pi.EmployeeNo , 
                        IFNULL((CASE WHEN pi.OfficialEMailID != "" THEN pi.OfficialEMailID ELSE pi.EMailID END),"" ) as EMailID, pi.MobileNo as MobileNo , pi.DOB as DOB,                                
						d.ApproveStatus, IFNULL((CASE d.ApproveStatus WHEN 1 THEN "Request Initiated" WHEN 2 THEN "Approved" WHEN 3 THEN "Rejected" ELSE "" END),"") as StrStatus,
						
						IFNULL((SELECT FullName FROM ebnpsm_customer_user where RID = a.CreatedUserID and CustomerID = a.CID),"") AS InitiatedUser,
						a.CreatedDate as InitiatedDate  ,d.ApproverID as ApproveUserID,
                        ');  
                                
		IF iReqConsID = 0 THEN 
			SET tQRY = CONCAT(tQRY,' si.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
								"" AS Anchor,
								si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
								si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,  
                                IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),"") AS WorkingLocation,
								si.ContractID, si.RID AS StaffingID,
								ifnull((select TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(r.Salutation), " ", r.FirstName, " ", r.MiddleName, " ", r.LastName), "  ", " ") ) from ebnp_cand_personal_info r where r.RID = si.ReportingPerson1ID), "") as PrimaryReportingPerson,
								ifnull((select TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(r.Salutation), " ", r.FirstName, " ", r.MiddleName, " ", r.LastName), "  ", " ") ) from ebnp_cand_personal_info r where r.RID = si.ReportingPerson2ID), "") as SecondaryReportingPerson,
                                
                                ifnull((select TRIM(CONCAT(a.FirstName, " ", a.LastName)) from ebnp_client_contact a where a.RID = si.ContactID), "") as ContactName,
								ifnull(cc.ContractNo ,"") as ContractNo,
								ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
								hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
								IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,

								"" as HikePercent, 
								"" as MarkUpPercent ,
								
                                FN_GET_APPROVER_NAME_TEXT(d.ApproverID,d.ApproverType,0) as ApproverName   
                                
								');
		ELSE 
			SET tQRY = CONCAT(tQRY,' 	IFNULL(r.TicketNo,"") as TicketNo ,						
								r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
								(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
								0 as ContactID,r.ClientID as ClientID,
								ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
                                IFNULL((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=r.OfferedLocationID),"") AS WorkingLocation,
								r.BranchID,
								IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName,
								ifnull(cc.ContractNo ,"") as ContractNo,
								ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
								ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
								IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
								rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
								ifnull(rq.JobDescription ,"") as JobDescription, 
								CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
								CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
								ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
								as BillRateRange ,
								ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
								where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
								IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
								r.OfferedDesignationID, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
								r.ExpectedDOJ as ExpectedDOJ, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

								IFNULL(CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)),0.00) as PresentCTC,
								
								IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
								/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
											  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
											  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/
								
                                IFNULL(',dPercentageHike,',0.00) AS HikePercent,
								IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
								IFNULL(',dBillRate,' ),0.00) as BillRate,      
							
								
								"" as MarkUpPercent,
                                
                                FN_GET_APPROVER_NAME_TEXT(d.ApproverID,d.ApproverType,0) as ApproverName 
							
							');    
		 END IF;
        
        
		SET tQry=CONCAT(tQry, ' FROM ebnp_cand_onboarding_initiate_approve a 
								JOIN ebnp_cand_onboarding_initiate_approve_details d ON d.RequestID = a.RID AND d.CID=a.CID
								JOIN ebnp_cand_personal_info pi ON pi.RID = a.ConsultantID AND pi.CID = a.CID
								
                            ');
                            
		IF iReqConsID = 0   THEN                            
			SET tQRY=CONCAT(tQRY,'							
								LEFT JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID AND si.ConsultantID = a.ConsultantID                  						
								LEFT JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID			
                                JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = pi.RID AND hr.CID=pi.CID
								');
		ELSE
			SET tQRY=CONCAT(tQRY, '							
								LEFT JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID AND r.ConsultantID = a.ConsultantID                                   
								LEFT JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
								LEFT JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
								');
		 END IF;
                            
		SET tQry=CONCAT(tQry, ' 
							WHERE a.CID=',iCID,' and d.ApproveStatus = 1 AND d.RID = ',iRID,' AND d.RequestID = ',iRequestID,'
                            and d.ApproverID = ',iUserID,' and d.ApproverType = ',iApproverType,'
						'); 
    
    SET @tQry = tQry ;
    PREPARE qry FROM @tQry;
    EXECUTE qry;
    DEALLOCATE PREPARE qry;
    
END $$
DELIMITER ;

-- ==================================================
-- Method reference
-- GetHRLetterApprovalDtls -> Core   
-- =================================================== 

DROP PROCEDURE IF EXISTS `SP_GET_HR_LETTER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_HR_LETTER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iUserID BIGINT  
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID BIGINT ;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0),
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    SELECT ReqConsID  INTO iReqConsID FROM ebnp_hr_letter_approval WHERE RID = iRID AND CID = iCID LIMIT 1;
	
	SET tQRY = CONCAT(' SELECT a.RID as RID,  a.CID, a.ConsultantID, a.ReqConsID, a.StaffingID,  						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.LetterStatus as Status, (CASE a.LetterStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.LetterRemark, "") as Remarks, a.LetterType,
                        (case a.LetterType when 0 then "Offer Letter" when 1 then "Appointment Letter" when 2 then "HR Letter" ELSE "" end) as StrLetterType,
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,                        
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,

							"" as HikePercent, 
							"" as MarkUpPercent, 
							
							');
	ELSE 
		SET tQRY = CONCAT(tQRY,' 										
							r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
							(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
							0 as ContactID,r.ClientID as ClientID,
							ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
							r.BranchID,
							IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
							ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
							ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
							IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
							rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
							ifnull(rq.JobDescription ,"") as JobDescription, 
							CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
							CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
							as BillRateRange ,
							ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
							where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
							IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
							r.OfferedDesignationID, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
							r.ExpectedDOJ as ExpectedDOJ, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

							CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC,
							
							IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
							/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/ 
							 
                             IFNULL(',dPercentageHike,',0.00) AS HikePercent,
							 IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
							 IFNULL((',dBillRate,' ),0.00) as BillRate,   
                                
							"" as MarkUpPercent, 
						
                        ');    
    END IF;
    
	SET tQRY=CONCAT(tQRY,'
                        FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverUser , a.HRLetterID,
						IFNULL(hd.LetterNo, "") as LetterNo, hd.DocumentName, IFNULL(hd.DocumentDetails, "") as DocumentDetails, 
						IFNULL(hd.DocumentPath, "") as Document, hd.RID as DocumentRID, hd.TemplateID,
                                    
                        ifnull((Select (case when isnull(ds.RID) = false and isnull(es.RID) = false THEN 3 when isnull(ds.RID) = false then 1 when isnull(es.RID) = false then 2 else 0 end)
						FROM ebnp_cand_hr_documents hrd
                        JOIN ebnpm_templates t ON t.CID = hrd.CID AND t.RID = hrd.TemplateID
						LEFT JOIN ebnpm_templates_digital_signature ds ON ds.CID = t.CID and ds.TemplateID = t.RID and ds.IsDeleted = 0 AND ds.SignatureType = 0 and ds.ApproverLevel = (select count(RID) FROM ebnp_hr_letter_approval WHERE CID = hrd.CID and HRLetterID = hrd.RID and status = 0)
						LEFT JOIN ebnpm_templates_digital_signature es ON es.CID = t.CID and es.TemplateID = t.RID and es.IsDeleted = 0 AND es.SignatureType = 1 and es.ApproverLevel = (select count(RID) FROM ebnp_hr_letter_approval WHERE CID = hrd.CID and HRLetterID = hrd.RID and status = 0)
						Where hrd.CID = hd.CID AND hrd.RID = hd.RID limit 1),0)   as SignType
                                    
		FROM ebnp_hr_letter_approval a 
		JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID  
		JOIN ebnp_cand_hr_documents hd ON hd.CID = a.CID AND hd.RID = a.HRLetterID
                                    ');	
                                    
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');
	ELSE 
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
                            ');
	END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.RID = ',iRID,'  '); 
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');
    
	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;

DELIMITER ;

-- ==================================================
-- Method reference
-- BeGetInvoicePDFDocument -> CORE
-- BeGetInvoiceDetails -> CORE
-- BeGetMailTempDataMerge -> ClientPortal
-- =================================================== 
DROP PROCEDURE IF EXISTS `SP_GET_INVOICE_DETAILS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_INVOICE_DETAILS`(
iCID BIGINT,
iInvoiceID BIGINT,
iUserID BIGINT,
iInvoiceTemplateID BIGINT,
iLanguageType Tinyint)
BEGIN
	declare iOutgoingFromEMail,iInvoiceCatg, iIsDelete, iMandatoryEInv tinyint default 0; -- iUseUserEmlIDForMail
    DECLARE iBranchID BIGINT DEFAULT '0';
    DECLARE dInvoiceTaxAmount DECIMAL(16,2) DEFAULT '0.00';
    declare tSalaryHeaderIDs,tHQry,tHVQry, QRY,POItemRepQry, POItemColQry   longtext default '';
    
	select OutgoingFromEMail, MandatoryEInvoice into iOutgoingFromEMail, iMandatoryEInv FROM ebnpsm_customer_app_config Where CID = iCID;
	select IsDelete INTO iIsDelete FROM ebnp_invoice_details Where CID = iCID AND RID = iInvoiceID;
    
    SELECT IFNULL(BranchID,0),IFNULL(InvoiceTaxAmount,0.00) ,InvoiceCatg INTO iBranchID, dInvoiceTaxAmount,iInvoiceCatg  
								FROM ebnp_invoice_details WHERE RID = iInvoiceID AND CID= iCID AND IsDelete = iIsDelete LIMIT 1;
    
    IF iBranchID = NULL THEN  SET iBranchID = 0; END IF;
    IF dInvoiceTaxAmount = NULL THEN  SET dInvoiceTaxAmount = 0.00; END IF;    
    
	SET SESSION group_concat_max_len = 1000000;   
    
    set @row_nwageSplit := 0;
	
    -- Table 0 -Tag are replacing from table 0
       
	Select 
		ifnull(es.EMailShortName, "") as EMailShortName, 
         (case iOutgoingFromEMail 
          when 1  then IFNULL((Select FromEmailID From ebnpm_templates Where CID=iCID AND RID = iInvoiceTemplateID), "")         
		  when 2  then IFNULL((Select EMailID From ebnpsm_customer_user Where RID = iUserID), "")
			else ifnull(es.EMailID, cu.EMailID) 
			end ) as FromEMail , 
                ifnull(es.LogoName, "") as LogoName, 
                ifnull(es.LogoPath, "") as LogoUrl,
                ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText,
                cu.CustomerTitle  as CustomerName,
    IFNULL((Select GROUP_CONCAT(EMailID SEPARATOR ';') From ebnp_client_contact Where CID=i.CID and ClientID = c.RID AND ContactType in (3,0)), "") as ToEmail, 
	IFNULL((Select GROUP_CONCAT(Mobile SEPARATOR ';') From ebnp_client_contact Where  CID=i.CID and ClientID = c.RID AND ContactType in (3,0)), "") as ToMobileNo, 
	ifnull((Select DocumentPath From ebnp_central_documents WHere CID = i.CID AND DocumentType = 58 AND IsDeleted = 0 and RefID = i.CostCenterID ORDER BY RID DESC limit 1),cu.CustLogoURL) as LogoPath,
	ifnull((Select Count(RID) From ebnp_central_documents WHere CID = i.CID AND DocumentType = 83 AND IsDeleted = 0 and RefID = iInvoiceID),0) as SavedInvoiceDocumentCount,
    i.RID as InvoiceID, i.CID, i.CostCenterID, 
    IFNULL((Select 
			GROUP_CONCAT(CONCAT(FN_GET_SALUTATION_TEXT(ecc.Salutation), " ", IFNULL(ecc.FirstName, "") )) 
			From ebnp_client_contact ecc Where ecc.CID =i.CID and ecc.ClientID = c.RID AND ecc.ContactType in (3,0)), "") as ContactName, 
	IFNULL((Select 
				(CASE WHEN IFNULL(LegalName, "") = "" THEN CostCenterName 
							ELSE ifnull(LegalName, CostCenterName) END) 
							From ebnpsm_customer_cc Where CustomerID=i.CID and RID = i.CostCenterID), "") as CostCenterName,
	i.InvoiceFromAddress, i.InvoiceFromStateID, IFNULL(fs.StateTitle, "") as InvoiceFromState, IFNULL(fs.StateCode, "") as InvoiceFromStateCode, 
	i.FromGSTNo, i.FromPANNo, i.ClientID, i.BranchID,  IFNULL(c.ClientName, "") as ClientName, IFNULL(c.ClientShortName, "") as ShortName, 
	
	IFNULL((Select 
				(CASE WHEN IFNULL(LegalName, "") = "" THEN BranchName 
							ELSE ifnull(LegalName, BranchName) 
							END) From ebnp_client_branchs Where CID =i.CID and RID = i.BranchID), "") as BranchName,  
	i.InvoiceToAddress, IFNULL(ts.StateTitle, "") as InvoiceToState, IFNULL(ts.StateCode, "") as InvoiceToStateCode, i.ToGSTNo, i.ToPANNo, i.InvoiceToStateID, 
	
    (CASE WHEN IFNULL(i.ShipToAddress,"")="" THEN IFNULL(i.InvoiceToAddress,"") ELSE IFNULL(i.ShipToAddress,"") END ) AS ShipToAddress, 
    (CASE WHEN IFNULL(shipto.StateTitle, "") = "" THEN IFNULL(ts.StateTitle, "") ELSE IFNULL(shipto.StateTitle, "") END ) as ShipToState, 
    (CASE WHEN IFNULL(shipto.StateCode, "") = "" THEN IFNULL(ts.StateCode, "") ELSE IFNULL(shipto.StateCode, "") END ) as ShipToStateCode, 
    (CASE WHEN ifnull(i.ShipToGSTNo,"") = "" THEN i.ToGSTNo ELSE ifnull(i.ShipToGSTNo,"") END) as ShipToGSTNo ,  
    (CASE WHEN IFNULL(i.ShipToStateID,0) = 0 THEN i.InvoiceToStateID ELSE IFNULL(i.ShipToStateID,0) END) AS ShipToStateID, 
    
	i.ParentInvoiceID, 
	IFNULL(i.ReferenceNumber,'') as ReferenceNumber , 
    IFNULL(p.InvoiceNumber, "") as ParentInvoiceNumber, p.InvoiceDate as ParentInvoiceDate,
    DATE_FORMAT(p.InvoiceDate, "%d-%b-%Y") as ParentInvoiceDateFormat,
    i.InvoiceNumber, i.InvoiceDate, DATE_FORMAT(i.InvoiceDate, "%d-%b-%Y") as InvoiceDateFormat,
    IFNULL(i.OldInvoiceNumber, "") as OldInvoiceNumber, 
    IFNULL(i.OldInvoiceNumber, "") as ReferenceNumber, 
	i.InvoiceType, (CASE i.InvoiceType When 0 THEN "Invoice" When 1 Then "Credit Note" When 2 Then "Debit Note" When 3 Then "Misc. Invoice" Else "" END) as StrInvoiceType, 
	i.InvoiceCatg, (CASE i.InvoiceCatg When 0 THEN "Staffing Invoice" When 1 Then "Reimburse Invoice" When 2 Then "Misc. Invoice" When 3 Then "Credit Note" When 4 Then "Debit Note" When 5 Then "Sourcing Invoice" When 6 Then "Absorption Invoice" When 7 Then "Rate Card Billing" Else "" END) as StrInvoiceCatg, 
	i.InvoiceStatus, (CASE i.InvoiceStatus When 0 THEN  
		(CASE 
			WHEN (i.InvoiceTotalAmount - i.CollectedAmount - i.CreditNoteAmount) <= 0 THEN "Payment Collected"
            WHEN (i.InvoiceTotalAmount - i.CollectedAmount - i.CreditNoteAmount) > 0.5 THEN "Payment Outstanding"
            ELSE "Active" 
		END) 
    When 1 Then "Cancelled" Else "" END) as StrInvoiceStatus, 
	coalesce(dp.InvoiceBillAmount, d.InvoiceBillAmount, 0) as InvoiceBillAmount, 
    coalesce(dp.InvoiceTaxAmount, d.InvoiceTaxAmount, 0) as InvoiceTaxAmount, 
    (coalesce(dp.InvoiceTotalAmount, d.InvoiceTotalAmount, 0)+i.InvoiceRoundOff) as InvoiceTotalAmount, 
    i.CollectedAmount, i.CreditNoteAmount, (i.InvoiceTotalAmount - i.CollectedAmount - i.CreditNoteAmount) as OutstandingAmount,
    
    i.SyncStatus as SyncStatus,
    (CASE i.SyncStatus WHEN 0 THEN "Not Yet Initiated" WHEN 1 THEN "Initiated" WHEN 2 THEN "Success" WHEN 3 THEN "Failure" ELSE "" END) AS SyncStatusStr,
    concat(ifnull(i.SyncComments,""),case when ifnull(i.SyncJVComments,"") !="" then concat("Journal Voucher Commens: ",i.SyncJVComments) else "" end  ) as SyncComments,
    i.SyncInitiatedUserID,
	IFNULL((Select u.FullName From ebnpsm_customer_user u Where u.CustomerID = i.CID AND u.RID = i.SyncInitiatedUserID), "") AS SycInitiatedUser,
    i.SyncInitiatedDate,
    
	i.CreatedUserID, IFNULL((Select u.FullName From ebnpsm_customer_user u Where u.CustomerID = i.CID AND u.RID = i.CreatedUserID), "") as CreatedUser, i.CreatedDate,
	i.ModifiedUserID, IFNULL((Select u.FullName From ebnpsm_customer_user u Where u.CustomerID = i.CID AND u.RID = i.ModifiedUserID), "") as ModifiedUser, i.ModifiedDate, 
	
    (CASE WHEN iInvoiceTemplateID = 0 THEN 
    COALESCE(i.InvoiceTemplateID, (Select (CASE WHEN d.LineType = 0 THEN PRLInvoiceTemplateID WHEN d.LineType = 1 THEN RIMInvoiceTemplateID ELSE NULL END) 
									FROM ebnpm_invoice_group_template WHERE CID = i.CId and RID = bi.InvGroupTemplateID), 
		IFNULL((SELECT t.RID FROM ebnpm_templates t WHERE t.CID = c.CID AND t.Type = 19 AND t.Status = 0 AND 
		(t.IsPrivate = 0 OR (t.IsPrivate = 1 AND t.CreatedUserID = iUserID) ) ORDER BY t.RID DESC LIMIT 1), "0"))
        ELSE iInvoiceTemplateID END) as InvoiceTemplateID, 
	
    IFNULL((Select Count(RID) From ebnp_central_documents WHere CID = i.CID AND DocumentType = 17 AND IsDeleted = 0 and RefID = i.RID), 0) as AttachmentCnt, 
    IFNULL(d.LineCnt, dp.LineCnt) as LineCnt, 
    IFNULL(dp.InvoiceTax1Amount, d.InvoiceTax1Amount) as InvoiceTax1Amount, 
    IFNULL(dp.InvoiceTax2Amount, d.InvoiceTax2Amount) as InvoiceTax2Amount, 
    IFNULL(dp.InvoiceTax3Amount, d.InvoiceTax3Amount) as InvoiceTax3Amount, 
    
	DATE_FORMAT(COALESCE(prl.MonthYear, rim.MonthYear,rcB.MonthYear, i.InvoiceDate), "%b-%Y") as TransMonthYr, 
        
    (CASE WHEN coalesce(dp.InvoiceTax1Amount, d.InvoiceTax1Amount, 0) > 0 and coalesce(dp.InvoiceTax2Amount, d.InvoiceTax2Amount, 0) > 0 THEN coalesce(dp.InvoiceTax1Amount, d.InvoiceTax1Amount, 0) ELSE 0.00 END) as CGSTAmount, 
	(CASE WHEN coalesce(dp.InvoiceTax1Amount, d.InvoiceTax1Amount, 0) > 0 and coalesce(dp.InvoiceTax2Amount, d.InvoiceTax2Amount, 0) > 0 THEN coalesce(dp.InvoiceTax2Amount, d.InvoiceTax2Amount, 0) ELSE 0.00 END) as SGSTAmount, 
	(CASE WHEN coalesce(dp.InvoiceTax1Amount, d.InvoiceTax1Amount, 0) > 0 and coalesce(dp.InvoiceTax2Amount, d.InvoiceTax2Amount, 0) = 0 THEN coalesce(dp.InvoiceTax1Amount, d.InvoiceTax1Amount, 0) ELSE 0.00 END) as IGSTAmount, 
    
    c.ClientAddress, c.GSTNo as ClientGSTNo, c.PANNo as ClientPANNo, 
    
	DATE_FORMAT(COALESCE(prl.MonthYear, rim.MonthYear,rcB.MonthYear, i.InvoiceDate), "%b-%Y") as MonthYear, 
    COALESCE(prl.ChargableAmount, rim.ChargableAmount, 0.00) as ChargableAmount, 
    COALESCE(prl.Markup, rim.Markup, 0.00) as Markup, 
    COALESCE(prl.MarkUpRate, rim.MarkUpRate, '') as MarkUpRate, 
    IFNULL(prl.PayPeriod, 0) as PayPeriod, 
    IFNULL(dp.Narration, '') as Narration, 
    
    IFNULL(lt.CertificateNo, '') as LTDSCertificateNo, IFNULL(lt.TDSRate, 0) as LTDSRate, 
    DATE_FORMAT(lt.ValidityFrom, "%d-%b-%y") as LTDSValidityFrom, 
    
    IFNULL((Select ContractNo FROM ebnp_client_contracts WHERE CID = i.CID AND RID = COALESCE(prl.ContractID, rim.ContractID, 0)), "") as ContractNo 
	, FN_GET_CUSTOMER_DEPOSIT_ACCOUNT_DETAILS(i.ClientID,i.BranchID,i.CID,0) as `DepositBankName`
    , FN_GET_CUSTOMER_DEPOSIT_ACCOUNT_DETAILS(i.ClientID,i.BranchID,i.CID,1) as `DepositBankAccountNo`
    , FN_GET_CUSTOMER_DEPOSIT_ACCOUNT_DETAILS(i.ClientID,i.BranchID,i.CID,2) as `DepositBankAddress`
    , FN_GET_CUSTOMER_DEPOSIT_ACCOUNT_DETAILS(i.ClientID,i.BranchID,i.CID,3) as `DepositBankIFSCCode`,   
   IFNULL((SELECT gm.Title from ebnp_invoice_outstanding_reason  osr 
												JOIN    ebnpm_general_master gm on gm.RID=osr.OutstandingReasonID and   gm.CID =osr.CID
												WHERE gm.MasterType=36 and osr.CID=iCID and osr.InvoiceID=i.RID order by osr.rid desc limit 1),"") as OutstandingReason ,
	
	i.InvoiceRoundOff,
	IFNULL(qr.IRNNo,"") AS IRNNo,
    IFNULL(qr.AcknowledgementNo,"") AS AcknowledgementNo, 
    IFNULL(qr.AcknowledgementDate,NULL) AS AcknowledgementDate,
	IFNULL(DATE_FORMAT(qr.AcknowledgementDate, "%d-%b-%Y %r"), NULL) AS AcknowledgementDateFormat,
    IFNULL(qr.DocumentPath,"") AS QRDocumentPath, "" as DocumentPath, 
    IFNULL(qr.DocumentName,"") AS QrDocName, 
	IFNULL(dp.ParticularNarration, "") as ParticularNarration, IFNULL(dp.ParticularQuantity, "") as ParticularQuantity, 
    IFNULL(dp.ParticularRate, "") as ParticularRate, IFNULL(dp.ParticularSACCode, "") as ParticularSACCode, 
    IFNULL(dp.ParticularBillAmount, "") as ParticularBillAmount, IFNULL(dp.ParticularTax, "") as ParticularTax, 
    IFNULL(dp.ParticularTax1Amount, "") as ParticularTax1Amount, IFNULL(dp.ParticularTax2Amount, "") as ParticularTax2Amount, 
    IFNULL(dp.ParticularTax3Amount, "") as ParticularTax3Amount, IFNULL(dp.ParticularTaxAmount, "") as ParticularTaxAmount, 
    IFNULL(dp.ParticularTotalAmount, "") as ParticularTotalAmount, 
    IFNULL(dp.SACDescription, "") as SACDescription, 
    IFNULL(dp.SBU, "") as SBU, 
    
	
    (CASE WHEN i.InvoiceTaxAmount != 0 THEN "" ELSE 
    IFNULL((Select lut.LUTDeclaration FROM ebnpsm_customer_cc_lut_details lut WHERE lut.CID=i.CID and lut.CostCenterID = i.CostCenterID 
		AND i.InvoiceDate BETWEEN IFNULL(lut.LUTDate, i.InvoiceDate) AND IFNULL(lut.LUTExpiryDate, i.InvoiceDate) 
        AND lut.Status = 0 and lut.IsDeleted = 0 ORDER BY IFNULL(lut.LUTDate, i.InvoiceDate) DESC LIMIT 1), "") 
    END) as LUTDeclaration, 
    
    IFNULL(lis.FolderID, 0) as FolderID, 
    "" as FolderPath,
	COALESCE(prl.PONo, rim.PONo,rcB.PONo, '') as PONo, 
	COALESCE(prl.PONarration, rim.PONarration, rcB.PONarration,'') as PONarration, 
	COALESCE(prl.INBNarration, rim.INBNarration,rcB.INBNarration,'') as INBNarration, 
	COALESCE(prl.INBNo, rim.INBNo,rcB.INBNo, '') as INBNo,
	COALESCE(prl.PODate, rim.PODate,rcB.PODate, '') as PODate, 
    COALESCE(prl.POIssueDate, rim.POIssueDate,rcB.POIssueDate, '') as POIssueDate, 
	ifnull( i.ApproveRemarks,"") as ApproveRemarks, i.ApproveStatus ,i.ApprovedUserID , i.ApprovedDate,IFNULL((Select u.FullName From ebnpsm_customer_user u Where u.CustomerID = i.CID AND u.RID = i.ApprovedUserID), "") as ApprovedUser,
    	i.PosteInvoice AS PosteInvoice,
        p.PosteInvoice  as ParentPosteInvoice,
	iMandatoryEInv as `MandatoryEInvoice`,
		
	-- ifnull(empdet.SlNo,'') as tblSlNo,
	-- ifnull(empdet.Location,'') as tblLocation,
	-- ifnull(empdet.Designation,'') as tblDesignation,
	ifnull(empdet.EmployeeNo,'') as tblEmployeeNo,
	-- ifnull(empdet.EmployeeName,'') as tblEmployeeName,     
	-- ifnull(empdet.ClientEmployeeNo,'') as tblClientEmployeeNo, 
	-- ifnull(empdet.DOJ,'') as tblDOJ,
	-- ifnull(empdet.LWD ,'') as tblLWD  ,
	-- ifnull(prl.CTCPM,  '') as tblCTCPM,
	-- ifnull(prl.MarginPM,  '') as tblMarginPM,
	-- ifnull(prl.LOP   ,'') as  tblLOP ,
	-- ifnull(coalesce(prl.BilliableDays,rcB.BilliableDays) ,'') as tblBilliableDays,
	-- ifnull(prl.NetCTC ,'') as tblNetCTC,
	-- ifnull(prl.MarginPM ,'') as tblNETMargin,
	-- ifnull(prl.BillAmount ,'') as tblFinalBilliableValue,
    COALESCE(prl.BillAmount, rim.BillAmount,rcB.BillAmount, '') as tblFinalBilliableValue,
    COALESCE(prl.MarginPM, rim.MarginPM,rcB.MarginPM, '') as tblNETMargin,
    COALESCE(prl.NetCTC, rim.NetCTC,rcB.NetCTC, '') as tblNetCTC,
    COALESCE(prl.BilliableDays, rim.BilliableDays,rcB.BilliableDays, '') as tblBilliableDays,
    COALESCE(prl.LOP, rim.LOP,rcB.LOP, '') as tblLOP,
    COALESCE(prl.MarginPM, rim.MarginPM,rcB.MarginPM, '') as tblMarginPM,
    COALESCE(prl.CTCPM, rim.CTCPM,rcB.CTCPM, '') as tblCTCPM,
    COALESCE(prl.LWD, rim.LWD,rcB.LWD,empdet.LWD, '') as tblLWD,
    COALESCE(prl.DOJ, rim.DOJ,rcB.DOJ,empdet.DOJ, '') as tblDOJ,
    COALESCE(prl.ClientEmployeeNo, rim.ClientEmployeeNo,rcB.ClientEmployeeNo,empdet.ClientEmployeeNo, '') as tblClientEmployeeNo,
    COALESCE(prl.EmployeeName, rim.EmployeeName,rcB.EmployeeName,empdet.EmployeeName, '') as tblEmployeeName,
    COALESCE(prl.Designation, rim.Designation,rcB.Designation,empdet.Designation, '') as tblDesignation,
    COALESCE(prl.Location, rim.Location,rcB.Location,empdet.Location, '') as tblLocation,
    
    COALESCE(prl.SlNo, rim.SlNo,rcB.SlNo,empdet.SlNo, '') as tblSlNo,
    
    IFNULL(rcB.BillRate,"") AS EmpBillRate,
      i.LineSubType , 
	ifnull(empdet.tblBillRate ,'') as tblBillRate  ,
	  case i.LineSubType when 0 then 'Primary' when 1 then 'Markup' when 2 then 'Header' end as StrLineSubType,
			ifnull(i.ShiptoName,i.BilltoName) as ShiptoName,
			ifnull(i.BilltoName,"") as BilltoName,
			ifnull(i.FromPINNo,"") as FromPINNo,
			ifnull(i.ToPINNo,"") as ToPINNo,
			ifnull(i.ShipToPINNo,i.ToPINNo) as ShipToPINNo,
            
		(CASE 
			when (i.InvGroupType in (3,13) or (i.InvGroupType =16 and iBranchID=0)) and ifnull(i.BilltoName,"")!="" then
				i.BilltoName
			when i.InvGroupType =12 and ifnull(i.BilltoName,"")!="" then
				i.BilltoName
			when (i.InvGroupType =16 and iBranchID>0) and ifnull(i.BilltoName,"")!="" then
				i.BilltoName
            WHEN iBranchID > 0 THEN (SELECT IFNULL(b.LegalName,"") FROM ebnp_client_branchs b WHERE b.RID = i.BranchID AND b.CID=iCID)
		ELSE IFNULL(c.ClientName,"") END) AS LegalName, 

		(CASE WHEN i.InvoiceTaxAmount != 0 THEN "" ELSE  IFNULL(ltn.LUTNo,"") end) AS LUTNo , 
		(CASE WHEN i.InvoiceTaxAmount != 0 THEN "" ELSE  DATE_FORMAT(ltn.LUTDate,"%d-%b-%Y") end ) AS LUTStartDate , 
		(CASE WHEN i.InvoiceTaxAmount != 0 THEN "" ELSE   DATE_FORMAT(ltn.LUTExpiryDate,"%d-%b-%Y") end ) AS LUTEndDate, 
		(CASE WHEN i.InvoiceTaxAmount != 0 THEN "" ELSE IFNULL(ltn.ARNNo,"") end) AS LUTARNNo,
		(CASE WHEN dInvoiceTaxAmount > 0.00 THEN "B2B" ELSE "SEZ" END) AS GSTType,
		
        COALESCE(date_format(prl.BillFrom,'%d-%b-%y'),date_format(rim.BillFrom,'%d-%b-%y'),date_format(rcB.BillFrom,'%d-%b-%y'),"") as BillFrom,
        COALESCE(date_format(prl.BillTo,'%d-%b-%y'),date_format(rim.BillTo,'%d-%b-%y'),date_format(rcB.BillTo,'%d-%b-%y'),"") as BillTo,
	   
		ifnull((Select (CASE tm.IsSEZ 
								WHEN 0 then IFNULL((Select (td.Tax1 + td.Tax2 + td.Tax3) FROM ebnpm_tax_details td WHERE td.Status = 0 AND td.TaxID = tm.RID),0) 
							Else 0 
						END) FROM ebnpm_tax_master tm 
				Where tm.CID = i.CID and tm.RID = dp.TaxID), 0) as `GSTRate`, 

       (CASE 
		WHEN i.InvGroupType =0 and i.InvGroupID>0 THEN  IFNULL((Select   ClientName  From ebnp_clients Where CID = i.CID AND RID = i.InvGroupID), "")
                            WHEN i.InvGroupType =1 THEN  IFNULL((Select   BranchName  From ebnp_client_branchs Where CID = i.CID AND RID = i.InvGroupID), "")
                            WHEN i.InvGroupType =2 THEN   IFNULL((Select ContractNo FROM ebnp_client_contracts WHERE CID = i.CID AND RID =  i.InvGroupID), "")
                           --  WHEN i.InvGroupType =3 THEN "PO No"
                            WHEN i.InvGroupType =4 THEN IFNULL((Select TRIM(CONCAT(FirstName, " ", LastName)) From ebnp_client_contact where CID = i.CID AND RID =  i.InvGroupID), "")
                            WHEN i.InvGroupType =5 THEN  IFNULL((Select FullName From ebnpsm_customer_user where customerid=iCID and RID = i.InvGroupID), "")
                            WHEN i.InvGroupType =6 and ifnull(i.InvGroupText,"")!="" and LOCATE('(', ifnull(i.InvGroupText,""))>1 THEN  SUBSTRING(ifnull(i.InvGroupText,""), 1,LOCATE('(', ifnull(i.InvGroupText,""))-1)
                           -- WHEN i.InvGroupType =7 THEN "Cost Center"
                          --   WHEN i.InvGroupType =8 THEN "Branch State"
                           -- WHEN i.InvGroupType =9 THEN "Working State"
                           -- WHEN i.InvGroupType =10 THEN "Working Venue"
                          --  WHEN i.InvGroupType =11 THEN "Zone"
                           -- WHEN i.InvGroupType =12 THEN "IBN No"
                           --  WHEN i.InvGroupType =13 THEN "PO & Employee Level"
                            WHEN i.InvGroupType =14 THEN ifnull((select ProjectTitle from ebnp_client_contract_project where CID=i.CID and RID=i.InvGroupID ),"")
                            ELSE  ifnull(i.InvGroupText,"")  END) as InvGroupName,
                            ifnull(i.InvGroupText,"") as InvGroupText
         ,ifnull(i.CancelReason,"") as CancelReason    
         ,ifnull((select Remarks from ebnp_invoice_e_invoice where InvoiceID=i.RID and CID=i.CID order by rid desc limit 1),"") as EPostSyncRemarks
	From ebnp_invoice_details i 
	JOIN ebnp_clients c ON c.RID = i.ClientID and c.CID  = i.CID
    join ebnpsm_customer cu on cu.RID = i.CID
    LEFT JOIN ebnp_invoice_qr as qr ON qr.InvoiceID = i.RID  and qr.CID = i.CID AND qr.IsDeleted = 0 
    LEFT JOIN ebnp_invoice_doc_checklist_link as lis ON  lis.CID = i.CID and lis.InvoiceID = i.RID 
	
	LEFT JOIN (Select Min(LineType) as LineType, Count(RID) as LineCnt, MAX(TaxID) as TaxID, 
		SUM(BillAmount) as InvoiceBillAmount,
		SUM(Tax1Amount) as InvoiceTax1Amount, SUM(Tax2Amount) as InvoiceTax2Amount, SUM(Tax3Amount) as InvoiceTax3Amount, SUM(TaxAmount) as InvoiceTaxAmount,
		SUM(TotalAmount) as InvoiceTotalAmount,
		InvoiceID From ebnp_invoice_line_details WHERE CID =iCID and InvoiceID = iInvoiceID AND IsDelete = iIsDelete
		GROUP BY InvoiceID) as d ON d.InvoiceID = i.RID 
        
	LEFT JOIN (Select Min(invp.ReferenceTypeID) as LineType, Count(invp.RID) as LineCnt, MAX(invp.TaxID) as TaxID, 
		GROUP_CONCAT(invp.Narration SEPARATOR '\n') as Narration, 
		SUM(invp.BillAmount) as InvoiceBillAmount,
		SUM(invp.Tax1Amount) as InvoiceTax1Amount, SUM(invp.Tax2Amount) as InvoiceTax2Amount, SUM(invp.Tax3Amount) as InvoiceTax3Amount, SUM(invp.TaxAmount) as InvoiceTaxAmount,
		SUM(invp.TotalAmount) as InvoiceTotalAmount,
		invp.InvoiceID, 
		GROUP_CONCAT(invp.Narration SEPARATOR '\n') as ParticularNarration, 
		GROUP_CONCAT(( case when invp.ReferenceTypeID=8   then ( case when invp.SalaryHeaderID>0 then (TRIM(Quantity) + 0)  else ifnull((select sum(p.BillPeriod) from 
		ebnp_cons_ts_advance_bill_invoice_dtls p  
		JOIN ebnp_invoice_line_details l ON l.RefID = p.RID  and l.CID=p.CID AND l.IsDelete = iIsDelete 
		WHERE l.LineType = 8 and l.InvoiceID = iInvoiceID AND p.CID = iCID and l.RID=invp.RefID),1) end) else  (TRIM(Quantity) + 0)  end ) SEPARATOR '\n') as ParticularQuantity, 
		GROUP_CONCAT(invp.Rate SEPARATOR '\n') as ParticularRate, 
		GROUP_CONCAT(invp.SACCode SEPARATOR '\n') as ParticularSACCode, 
		GROUP_CONCAT(invp.BillAmount SEPARATOR '\n') as ParticularBillAmount, 
		GROUP_CONCAT(IFNULL((Select TaxTitle FROM ebnpm_tax_master Where CID= invp.CID and RID = invp.TaxID), " ") SEPARATOR '\n') as ParticularTax, 
		GROUP_CONCAT(invp.Tax1Amount SEPARATOR '\n') as ParticularTax1Amount, 
		GROUP_CONCAT(invp.Tax2Amount SEPARATOR '\n') as ParticularTax2Amount, 
		GROUP_CONCAT(invp.Tax3Amount SEPARATOR '\n') as ParticularTax3Amount, 
		GROUP_CONCAT(invp.TaxAmount SEPARATOR '\n') as ParticularTaxAmount, 
		GROUP_CONCAT(invp.TotalAmount SEPARATOR '\n') as ParticularTotalAmount ,
		IFNULL((SELECT sc.SACDescription from ebnp_inv_type_sac_codes sc WHERE sc.SACCode=invp.SACCode AND sc.CID=invp.CID LIMIT 1 ),"") AS `SACDescription`,
        IFNULL((SELECT  GROUP_CONCAT(DISTINCT(c.ClientName)) FROM ebnp_clients c 
                                                                 JOIN ebnp_cand_staffing_info si ON si.CID=c.CID 
                                                                 JOIN ebnp_invoice_line_details ld ON ld.StaffingID=si.RID AND ld.CID=si.CID
																 WHERE c.CID = iCID AND c.RID = si.BUID AND ld.InvoiceID=iInvoiceID ),"") `SBU`
		From ebnp_invoice_details_particulars as invp WHERE invp.CID=iCID and  invp.InvoiceID = iInvoiceID AND invp.IsDelete = iIsDelete 
		GROUP BY invp.InvoiceID) as dp ON dp.InvoiceID = i.RID 
        
	LEFT JOIN (Select l.InvoiceID, group_concat( (@row_nwageSplit:=@row_nwageSplit + 1)  SEPARATOR '\n') as SlNo,
    MAX(p.MonthYear) as MonthYear, SUM(p.ChargableAmount) as ChargableAmount, SUM(p.Markup) as Markup, 
		SUM(p.PayPeriod) as PayPeriod, MAX(p.ContractID) as ContractID, 
		IFNULL((Select GROUP_CONCAT(DISTINCT r.MarkUpRate) From ebnp_cons_prl_log_markup r 
									JOIN ebnp_cons_prl_log l ON l.RID = r.PayrollLogID and l.CID = r.CID and l.IsDeleted = 0 
									JOIN ebnpm_po_item po ON po.RID = r.POLineItemID  and po.CID = r.CID and po.IsDeleted = 0 
									WHERE l.CID=iCID and l.PayrollID = p.RID and po.ItemType = 1), '') as MarkUpRate ,
					GROUP_CONCAT(distinct p.PONo) as PONo,
                   -- GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( distinct  concat(date_format(poi.POStartDate,'%d-%b-%y'),case when isnull(poi.POEndDate)=0 then concat('-',date_format(poi.POEndDate,'%d-%b-%y')) else '' end) ) From ebnp_client_contracts_po_items poi   where poi.PONo = p.PONo and poi.CID=p.CID  and poi.IsDeleted = 0 ),null ))  as PODate,
                    GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( distinct  concat(date_format(poi.POStartDate,'%d-%b-%y'),case when isnull(poi.POEndDate)=0 then concat('-',date_format(poi.POEndDate,'%d-%b-%y')) else '' end) ) 
													 From  ebnp_client_contracts_po_items poi
                                                     JOIN  ebnp_cons_prl_po_balance b  ON b.POID=poi.RID  and b.CID=poi.CID  and poi.IsDeleted = 0  
                                                     where b.IsDeleted =0 and b.CID = p.CID AND b.PayrollID = p.RID ),null ))  as PODate,
					GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( date_format(poi.POIssueDate,'%d-%b-%y') )
													 From  ebnp_client_contracts_po_items poi
                                                     JOIN  ebnp_cons_prl_po_balance b  ON b.POID=poi.RID  and b.CID=poi.CID  and poi.IsDeleted = 0  
                                                     where b.IsDeleted =0 and b.CID = p.CID AND b.PayrollID = p.RID ),null ))  as POIssueDate,
					GROUP_CONCAT(distinct (Select GROUP_CONCAT( DISTINCT po.InvoiceNarration)  FROM ebnp_cons_prl_po_balance b JOIN ebnp_client_contracts_po_items po ON po.RID = b.POID and po.CID=b.CID  and po.IsDeleted = 0 
									WHERE  b.IsDeleted =0 and b.CID = p.CID AND b.PayrollID = p.RID)) as PONarration,
					GROUP_CONCAT(distinct (Select GROUP_CONCAT( DISTINCT po.InvoiceNarration)  FROM ebnp_cons_prl_po_balance b JOIN ebnp_client_contracts_po_inb po ON po.RID = b.INBID and po.POID = b.POID and po.CID=b.CID  and po.IsDeleted = 0 
									WHERE  b.IsDeleted =0 and b.CID = p.CID AND b.PayrollID = p.RID)) as INBNarration,
                                    
					GROUP_CONCAT(distinct p.INBNo) as INBNo,
									
					GROUP_CONCAT(p.PerMonthTariff  SEPARATOR '\n' ) as CTCPM, 
					GROUP_CONCAT(p.Markup  SEPARATOR '\n' ) as MarginPM,  
					GROUP_CONCAT(p.LOP  SEPARATOR '\n' ) as LOP,  
					GROUP_CONCAT(p.BillPeriod  SEPARATOR '\n' ) as BilliableDays,  
					GROUP_CONCAT(p.ChargableAmount  SEPARATOR '\n' ) as NetCTC,  
					GROUP_CONCAT(p.BillAmount  SEPARATOR '\n' ) as BillAmount ,
                   Min(p.PendingFrom) as BillFrom,
                   Max(p.ProcessedTill) as BillTo  ,
                   group_concat(TRIM(REPLACE(CONCAT(pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " "))  SEPARATOR '\n') as EmployeeName,
                   group_concat( (
                case  when l.StaffingID>0 then ifnull((Select ClientEmployeeNo From   ebnp_cand_staffing_info r  
                where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  
                )
                SEPARATOR '\n') as ClientEmployeeNo,
                 group_concat(ifnull(DATE_FORMAT(hr.LWDUpdatedOn , "%d-%b-%y"),' ') SEPARATOR '\n') as LWD,
				group_concat(ifnull(DATE_FORMAT(hr.DOJ , "%d-%b-%y"),' ') SEPARATOR '\n') as DOJ,
                group_concat( (
					case when l.ReqConsID>0 then ifnull((Select m.Title From ebnpm_general_master m JOIN ebnp_req_resumes r on r.OfferedDesignationID=m.RID 
						where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
					when l.StaffingID>0 then ifnull((Select Title From ebnpm_general_master Where CID=iCID and RID = hr.DesignationID) ,' ') else ' ' end  
					)SEPARATOR '\n')as Designation,
				group_concat( (
					case when l.ReqConsID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_req_resumes r on r.OfferedLocationID=m.RID 
						where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
					when l.StaffingID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_cand_staffing_info r on r.WorkingLocationID=m.RID 
						where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  )SEPARATOR '\n')  as Location
                                                                
		From ebnp_consultant_payroll p 
		JOIN ebnp_invoice_line_details l ON l.CID =p.CID and l.PayrollID = p.RID AND l.IsDelete = iIsDelete 
         JOIN ebnp_cand_personal_info pi ON pi.RID = l.ConsultantID AND pi.CID = iCID 
        join ebnp_cand_hr_details hr on hr.ConsultantID = l.ConsultantID AND hr.CID = iCID 
		WHERE p.IsDeleted = 0 and l.LineType = 0 and l.InvoiceID = iInvoiceID AND p.CID = iCID 
        GROUP BY l.InvoiceID) as prl ON prl.InvoiceID = i.RID 
        
	-- Reimbursement 
	LEFT JOIN (Select l.InvoiceID, group_concat( (@row_nwageSplit:=@row_nwageSplit + 1)  SEPARATOR '\n') as SlNo,
    MAX(p.MonthYear) as MonthYear, SUM(p.Amount) as ChargableAmount, 
		SUM(p.TotalMarkUpAmount) as Markup, MAX(p.ContractID) as ContractID, 
		'' as MarkUpRate ,
        GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( distinct poi.PONo ) From ebnp_client_contracts_po_items poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.POID and poi.CID=rimi.CID  where rimi.CID=p.CID and  rimi.ProcessMonthID = p.RID and rimi.IsDeleted = 0  and poi.IsDeleted = 0   ),null ))  as PONo,
        GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( distinct  concat(date_format(poi.POStartDate,'%d-%b-%y'),case when isnull(poi.POEndDate)=0 then concat('-',date_format(poi.POEndDate,'%d-%b-%y')) else '' end) ) From ebnp_client_contracts_po_items poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.POID and poi.CID =rimi.CID  where rimi.ProcessMonthID = p.RID and rimi.IsDeleted = 0 and poi.IsDeleted = 0   ),null ))  as PODate,
        GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( date_format(poi.POIssueDate,'%d-%b-%y') ) From ebnp_client_contracts_po_items poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.POID and poi.CID =rimi.CID  where rimi.ProcessMonthID = p.RID and rimi.IsDeleted = 0 and poi.IsDeleted = 0   ),null ))  as `POIssueDate`,
        GROUP_CONCAT( distinct ifnull (  (select   GROUP_CONCAT(distinct poi.InvoiceNarration ) From ebnp_client_contracts_po_items poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.POID and poi.CID =rimi.CID  where rimi.CID=p.CID and  rimi.ProcessMonthID = p.RID and poi.IsDeleted = 0  ),null ))  as PONarration,
        GROUP_CONCAT( distinct ifnull (  (select   GROUP_CONCAT(distinct poi.INBNo ) From ebnp_client_contracts_po_inb poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.INBID and poi.CID =rimi.CID  where  rimi.CID=p.CID and rimi.ProcessMonthID = p.RID  and rimi.IsDeleted = 0  and  poi.IsDeleted = 0 ),null ))  as INBNo,
        GROUP_CONCAT( distinct ifnull (  (select   GROUP_CONCAT(distinct poi.InvoiceNarration) From ebnp_client_contracts_po_inb poi join ebnp_consultant_reimburse_item rimi on poi.RID = rimi.INBID and poi.CID =rimi.CID  where  rimi.CID=p.CID and rimi.ProcessMonthID = p.RID  and rimi.IsDeleted = 0  and  poi.IsDeleted = 0 ),null ))  as INBNarration,
		Min(p.MonthYear) as BillFrom,
        Max(p.MonthYear) as BillTo ,
        group_concat(TRIM(REPLACE(CONCAT(pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " "))  SEPARATOR '\n') as EmployeeName,
        group_concat( (
                case  when l.StaffingID>0 then ifnull((Select ClientEmployeeNo From   ebnp_cand_staffing_info r  
                where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  
                )
                SEPARATOR '\n') as ClientEmployeeNo,
                GROUP_CONCAT(p.BillAmount  SEPARATOR '\n' ) as BillAmount ,
                GROUP_CONCAT(p.TotalMarkUpAmount  SEPARATOR '\n' ) as MarginPM,
                GROUP_CONCAT(p.BillAmount  SEPARATOR '\n' ) as NetCTC,
                0 as BilliableDays,
                0 as LOP,
                GROUP_CONCAT(p.BillAmount  SEPARATOR '\n' ) as CTCPM,
                group_concat(ifnull(DATE_FORMAT(hr.LWDUpdatedOn , "%d-%b-%y"),' ') SEPARATOR '\n') as LWD,
				group_concat(ifnull(DATE_FORMAT(hr.DOJ , "%d-%b-%y"),' ') SEPARATOR '\n') as DOJ,
                group_concat( (
                case when l.ReqConsID>0 then ifnull((Select m.Title From ebnpm_general_master m JOIN ebnp_req_resumes r on r.OfferedDesignationID=m.RID 
                where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
                   when l.StaffingID>0 then ifnull((Select Title From ebnpm_general_master Where CID=iCID and RID = hr.DesignationID) ,' ') else ' ' end  
                )SEPARATOR '\n')as Designation,
                group_concat( (
					case when l.ReqConsID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_req_resumes r on r.OfferedLocationID=m.RID 
						where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
					when l.StaffingID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_cand_staffing_info r on r.WorkingLocationID=m.RID 
						where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  )SEPARATOR '\n')  as Location,
                GROUP_CONCAT( distinct ifnull ((select  GROUP_CONCAT(distinct InvoiceRefNo) FROM  ebnp_consultant_reimburse_item  WHERE ProcessMonthID = p.RID ),"" ))  as EmpInvoiceRefNo
		
        From ebnp_consultant_reimburse p 
		JOIN ebnp_invoice_line_details l ON l.CID=p.CID and  l.RefID = p.RID AND l.IsDelete = iIsDelete 
        JOIN ebnp_cand_personal_info pi ON pi.RID = l.ConsultantID AND pi.CID = iCID 
        join ebnp_cand_hr_details hr on hr.ConsultantID = l.ConsultantID AND hr.CID = iCID 
		WHERE l.LineType = 1 and l.InvoiceID = iInvoiceID AND p.CID = iCID 
        GROUP BY l.InvoiceID) as rim ON rim.InvoiceID = i.RID 
    
    -- General Consultant Information
    LEFT JOIN (Select l.InvoiceID, 
			group_concat( (@row_nwageSplit:=@row_nwageSplit + 1)  SEPARATOR '\n') as SlNo,  
            group_concat(IFNULL(pi.EmployeeNo, "") SEPARATOR '\n') as EmployeeNo,  
            group_concat(TRIM(REPLACE(CONCAT(pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " "))  SEPARATOR '\n') as EmployeeName,  
             group_concat((
                case when l.ReqConsID>0 then ifnull((Select DATE_FORMAT(r.DOJ , "%d-%b-%y") From    ebnp_req_resumes r 
                where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
                   when l.StaffingID>0 then ifnull(DATE_FORMAT(hr.DOJ , "%d-%b-%y"),' ') else ' ' end  
                ) SEPARATOR '\n') as DOJ,
            group_concat(ifnull(DATE_FORMAT(hr.LWDUpdatedOn , "%d-%b-%y"),' ') SEPARATOR '\n') as LWD,
              group_concat( (
                case when l.ReqConsID>0 then ifnull((Select m.Title From ebnpm_general_master m JOIN ebnp_req_resumes r on r.OfferedDesignationID=m.RID  and m.CID=r.CId 
                where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
                   when l.StaffingID>0 then ifnull((Select Title From ebnpm_general_master Where CID=iCID and RID = hr.DesignationID) ,' ') else ' ' end  
                )
                SEPARATOR '\n')as Designation,       
                group_concat( (
                case when l.ReqConsID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_req_resumes r on r.OfferedLocationID=m.RID  
                where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
                   when l.StaffingID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_cand_staffing_info r on r.WorkingLocationID=m.RID 
                where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  
                )
                SEPARATOR '\n')  as Location,
                   group_concat( (
                case  when l.StaffingID>0 then ifnull((Select ClientEmployeeNo From   ebnp_cand_staffing_info r  
                where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  
                )
                SEPARATOR '\n') as ClientEmployeeNo,
                group_concat(  (case when l.LineType = 0 then
						ifnull((select bR.BillRate from   ebnp_cons_prl_log p 
							JOIN  ebnp_cons_prl_log_billrate bR on bR.PayrollLogID=p.RID    and bR.IsDeleted=0
							where p.IsDeleted = 0 and  p.PayrollID=l.RefID and p.CID=pi.CID  ),"")             
						when l.LineType = 8 then
						ifnull((select r.BillRate from   ebnp_cons_ts_advance_bill_invoice_dtls ts 
						JOIN ebnp_rate_card_log_billrate r on r.RateCardID =ts.RID and r.CID=ts.CID where ts.RID=l.RefID and ts.CID=pi.CID   ),"")
						else
						"" end)  
                SEPARATOR '\n') as tblBillRate
			
		from ebnp_invoice_line_details l 
		JOIN ebnp_cand_personal_info pi ON pi.RID = l.ConsultantID AND pi.CID = iCID 
        join ebnp_cand_hr_details hr on hr.ConsultantID = pi.RID AND hr.CID = iCID 
		WHERE l.InvoiceID = iInvoiceID and l.CID =iCID AND l.IsDelete = iIsDelete 
        GROUP BY l.InvoiceID) as empdet ON empdet.InvoiceID = i.RID 
        
    -- RareCardBilling    
	LEFT JOIN(SELECT 
    l.InvoiceID,  group_concat( (@row_nwageSplit:=@row_nwageSplit + 1)  SEPARATOR '\n') as SlNo, 
    MAX(p.MonthYear) as MonthYear,Min(ts.StartDate) as BillFrom,Max(EndDate) as BillTo,group_concat(p.PONo) as PONo, group_concat(p.INBNo) as INBNo,
    GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( distinct  concat(date_format(poi.POStartDate,'%d-%b-%y'),case when isnull(poi.POEndDate)=0 then concat('-',date_format(poi.POEndDate,'%d-%b-%y')) else '' end) ) From ebnp_client_contracts_po_items poi   where poi.PONo = p.PONo and poi.CID=iCID and poi.IsDeleted = 0  ),null ))  as PODate,
    GROUP_CONCAT( distinct ifnull (  (select  GROUP_CONCAT( date_format(poi.POIssueDate,'%d-%b-%y') ) From ebnp_client_contracts_po_items poi   where poi.PONo = p.PONo and poi.CID=iCID and poi.IsDeleted = 0  ),null ))  as POIssueDate,
	GROUP_CONCAT(p.BillPeriod  SEPARATOR '\n' ) as BilliableDays  , 
	GROUP_CONCAT(p.LOB  SEPARATOR '\n' ) as LOBDays, 
    
    GROUP_CONCAT(distinct (Select GROUP_CONCAT( DISTINCT po.InvoiceNarration)  FROM ebnp_cons_rate_card_po_balance b 
						JOIN ebnp_client_contracts_po_items po ON po.RID = b.POID and po.CID=b.CID  and po.IsDeleted = 0 
						WHERE   b.CID = p.CID AND b.RateCardID = p.RID)) as PONarration,
	GROUP_CONCAT(distinct (Select GROUP_CONCAT( DISTINCT po.InvoiceNarration) FROM ebnp_cons_rate_card_po_balance b 
						JOIN ebnp_client_contracts_po_inb po ON po.RID = b.INBID and po.POID = b.POID and po.CID = b.CID  and po.IsDeleted = 0 
						WHERE  b.CID = p.CID AND b.RateCardID = p.RID)) as INBNarration,
	group_concat(TRIM(REPLACE(CONCAT(pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " "))  SEPARATOR '\n') as EmployeeName,
    group_concat( (
                case  when l.StaffingID>0 then ifnull((Select ClientEmployeeNo From   ebnp_cand_staffing_info r  
                where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  
                )
                SEPARATOR '\n') as ClientEmployeeNo,
                GROUP_CONCAT(p.BillAmount  SEPARATOR '\n' ) as BillAmount ,
                0 as MarginPM,
                GROUP_CONCAT(p.ChargableAmount  SEPARATOR '\n' ) as NetCTC,
                
                GROUP_CONCAT(p.LOB  SEPARATOR '\n' ) as LOP,
                GROUP_CONCAT(b.PerMonthTariff  SEPARATOR '\n' ) as CTCPM,
                group_concat(ifnull(DATE_FORMAT(hr.LWDUpdatedOn , "%d-%b-%y"),' ') SEPARATOR '\n') as LWD,
				group_concat(ifnull(DATE_FORMAT(hr.DOJ , "%d-%b-%y"),' ') SEPARATOR '\n') as DOJ,
                group_concat( (
					case when l.ReqConsID>0 then ifnull((Select m.Title From ebnpm_general_master m JOIN ebnp_req_resumes r on r.OfferedDesignationID=m.RID 
							where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
					when l.StaffingID>0 then ifnull((Select Title From ebnpm_general_master Where CID=iCID and RID = hr.DesignationID) ,' ') else ' ' end  
						)SEPARATOR '\n')as Designation,
				group_concat( (
					case when l.ReqConsID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_req_resumes r on r.OfferedLocationID=m.RID 
						where r.RID = l.ReqConsID and r.CID=iCID) ,' ')
					when l.StaffingID>0 then ifnull((Select LocationTitle From ebnpm_location m JOIN ebnp_cand_staffing_info r on r.WorkingLocationID=m.RID 
						where r.RID = l.StaffingID and r.CID=iCID) ,' ') else ' ' end  )SEPARATOR '\n')  as Location,
				GROUP_CONCAT(ts.InvRefNo  SEPARATOR '\n' ) as EmpInvoiceRefNo   ,
                GROUP_CONCAT(b.BillRate  SEPARATOR '\n' ) as BillRate
    
    From ebnp_cons_time_sheet_advance_bill ts 
		JOIN ebnp_cons_ts_advance_bill_invoice_dtls p on p.AdvTSID=ts.RID and p.CID=ts.CID
		LEFT JOIN ebnp_rate_card_log_billrate b ON b.RateCardID = p.RID and b.CID = p.CID
		JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID=p.CID AND l.IsDelete = iIsDelete 
        JOIN ebnp_cand_personal_info pi ON pi.RID = l.ConsultantID AND pi.CID = iCID 
        join ebnp_cand_hr_details hr on hr.ConsultantID = pi.RID AND hr.CID = iCID 
		WHERE l.LineType = 8 and l.InvoiceID = iInvoiceID AND p.CID = iCID 
        GROUP BY l.InvoiceID) as rcB on rcB.InvoiceID=i.RID
        
	LEFT JOIN ebnpm_billing_options bi ON bi.RID = c.BillingOptionID AND bi.CID = i.CID 
	LEFT JOIN ebnpm_state fs ON fs.EngKeyID = i.InvoiceFromStateID AND fs.LanguageType = iLanguageType 
	LEFT JOIN ebnpm_state ts ON ts.EngKeyID = i.InvoiceToStateID AND ts.LanguageType = iLanguageType 
	LEFT JOIN ebnpm_state shipto ON shipto.EngKeyID = i.ShipToStateID AND shipto.LanguageType = iLanguageType
	LEFT JOIN ebnp_invoice_details p ON p.RID = i.ParentInvoiceID AND p.CID = i.CID AND p.IsDelete = iIsDelete 
    left join ebnpsm_customer_email_settings es on es.CID = i.CID 
    LEFT JOIN ebnp_client_lower_tds lt ON lt.RID = i.LowerTDSCertID AND lt.CID = i.CID 
    LEFT JOIN ebnpsm_customer_cc_lut_details ltn ON ltn.CID = c.CID AND ltn.CostCenterID = i.CostCenterID AND ltn.Status = 0 and ltn.IsDeleted = 0 AND i.InvoiceDate BETWEEN IFNULL(ltn.LUTDate, i.InvoiceDate) AND IFNULL(ltn.LUTExpiryDate, i.InvoiceDate) 
	Where i.CID = iCID and i.RID = iInvoiceID AND i.IsDelete = iIsDelete;
	
	SET @rowInvDet:= 0;
	
	Select d.RID as LineItemID, d.InvoiceID, d.ConsultantID, d.StaffingID, 
    (@rowInvDet:=@rowInvDet + 1)  as SlNo, '998513' as HSNCode, 
    IFNULL(p.EmployeeNo, "") as EmployeeNo, 
	ifnull(TRIM(REPLACE(CONCAT(p.FirstName, " ", p.MiddleName, " ", p.LastName), "  ", " ")), "")  as ConsultantName, 
	d.LineType, (CASE d.LineType When 0 Then "Payroll" When 1 Then "Reimbursement" When 2 Then "Misc."  when 3 then "Sourcing" when 4 then "Other" when 5 then "Credit Note" when 6 then "Absorption" when 7 then "Consolidated" when 8 then "Rate Card Billing" Else "" END) as StrLineType, 
	d.RID as  RefID, 
	(CASE d.LineType 
	When 0 THEN IFNULL((Select pt.TransactionNo From ebnp_payroll_mgr_transaction pt 
												JOIN ebnp_consultant_payroll cp ON cp.TransactionID = pt.RID and cp.CID=pt.CID Where cp.IsDeleted = 0 and cp.RID = d.RefID), "") 
	When 1 THEN IFNULL((Select pt.TransactionNo From ebnp_reimburse_mgr_transaction pt 
												JOIN ebnp_consultant_reimburse cp ON cp.TransactionID = pt.RID  and cp.CID=pt.CID Where cp.RID = d.RefID), "") 
	ELSE "" END) as StrRefTransactionNo, 
	d.BillAmount, d.TaxID, IFNULL(t.TaxTitle, "") as TaxName, IFNULL(t.IsSEZ, 0) as IsSEZ, 
	(CASE IFNULL(t.IsSEZ, 0) WHEN 0 then "Non SEZ" Else "SEZ" END) as StrIsSEZ, 
	IFNULL(td.Tax1Name, "") as Tax1Name, IFNULL(td.Tax1, 0) as Tax1, d.Tax1Amount, 
	IFNULL(td.Tax2Name, "") as Tax2Name, IFNULL(td.Tax2, 0) as Tax2, IFNULL(td.Tax2On, 0) as Tax2On, (CASE td.Tax2On When 0 Then "Bill Amount" When 1 Then "Tax 1 Amount" When 2 then "Bill Amount + Tax 1 Amount" Else "" END) as StrTax2On, d.Tax2Amount, 
	IFNULL(td.Tax3Name, "") as Tax3Name, IFNULL(td.Tax3, 0) as Tax3, IFNULL(td.Tax3On, 0) as Tax3On, (CASE td.Tax3On When 0 Then "Bill Amount" When 1 Then "Tax 1 Amount" When 2 Then "Tax 2 Amount" When 3 then "Bill Amount + Tax 1 Amount" When 4 then "Bill Amount + Tax 2 Amount" When 5 then "Bill Amount + Tax 1 Amount + Tax 2 Amount" ELSE "" END) as  StrTax3On, d.Tax3Amount, 
	d.TaxAmount, d.TotalAmount, d.CollectedAmount, d.CreditNoteAmount ,
    ifnull(u.FullName, "NA") as UserName,
	(case u.UserType when 0 then "Operations" when 1 then "HR" when 2 then "Payroll" when 3 then "Finance" when 4 then "Management" else "NA" end)  as ContactDesignation,
            d.LineSubType , 
            case d.LineSubType when 0 then 'Primary' when 1 then 'Markup' when 2 then 'Header' end as StrLineSubType 
	From ebnp_invoice_details i 
	JOIN ebnp_invoice_line_details d ON d.InvoiceID = i.RID and d.CID=i.CID  AND d.IsDelete = iIsDelete 
	LEFT JOIN ebnp_cand_personal_info p ON p.RID = d.ConsultantID AND p.CID = i.CID 
	LEFT JOIN ebnpm_tax_master t ON t.RID = d.TaxID  and t.CID=d.CID
	LEFT JOIN ebnpm_tax_details td on td.TaxID = t.RID AND td.Status = 0 
    join ebnpsm_customer_user u on u.RID = i.ModifiedUserID  and u.CustomerID=i.CID
	Where i.CID = iCID and i.RID = iInvoiceID AND i.IsDelete = iIsDelete ;
    
    SET @rowInvDet:= 0;
	
	Select 
		(@rowInvDet:=@rowInvDet + 1)  as `Sl No`,
		ifnull(invp.Narration ,'') as `ITEM DESCRIPTION`,
        
		ifnull(invp.SACCode ,'') as `HSN/SAC`,
		
		(case when invp.ReferenceTypeID = 8 AND invp.SalaryHeaderID>0 then  (TRIM(invp.Quantity) + 0)  
				when invp.ReferenceTypeID = 8 
				then ifnull((select sum(p.BillPeriod) from ebnp_cons_ts_advance_bill_invoice_dtls p  
														JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID=p.CID  AND l.IsDelete = iIsDelete 
														JOIN ebnp_rate_card_log_billrate r on r.RateCardID =p.RID and r.CID=p.CID 
														JOIN ebnp_cand_staffing_bill_rate sbr ON sbr.RID = r.SRateID AND sbr.CID = r.CID 
														JOIN ebnpm_frequency fq ON fq.RID = sbr.FrequencyID AND fq.Type in (0,1) 
													  WHERE l.LineType = 8 and l.InvoiceID = iInvoiceID AND p.CID = iCID and l.RID=invp.RefID), (TRIM(invp.Quantity) + 0)) 
			else 
		(TRIM(invp.Quantity) + 0) 
		end ) as QTY,
		
		(case 
			when invp.SalaryHeaderID > 0 then "" 
			when i.InvoiceCatg = 0 THEN "M" 
			when invp.ReferenceTypeID = 8 and invp.RefID>0 then
            ifnull((select (CASE fq.Type WHEN 0 THEN "Hr" WHEN 1 THEN "D" WHEN 2 THEN "W" WHEN 3 THEN "Bi-W" WHEN 4 THEN "M" WHEN 5 THEN "Y" ELSE "" END) from ebnp_cons_ts_advance_bill_invoice_dtls ts 
                                        JOIN ebnp_invoice_line_details il  on il.RefID=ts.RID and il.LineType =8 and il.CID=ts.CID and il.IsDelete = iIsDelete and il.LineType=8
										JOIN ebnp_rate_card_log_billrate r on r.RateCardID =ts.RID and r.CID=ts.CID 
										JOIN ebnp_cand_staffing_bill_rate sbr ON sbr.RID = r.SRateID AND sbr.CID = r.CID 
										JOIN ebnpm_frequency fq ON fq.RID = sbr.FrequencyID 
										where ts.RID=il.RefID and ts.CID=invp.CID and il.RID=invp.RefID order by  r.rid desc limit 1 ), "")
            when invp.ReferenceTypeID = 8 and invp.RefID=0 then
            ifnull((select (CASE MIN(fq.Type) WHEN 0 THEN "Hr" WHEN 1 THEN "D" WHEN 2 THEN "W" WHEN 3 THEN "Bi-W" WHEN 4 THEN "M" WHEN 5 THEN "Y" ELSE "" END) from   ebnp_cons_ts_advance_bill_invoice_dtls ts 
                                        JOIN ebnp_invoice_line_details il  on il.RefID=ts.RID and il.LineType =8 and il.CID=ts.CID and il.IsDelete = iIsDelete and il.LineType=0
										JOIN ebnp_rate_card_log_billrate r on r.RateCardID =ts.RID and r.CID=ts.CID 
										JOIN ebnp_cand_staffing_bill_rate sbr ON sbr.RID = r.SRateID AND sbr.CID = r.CID 
										JOIN ebnpm_frequency fq ON fq.RID = sbr.FrequencyID 
										where ts.RID=il.RefID and ts.CID=invp.CID  ), "")
			else  
			"" 
		end) as UOM,

		(CASE 
			when i.InvoiceCatg = 0  and invp.RefID>0 then -- payroll if narration with multiple line
            ifnull((select p.PerMonthTariff from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID limit 1), 0.00)   
			when i.InvoiceCatg = 0  and invp.RefID = 0 then -- payroll particular is singe
            ifnull((select sum(p.PerMonthTariff) from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete  and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID  ), 0.00) 
			ELSE
			0.00
		END) as `Fixed CTC`, 
		
		(CASE 
			when i.InvoiceCatg = 0  and invp.RefID>0 then -- payroll if narration with multiple line
            ifnull((select p.ChargableAmount from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID limit 1), 0.00)   
			when i.InvoiceCatg = 0  and invp.RefID = 0 then -- payroll particular is singe
            ifnull((select sum(p.ChargableAmount) from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete  and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID  ), 0.00) 
			ELSE
			0.00
		END) as `Calculated CTC`, 
		
		(CASE 
			when i.InvoiceCatg = 0  and invp.RefID>0 then -- payroll if narration with multiple line
            ifnull((select p.Markup from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID limit 1), 0.00)   
			when i.InvoiceCatg = 0  and invp.RefID = 0 then -- payroll particular is singe
            ifnull((select sum(p.Markup) from   ebnp_cons_prl_log p 
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete  and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID  ), 0.00) 
			ELSE
			0.00
		END) as `Mark Up`,  
        
		(case 
        when invp.SalaryHeaderID>0 then invp.BillAmount 
        when i.InvoiceCatg = 0  and invp.RefID>0 then -- payroll if narration with multiple line
            ifnull((select bR.BillRate from   ebnp_cons_prl_log p 
										JOIN  ebnp_cons_prl_log_billrate bR on bR.PayrollLogID=p.RID and bR.IsDeleted=0
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID limit 1  ),invp.BillAmount )   
			when i.InvoiceCatg = 0  and invp.RefID = 0 then -- payroll particular is singe
            ifnull((select sum(bR.BillRate) from   ebnp_cons_prl_log p 
										JOIN  ebnp_cons_prl_log_billrate bR on bR.PayrollLogID=p.RID and bR.IsDeleted=0
                                        JOIN ebnp_invoice_line_details il  on il.payrollID=p.PayrollID and il.CID=p.CID and il.IsDelete = iIsDelete  and il.LineType=0
                                        where p.IsDeleted = 0 and  il.RID=invp.RefID and p.CID=invp.CID  ),invp.BillAmount ) 
            when i.InvoiceCatg = 7  and invp.RefID>0 then
            ifnull((select r.BillRate from ebnp_cons_ts_advance_bill_invoice_dtls ts 
                                        JOIN ebnp_invoice_line_details il  on il.RefID=ts.RID and il.LineType =8 and il.CID=ts.CID and il.IsDelete = iIsDelete and il.LineType=8
										JOIN ebnp_rate_card_log_billrate r on r.RateCardID =ts.RID and r.CID=ts.CID 
										where ts.RID=il.RefID and ts.CID=invp.CID and il.RID=invp.RefID order by  r.rid desc limit 1 ),invp.BillAmount)
            when i.InvoiceCatg = 7  and invp.RefID=0 then
            ifnull((select sum(r.BillRate) from   ebnp_cons_ts_advance_bill_invoice_dtls ts 
                                        JOIN ebnp_invoice_line_details il  on il.RefID=ts.RID and il.LineType =8 and il.CID=ts.CID and il.IsDelete = iIsDelete and il.LineType=0
										JOIN ebnp_rate_card_log_billrate r on r.RateCardID =ts.RID and r.CID=ts.CID 
										where ts.RID=il.RefID and ts.CID=invp.CID  ),invp.BillAmount)
        else
         invp.BillAmount end) as `PRICE PER UNIT`,
		 
		0.00 as DISCOUNT,

		invp.BillAmount as `Taxable Value`,
		
		ifnull((Select (CASE tm.IsSEZ 
								WHEN 0 then IFNULL((Select (td.Tax1 + td.Tax2 + td.Tax3) FROM ebnpm_tax_details td WHERE td.Status = 0 AND td.TaxID = tm.RID),0) 
							Else 0 
						END) FROM ebnpm_tax_master tm 
				Where tm.CID = invp.CID and tm.RID = invp.TaxID), 0) as `GST Rate`, 

		invp.TaxAmount as `Tax Amount`,
		invp.TotalAmount as `Total Value` 
		From ebnp_invoice_details_particulars invp 
        JOIN ebnp_invoice_details i on i.RID=invp.InvoiceID and i.CID=invp.CID and i.IsDelete=invp.IsDelete 
        WHERE i.RID = iInvoiceID AND invp.IsDelete = iIsDelete and i.CID=iCID;
    
	 if iInvoiceCatg in (0 ) then
		begin 
			Select GROUP_CONCAT(DISTINCT SalaryHeaderID) INTO tSalaryHeaderIDs  
			FROM ebnp_cons_prl_details 
			Where IsDeleted = 0 and CID = iCID AND PayrollID in (Select p.RID from ebnp_consultant_payroll p 
			JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID =p.CID AND l.IsDelete = iIsDelete 
			WHERE p.IsDeleted = 0 and  l.LineType = 0 and l.InvoiceID = iInvoiceID AND p.CID = iCID);
			IF ISNULL(tSalaryHeaderIDs) = 1 THEN
				Set tSalaryHeaderIDs = "0";
			END IF;
		end;
	elseif iInvoiceCatg in (1 ) then
		begin 
			Select GROUP_CONCAT(DISTINCT SalaryHeaderID) INTO tSalaryHeaderIDs  
			FROM ebnp_consultant_reimburse_details 
			Where ReimburseID in (Select p.RID from  ebnp_consultant_reimburse p 
			JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID = p.CID AND l.IsDelete = iIsDelete 
			WHERE l.LineType = 1 and l.InvoiceID = iInvoiceID AND p.CID = iCID );
		
			IF ISNULL(tSalaryHeaderIDs) = 1 THEN
				Set tSalaryHeaderIDs = "0";
			END IF;			
		end;
	END IF;
    
	if tSalaryHeaderIDs!="" && tSalaryHeaderIDs!="0" then
		SELECT 
			GROUP_CONCAT(CONCAT(' IFNULL(SUM(CASE WHEN find_in_set(d.SalaryHeaderID, "', x.SalIDs, '") THEN d.Amount END),0) AS `', x.HeaderTag, '` ' ) ORDER BY x.SeqNo), 
			GROUP_CONCAT(  CONCAT(' x.`', x.HeaderTag, '` as `', x.DisplayName, '`')  ORDER BY x.SeqNo) 
		into tHQry,tHVQry
		FROM (Select s.HeaderTag, s.DisplayName, GROUP_CONCAT(s.RID) as SalIDs, g.SeqNo, s.HeaderType 
			FROM ebnpm_salary_header s JOIN ebnpm_salary_header_group g ON g.RID = s.HeaderGroupID 
			WHERE s.IsNotPartOfCTC = 0 
		  and FIND_IN_SET(s.RID, tSalaryHeaderIDs) 
		AND s.CID = iCID 
		GROUP BY s.HeaderTag, s.DisplayName, g.SeqNo, s.HeaderType
		ORDER BY g.SeqNo, s.HeaderType) x;
	end if; 
		
	if ifnull(tHQry,"")!="" then
		if iInvoiceCatg in (0 ) then
			begin 
				set @REPTEXT=concat('Select ',tHQry,'
				FROM ebnp_cons_prl_details d
				JOIN ebnp_consultant_payroll p on p.RID=d.PayrollID and p.CID=d.CID and p.IsDeleted = 0   
				JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID=p.CID AND l.IsDelete = ',iIsDelete,' 
				WHERE d.IsDeleted = 0 and l.LineType = 0 and l.InvoiceID = ',iInvoiceID,' AND p.CID = ',iCID,'   group by l.InvoiceID;'); 
				
				PREPARE qry From @REPTEXT;
				EXECUTE qry;
				DEALLOCATE PREPARE qry;
			 
			end;
		elseif iInvoiceCatg in (1 ) then
			begin 
				set @REPTEXT=concat('Select ',tHQry,'
				FROM ebnp_consultant_reimburse_details d
				JOIN ebnp_consultant_reimburse p on p.RID=d.ReimburseID
				JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID =p.CID AND l.IsDelete = ',iIsDelete,' 
				WHERE l.LineType = 1 and l.InvoiceID = ',iInvoiceID,' AND p.CID = ',iCID,'  group by l.InvoiceID;'); 

				PREPARE qry From @REPTEXT;
				EXECUTE qry;
				DEALLOCATE PREPARE qry;
			end;
		END IF;
	
	end if;
    		
	if iInvoiceCatg in (0 ) then
		BEGIN 
			SELECT 
				GROUP_CONCAT(CONCAT(' IFNULL(SUM(CASE WHEN find_in_set(plm.POLineItemID, "', x.IDs, '") THEN plm.MarkUp END),0) AS `', x.DisplayName, '` ' ) ORDER BY x.ItemType), 
				GROUP_CONCAT(DISTINCT CONCAT(' mk.`', x.DisplayName, '` as `', x.DisplayName, '` ') ORDER BY x.ItemType)  
				INTO POItemRepQry, POItemColQry 
				FROM (Select IFNULL(po.DisplayName, po.Title) as DisplayName, GROUP_CONCAT(po.RID) as IDs, po.ItemType 
				FROM ebnpm_po_item po 
				WHERE po.IsDeleted = 0 and po.CID = iCID and po.RID in (Select DISTINCT plm.POLineItemID  
						FROM ebnp_cons_prl_log_markup plm 
						JOIN ebnp_cons_prl_log pl ON pl.CID = iCID AND pl.RID = plm.PayrollLogID and pl.IsDeleted = 0 
						Where plm.MarkUp > 0 
						and pl.PayrollID in (Select p.RID from ebnp_consultant_payroll p
													JOIN ebnp_invoice_line_details l ON l.RefID = p.RID  and l.CID=p.CID AND l.IsDelete = iIsDelete 
													WHERE p.IsDeleted = 0 and l.LineType = 0 and l.InvoiceID = iInvoiceID AND p.CID = iCID))
				GROUP BY po.ItemType, po.DisplayName
				ORDER BY po.ItemType, po.DisplayName) x;
				
			IF POItemRepQry != "" THEN   
				SET @QRY = CONCAT(' SELECT  ',POItemRepQry,' 
										FROM ebnp_cons_prl_log_markup plm  
										JOIN ebnp_cons_prl_log pl ON pl.RID = plm.PayrollLogID and plm.CID = pl.CID and pl.IsDeleted = 0 	
										JOIN ebnp_consultant_payroll p ON p.RID = pl.PayrollID AND p.CID=pl.CID
										JOIN ebnp_invoice_line_details l ON l.RefID = p.RID and l.CID=p.CID AND l.IsDelete = ',iIsDelete,' 
										WHERE p.IsDeleted = 0 and p.CID = ', iCID,' AND l.LineType = 0 and l.InvoiceID = ',iInvoiceID,'  
										group by l.InvoiceID ;'); 
					
				PREPARE qry From @QRY;
				EXECUTE qry;
				DEALLOCATE PREPARE qry; 
			END IF;   
		end;
	END IF; 
  	
END ;;
DELIMITER ;




DROP PROCEDURE IF EXISTS `SP_GET_OFFER_APPROVE_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_GET_OFFER_APPROVE_DTLS`(
iCID BIGINT,
iRID BIGINT,
iUserID BIGINT  
)
BEGIN
	DECLARE tQRY TEXT DEFAULT "";
    DECLARE iReqConsID BIGINT ;
	DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
    
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0)  ,
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		-- left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		-- JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC - dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
	
	SET tQRY = CONCAT(' SELECT a.RID as RID,  a.CID, a.ConsultantID, a.ReqConsID, a.StaffingID,  						
						IFNULL((CASE WHEN i.OfficialEMailID != "" THEN i.OfficialEMailID ELSE i.EMailID END),"" ) as EMailID, i.MobileNo as MobileNo , i.DOB as DOB,
						IFNULL((Select p.PhotoPath From ebnp_cand_photo_details p where p.ConsultantID = i.RID ORDER BY RID DESC LIMIT 1), "") as Photo,		  
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation), 
							" ", i.FirstName, " ", i.MiddleName, " ", i.LastName), "  ", " ") )  as ConsultantName, 
						i.EmployeeNo, 
						a.OfferStatus as Status, (CASE a.OfferStatus WHEN 0 THEN "Pending" when 1 then "Approved" when 2 then "Rejected" ELSE "NA" END) as ApproverStatus, 
						a.CreatedDate as SubmittedOn, 
						IFNULL(a.OfferRemark, "") as Remarks, 
                        
						');
                            
	IF iReqConsID = 0 THEN 
		SET tQRY = CONCAT(tQRY,' si.CID,IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
                            "" AS Anchor,
                            si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
							si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,                        
							si.ContractID, si.RID AS StaffingID,
                            ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
                            hr.ExpectedDOJ AS ExpectedDOJ, 
                            hr.PresentCTC, 
                            ifnull((select c.Currency from ebnpm_currency c where c.RID =  hr.PresentCTCCurrencyID), "") as PresentCTCCurrency,
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = hr.PresentCTCFrequencyID), "") as PresentCTCFrequency, 
    
							IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
							IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,
							(CASE hr.CTCInputType WHEN 0 THEN "CTC" WHEN 1 THEN "Gross" WHEN 2 THEN "Net Take Home" END) AS `StrCTCInputType`,
							
							"" as PercentageHike, 
							"" as MarkUpPercent, 
                            "" as OfferedCTC , 
							""  as OfferedCTCCurrency,
							"" as OfferedCTCFrequency,
                            ""  as BillableCTCCurrency,
							""  as BillableCTC	, 
							"" as BillableCTCFrequency,
                       
                       ');
	ELSE
		SET tQRY = CONCAT(tQRY,' 										
							r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
							(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
							0 as ContactID,r.ClientID as ClientID,
							ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
							r.BranchID,
							IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName, 
							ifnull(cc.ContractNo ,"") as ContractNo,
							ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
							ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
							IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
							rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
							ifnull(rq.JobDescription ,"") as JobDescription, 
							CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
							CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
							as BillRateRange ,
							ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
							where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
                            
							IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
                            ifnull((select c.Currency from ebnpm_currency c where c.RID = r.OfferedCTCCurrencyID), "") as OfferedCTCCurrency,
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = r.OfferedCTCFrequencyID), "") as OfferedCTCFrequency,
							r.OfferedDesignationID, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
							r.ExpectedDOJ as ExpectedDOJ, 
							IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

							-- CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)) as PresentCTC, 

							-- In case of Sourcing (Req Resume) Present CTC is Offered CTC
                            IFNULL(',dPresentCTC,',0.00) AS PresentCTC, 
							ifnull((select c.Currency from ebnpm_currency c where c.RID =  r.OfferedCTCCurrencyID), "") as PresentCTCCurrency,
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = r.OfferedCTCFrequencyID), "") as PresentCTCFrequency, 
    
							
							IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
							/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
										  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent, 
							*/
                            
                            IFNULL(',dPercentageHike,',0.00) AS PercentageHike,
							IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
                            ',dBillRate,' as BillRate,
							"" as MarkUpPercent, 
                         
							-- Billable ctc
							
							ifnull((select c.Currency from ebnpm_currency c where c.RID = r.BillableCTCCurrencyID), "") as BillableCTCCurrency,
							IFNULL(r.BillableCTC, 0.00) as BillableCTC	, 
							ifnull((select f.Frequency from ebnpm_frequency f where f.RID = r.BillableCTCFrequencyID), "") as BillableCTCFrequency,
							(CASE r.CTCInputType WHEN 0 THEN "CTC" WHEN 1 THEN "Gross" WHEN 2 THEN "Net Take Home" END) AS `StrCTCInputType`,
							
                        ');    
     END IF;
    
	SET tQRY=CONCAT(tQRY,'
                        FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ApproverUser           
						FROM ebnp_offer_approval a 
						JOIN ebnp_cand_personal_info i ON i.RID = a.ConsultantID AND i.CID=a.CID  
                        ');	
                                    
    IF iReqConsID = 0   THEN                            
		SET tQRY=CONCAT(tQRY,'							
							JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID							
							JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID
							JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = i.RID AND hr.CID=i.CID
							');
	ELSE
		SET tQRY=CONCAT(tQRY, '							
							JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = i.CID                    
							JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
                            JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID 
                            ');
	 END IF;
    
	SET tQRY=CONCAT(tQRY,'	Where a.CID = ', iCID, ' AND a.RID = ',iRID,'  '); 
    
    SET tQRY = concat(tQRY, ' order by a.RID desc ');
   
	SET @tQRY = tQRY;
	PREPARE qry FROM @tQRY;
    EXECUTE qry;
	DEALLOCATE PREPARE qry;
    
END ;;

DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_GET_OFFER_REQUEST_DTLS`;
DELIMITER $$
CREATE  PROCEDURE `SP_GET_OFFER_REQUEST_DTLS`(
iRID BIGINT,
iCID bigint,
iUserID BIGINT,
iApprover1 TINYINT
)
BEGIN
 DECLARE iConsultantID BIGINT Default 0;
 SELECT ConsultantID INTO iConsultantID FROM ebnp_offer_approval WHERE RID=iRID AND CID=iCID;

		IF iApprover1 > 0 THEN
	
            -- 74 - Offer request mailer
            -- MAIL BODY
            -- TAble 0
             WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				  FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 74 ORDER BY t.RID DESC  LIMIT 1)
				  SELECT mt.RID, mt.CID ,mt.MailSubject,mt.MailBody,ifnull(es.EMailShortName, "") as EMailShortName,
                  COALESCE(mt.FromEMail ,es.EMailID, "") as FromEMail ,ifnull(es.LogoName, "") as LogoName, ifnull(es.LogoPath, "") as LogoUrl,
                  ifnull(es.LogoPath, "") as LogoPath,ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
			
            -- TAble 1
            -- MAIL CC
                  WITH all_cc as (
                  WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 74 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.MailCC as MailCC, mt.MailBCC as MailBCC, a.CID
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (select EmailID from ebnp_cand_personal_info WHERE CID=a.CID and RID=a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (3,4,9,10,11,16) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnp_client_contact WHERE CID=a.CID and RID = a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (1,14,17) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnpsm_customer_user WHERE CustomerID=a.CID and RID=a.ApproverID ) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (2,5,6,7,8,12,13,15,18) AND a.ConsultantID=iConsultantID
                  UNION
                  select (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 AND a.ConsultantID=iConsultantID AND a.RID=iRID  ) 
                  select group_concat(distinct if (ac.MailCC ='', null, ac.MailCC)) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_offer_approval a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND  a.ConsultantID=iConsultantID;
			
                -- TAble 2
				-- MAIL DETAILS		 
				select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType in (1,14,17) then 1 else 2 end) as ApproverType, a.ApproverID,
				c.CustomerTitle  as CustomerName,
                IFNULL(es.LogoName, "") as LogoName, 
				IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				IFNULL(es.EMailID,"") as FromEMail,
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
				iFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = iUserID ),"") as UserName,
				a.ApproverType,
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1) as ToEMail,  
				a.OfferLetterID as OfferLetterID,    
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,2) as MobileNo,
				TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
				, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
				i.EmployeeNo, 
				a.OfferRemark as OfferRemark,
				(CASE a.OfferStatus WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproveStatus,
				COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
						(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
				COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
							(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
				h.ExpectedDOJ,
				COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
						  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
			     to_base64(a.ConsultantID) as ConsIDB64,
				 to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
		         to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
		         to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64,
				 c.ESSURL as ESSURLLink 
				
				from ebnp_offer_approval a  
				LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
				LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
				join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
				LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
				LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
				join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
				join ebnpsm_customer c on c.RID = a.CID 
                LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				where a.RID = iRID and a.CID = iCID ;
                
                -- Table 3 
                WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				  FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 87 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.RID, mt.CID ,mt.MailSubject,mt.MailBody,ifnull(es.EMailShortName, "") as EMailShortName,
                  COALESCE(mt.FromEMail ,es.EMailID, "") as FromEMail ,ifnull(es.LogoName, "") as LogoName, ifnull(es.LogoPath, "") as LogoUrl,
                  ifnull(es.LogoPath, "") as LogoPath,ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
                
                -- TAble 4
                -- Action Mailer CC AND BCC
                select "" as MailCC ,"" as MailBCC;
			
                -- TAble 5
                -- Action Mailer To Approver 
                
                select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType in (1,14,17) then 1 else 2 end) as ApproverType, a.ApproverID,
				c.CustomerTitle  as CustomerName,
                IFNULL(es.LogoName, "") as LogoName, 
				IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				IFNULL(es.EMailID,"") as FromEMail,
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
				iFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = iUserID ),"") as UserName,
				a.ApproverType,    
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1) as ToEMail,  
				a.OfferLetterID as OfferLetterID,    
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,2) as MobileNo,
				TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
				, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
				i.EmployeeNo, 
				a.OfferRemark as OfferRemark,
				(CASE a.OfferStatus WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproveStatus,
				COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
						(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
				COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
							(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,h.ExpectedDOJ, 
				COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
						  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
				 to_base64(a.ConsultantID) as ConsIDB64,
				 to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
		         to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
		         to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64,
				 c.ESSURL as ESSURLLink 				 
				from ebnp_offer_approval a  
				LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
				LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
				join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
				LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
				LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
				join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
                LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				join ebnpsm_customer c on c.RID = a.CID 
				where a.RID = iRID and a.CID = iCID ;
				
    ELSE
          -- 76 -> Return to Initiator / Final Approver
          -- TAble 0 MAIL BODY
          WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				  FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 76 ORDER BY t.RID DESC LIMIT 1)
                  
				  SELECT mt.RID, mt.CID ,mt.MailSubject,mt.MailBody,ifnull(es.EMailShortName, "") as EMailShortName,
                  COALESCE(mt.FromEMail ,es.EMailID, "") as FromEMail ,ifnull(es.LogoName, "") as LogoName, ifnull(es.LogoPath, "") as LogoUrl,
                  ifnull(es.LogoPath, "") as LogoPath,ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
                  
			-- MAIL CC	
            -- Table 1
                  WITH all_cc as (
                  WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 76 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.MailCC as MailCC, mt.MailBCC as MailBCC, a.CID
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (select EmailID from ebnp_cand_personal_info WHERE CID=a.CID and RID=a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (3,4,9,10,11,16) AND a.RID=iRID
                  union 
                  select (select EmailID from ebnp_client_contact WHERE CID=a.CID and RID = a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (1,14,17) AND a.RID=iRID
                  union 
                  select (select EmailID from ebnpsm_customer_user WHERE CustomerID=a.CID and RID=a.ApproverID ) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (2,5,6,7,8,12,13,15,18) AND a.RID=iRID ) 
                  select group_concat(distinct ac.MailCC) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_offer_approval a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND a.RID=iRID AND a.ConsultantID=iConsultantID;
			
			-- MAIL DETAILS	
            -- Table 2
            
				select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType in (14,17,1) then 1 else 2 end) as ApproverType, a.ApproverID,
				c.CustomerTitle  as CustomerName, 
                IFNULL(es.LogoName, "") as LogoName, 
				IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				IFNULL(es.EMailID,"") as FromEMail,
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
				iFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = iUserID ),"") as UserName,
				a.ApproverType,    
                (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as ToEMail, 
				a.OfferLetterID as OfferLetterID,    
                (SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MobileNo,
				TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
				, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
				i.EmployeeNo, 
				a.OfferRemark as OfferRemark,
				(CASE a.OfferStatus WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproveStatus,
				COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
						(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
				COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
							(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
				h.ExpectedDOJ,
				COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
						  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
			    to_base64(a.ConsultantID) as ConsIDB64,
			    to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
			    to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
			    to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64,
			    c.ESSURL as ESSURLLink 
               
				from ebnp_offer_approval a  
				LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
				LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
				join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
				LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
				LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
				join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
                LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				join ebnpsm_customer c on c.RID = a.CID 
				where a.RID = iRID and a.CID = iCID ;
                
                -- Table 3
                WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				  FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 87 ORDER BY t.RID DESC LIMIT 1)
                  
				  SELECT mt.RID, mt.CID ,mt.MailSubject,mt.MailBody,ifnull(es.EMailShortName, "") as EMailShortName,
                  COALESCE(mt.FromEMail ,es.EMailID, "") as FromEMail ,ifnull(es.LogoName, "") as LogoName, ifnull(es.LogoPath, "") as LogoUrl,
                  ifnull(es.LogoPath, "") as LogoPath,ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
             
             -- TABLE  4
                    select "" as MailCC ,"" as MailBCC;
             
             -- TABLE  5    
				-- MAIL DETAILS(ACTION MAILER)			 
				select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType = 1 then 1 else 2 end) as ApproverType, a.ApproverID,
				c.CustomerTitle  as CustomerName,
                IFNULL(es.LogoName, "") as LogoName, 
				IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				IFNULL(es.EMailID,"") as FromEMail,
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
				iFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = iUserID ),"") as UserName,
				a.ApproverType,    
                (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as ToEMail, 
				a.OfferLetterID as OfferLetterID,    
                (SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MobileNo,
				TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
				, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
				i.EmployeeNo, 
				a.OfferRemark as OfferRemark,
				(CASE a.OfferStatus WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproveStatus,
				COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
						(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
				COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
							(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
				h.ExpectedDOJ, 
				COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
						  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
					to_base64(a.ConsultantID) as ConsIDB64,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64,
					c.ESSURL as ESSURLLink 
				
				from ebnp_offer_approval a  
				LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
				LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
				join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
				LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
				LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
				join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
                LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				join ebnpsm_customer c on c.RID = a.CID 
				where a.RID = iRID and a.CID = iCID ;
                          
   END IF;
    
END $$
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_GET_ONBOARD_REQUEST_DETAILS`;
DELIMITER $$
CREATE PROCEDURE `SP_GET_ONBOARD_REQUEST_DETAILS`( 
iCID bigint,
iRID BIGINT,
iRequestID BIGINT,
iUserID BIGINT
)
BEGIN	
    DECLARE tQry TEXT;
    DECLARE iReqConsID,iStaffingID BIGINT;
    DECLARE dBillRate, dOfferedCTC, dPresentCTC, dPercentageHike DECIMAL(16,2) default 0.00;
   
    
   SELECT  IFNULL((select b.BillRate  * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = b.FrequencyID), 1) 
						from ebnp_cand_staffing_bill_rate b 
                        where b.ConsultantID = r.ConsultantID and b.CID = r.CID AND b.Status = 0), 0),
			 (r.OfferedCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.OfferedCTCFrequencyID), 1)) ,
			 (r.PresentCTC * IFNULL((Select (CASE ebnpm_frequency.Type When 0 Then 2920 When 1 Then 365 When 2 Then 52 When 3 Then 26 When 4 Then 12 When 5 Then 1 ELSE 1 END) 
				From ebnpm_frequency Where RID = r.PresentCTCFrequencyID), 1))   into dBillRate , dOfferedCTC , dPresentCTC
    
		FROM ebnp_offer_approval a 
		JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID
		left JOIN  ebnp_cand_staffing_bill_rate b on b.ConsultantID = r.ConsultantID and b.CID = r.CID
		JOIN ebnp_cand_staffing_info si ON si.RID = b.StaffingID AND si.ConsultantID = b.ConsultantID and si.CID = b.CID
		Where a.CID = iCID AND a.RID = iRID
		order by a.RID desc limit 1;
        
		SET dBillRate = dBillRate/12;
		SET dOfferedCTC = dOfferedCTC/12;
		SET dPresentCTC = dPresentCTC/12;
		
        IF( dOfferedCTC > 0 AND dPresentCTC > 0) 
			THEN SET dPercentageHike = (((dOfferedCTC -dPresentCTC )/dOfferedCTC) * 100) ;
        END IF;
    
    
    SELECT IFNULL(ReqConsID,0),IFNULL(StaffingID,0) INTO iReqConsID,iStaffingID FROM ebnp_cand_onboarding_initiate_approve WHERE RID = iRequestID LIMIT 1;   
    
    SET tQry=CONCAT(' SELECT d.RID as ApproveRID,d.RequestID as OnBoardRequestID,a.ConsultantID, a.StaffingID,a.ReqConsID,						
						TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(pi.Salutation), 
							" ", pi.FirstName, " ", pi.MiddleName, " ", pi.LastName), "  ", " ") )  as ConsultantName,
						pi.EmployeeNo , 
                        IFNULL((CASE WHEN pi.OfficialEMailID != "" THEN pi.OfficialEMailID ELSE pi.EMailID END),"" ) as EMailID, pi.MobileNo as MobileNo , pi.DOB as DOB,
                                
						d.ApproveStatus, IFNULL((CASE d.ApproveStatus WHEN 1 THEN "Request Initiated" WHEN 2 THEN "Approved" WHEN 2 THEN "Rejected" ELSE "" END),"") as StrStatus,
						
						IFNULL((SELECT FullName FROM ebnpsm_customer_user where RID = a.CreatedUserID and CustomerID = a.CID),"") AS InitiatedUser,
						a.CreatedDate as InitiatedDate  ,d.ApproverID as ApproveUserID,
                        ');  
                                
		IF iReqConsID = 0 THEN 
			SET tQRY = CONCAT(tQRY,' si.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = si.CID), "") as CustomerName, 
								"" AS Anchor,
								si.ContactID, si.ClientID, ifnull((Select ClientName From ebnp_clients WHERE RID = si.ClientID), "") as ClientName,
								si.BranchID, IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = si.BranchID), "") as BranchName,                        
								si.ContractID, si.RID AS StaffingID,
								ifnull((select TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(r.Salutation), 
											" ", r.FirstName, " ", r.MiddleName, " ", r.LastName), "  ", " ") ) from ebnp_cand_personal_info r where r.RID = si.ReportingPerson1ID), "") as PrimaryReportingPerson,
								ifnull((select TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(r.Salutation), 
											" ", r.FirstName, " ", r.MiddleName, " ", r.LastName), "  ", " ") ) from ebnp_cand_personal_info r where r.RID = si.ReportingPerson2ID), "") as SecondaryReportingPerson,
                                
                                ifnull((select TRIM(CONCAT(a.FirstName, " ", a.LastName)) from ebnp_client_contact a where a.RID = si.ContactID), "") as ContactName,
								ifnull(cc.ContractNo ,"") as ContractNo,
								ifnull(cc.ContractCode,"") as ContractCode, IFNULL(si.ClientEmployeeNo, "") as ClientEmployeeNo,
								hr.ExpectedDOJ AS ExpectedDOJ, hr.PresentCTC, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = hr.DesignationID), "") as OfferedDesignation,
								IFNULL((Select Title From ebnpm_general_master WHERE RID = hr.DesignationID), "") as Designation,

								"" as HikePercent, 
								"" as MarkUpPercent ,
								
                                FN_GET_APPROVER_NAME_TEXT(d.ApproverID,d.ApproverType,0) as ApproverName   
                                
								');
		ELSE 
			SET tQRY = CONCAT(tQRY,' 	IFNULL(r.TicketNo,"") as TicketNo ,						
								r.CID, IFNULL((Select CustomerTitle From ebnpsm_customer WHERE RID = r.CID), "") as CustomerName, 
								(SELECT cu.FullName FROM ebnpsm_customer_user cu where cu.RID = rq.AnchorID) AS Anchor, 
								0 as ContactID,r.ClientID as ClientID,
								ifnull((Select ClientName From ebnp_clients WHERE RID = r.ClientID), "") as ClientName,
								r.BranchID,
								IFNULL((Select BranchName From ebnp_client_branchs WHERE RID = r.BranchID), "") as BranchName,
								ifnull(cc.ContractNo ,"") as ContractNo,
								ifnull(cc.ContractCode,"") as ContractCode, "" as ClientEmployeeNo,
								ifnull(rq.JobTitle ,"") as JobTitle, ifnull(rq.JobCode ,"") as JobCode, 
								IFNULL((Select Frequency From ebnpm_frequency Where RID = BillRateFrequencyID), "") as BillRateFrequency,
								rq.PlacementType as PlacementType, (CASE rq.PlacementType WHEN 0 THEN "Contract Staffing" WHEN 1 THEN "Permanent Sourcing" ELSE "" END) AS StrPlacementType,
								ifnull(rq.JobDescription ,"") as JobDescription, 
								CONCAT(rq.ConsultantCTCFrom, " to ", rq.ConsultantCTCTill) as CTCRange ,
								CONCAT(rq.BillRateFrom, " to ", rq.BillRateTill, " ", 
								ifnull((select f.Frequency from ebnpm_frequency f where f.RID = rq.BillRateFrequencyID), ""))
								as BillRateRange ,
								ifnull((select group_concat(lc.LocationTitle order by lc.LocationTitle) from ebnpm_location lc
								where lc.RID in (select l.CityID from ebnp_client_req_locations l where l.ReqID = rq.RID )), "NA") as Locations,
								IFNULL(r.OfferedCTC, 0.0) as OfferedCTC , 
								r.OfferedDesignationID, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as OfferedDesignation,
								r.ExpectedDOJ as ExpectedDOJ, 
								IFNULL((Select Title FROM ebnpm_general_master Where RID = r.OfferedDesignationID), "") as Designation,

								IFNULL(CAST((r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)) as decimal(16,2)),0.00) as PresentCTC,
								
								IFNULL((Select Title From ebnpm_general_master WHERE RID = r.OfferedDesignationID), "") as Designation, 
								/*CAST(IFNULL((((r.OfferedCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.OfferedCTCFrequencyID)) - 
											  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID)))/
											  (r.PresentCTC * (Select (Case `Type` WHEN 0 THEN (8*365) WHEN 1 THEN 365 WHEN 2 then 52 WHEN 3 THEN 26 WHEN 4 then 12 else 1 end) FROM ebnpm_frequency WHERE RID = r.PresentCTCFrequencyID))) * 100, 0.00) as decimal(16,2)) as HikePercent,*/
								
                                IFNULL(',dPercentageHike,',0.00) AS HikePercent,
								IFNULL((',dBillRate - dOfferedCTC,' ),0.00)  As MarkUp,
								IFNULL(',dBillRate,' ),0.00) as BillRate,   
								
								"" as MarkUpPercent,
                                
                                FN_GET_APPROVER_NAME_TEXT(d.ApproverID,d.ApproverType,0) as ApproverName 
							
							');    
		 END IF;
        
        
		SET tQry=CONCAT(tQry, ' FROM ebnp_cand_onboarding_initiate_approve a 
								JOIN ebnp_cand_onboarding_initiate_approve_details d ON d.RequestID = a.RID AND d.CID=a.CID
								JOIN ebnp_cand_personal_info pi ON pi.RID = a.ConsultantID AND pi.CID = a.CID
								
                            ');
                            
		IF iReqConsID = 0   THEN                            
			SET tQRY=CONCAT(tQRY,'							
								LEFT JOIN ebnp_cand_staffing_info si on si.RID = a.StaffingID AND si.CID = a.CID	AND si.ConsultantID = a.ConsultantID                  						
								LEFT JOIN ebnp_client_contracts cc ON cc.RID = si.ContractID AND cc.CID=a.CID			
                                JOIN ebnp_cand_hr_details hr ON hr.ConsultantID = pi.RID AND hr.CID=pi.CID
								');
		ELSE
			SET tQRY=CONCAT(tQRY, '							
								LEFT JOIN ebnp_req_resumes r ON r.RID = a.ReqConsID AND r.CID = a.CID AND r.ConsultantID = a.ConsultantID                                   
								LEFT JOIN ebnp_client_requirements rq ON rq.RID = r.ReqID AND rq.CID=a.CID
								LEFT JOIN ebnp_client_contracts cc ON cc.RID = r.ContractID AND cc.CID=r.CID
								');
		 END IF;
                            
		SET tQry=CONCAT(tQry, ' 
							WHERE a.CID=',iCID,' AND d.RID = ',iRID,' AND d.RequestID = ',iRequestID,'
                            AND d.ApproverType in (2,5,6,7,12,13,8,15,18)
						');                

    SET @tQry = tQry ;
    PREPARE qry FROM @tQry;
    EXECUTE qry;
    DEALLOCATE PREPARE qry;
    
END $$
DELIMITER ;
-- Method Refrence
-- CORE - BeProcessOfferRequest
DROP PROCEDURE IF EXISTS `SP_OFFER_REQUEST_APP_DTLS`;
DELIMITER ;;
CREATE PROCEDURE `SP_OFFER_REQUEST_APP_DTLS`( 
iRID bigint,
iCID bigint,
iConsultantID bigint,
iApprover2 TINYINT
)
BEGIN

   
   IF iApprover2 > 0 THEN
			 -- 74 -> Next Approver
	         -- Table 0 - MAIL BODY
                  WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				  FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 74 ORDER BY t.RID DESC LIMIT 1)
                  
				  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,IFNULL(mt.FromEMail,es.EMailID) AS FromEMail,ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
				
              -- Table 1  MAIL CC
				
                WITH all_cc as (
                  WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 74 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.MailCC as MailCC, mt.MailBCC as MailBCC, a.CID
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (select EmailID from ebnp_cand_personal_info WHERE CID=a.CID and RID=a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (3,4,9,10,11,16) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnp_client_contact WHERE CID=a.CID and RID = a.ApproverID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where offerStatus=0 and ApproverType in (1,14,17) AND a.ConsultantID=iConsultantID
                  union 
                  select (select EmailID from ebnpsm_customer_user WHERE CustomerID=a.CID and RID=a.ApproverID ) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where offerStatus=0 and ApproverType in (2,5,6,7,8,12,13,15,18) AND a.ConsultantID=iConsultantID
				  UNION
                  select (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 AND a.ConsultantID=iConsultantID
                  UNION
                  select (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MailCC,
                  "" as MailBCC, a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 AND a.ConsultantID=iConsultantID AND a.RID=iRID ) 
                  select group_concat(distinct if (ac.MailCC ='', null, ac.MailCC )) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_offer_approval a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND a.RID=iRID AND a.ConsultantID=iConsultantID;


				 -- Table 2 MAIL DETAILS
					
                    select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType IN (14,1,17) then 1 else 2 end) as ApproverType, 
					a.ApproverID,c.CustomerTitle  as CustomerName,
                    IFNULL(es.LogoName, "") as LogoName, 
				    IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				    IFNULL(es.EMailID,"") as FromEMail,
					-- ReturnType 0->ApproverName
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
					IFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = a.CreatedUserID and u.CustomerID = a.CID ),"") as UserName,
					-- ReturnType 1->EMailID
				    --  COALESCE(FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1),mt.FromEmailID,amt.FromEmailID) as FromEMail, 
					IFNULL(FN_GET_APPROVER_NAME_TEXT(n.ApproverID,n.ApproverType,1),(SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID)) as ToEMail, 
					a.OfferLetterID as OfferLetterID,
					-- ReturnType 2->MobileNo
					IFNULL(FN_GET_APPROVER_NAME_TEXT(n.ApproverID,n.ApproverType,2),(SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID)) as MobileNo,
					a.ConsultantID as ConsultantID,
					TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
					, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
					i.EmployeeNo, 					
					(CASE (CASE WHEN ISNULL(n.RID) = FALSE THEN n.OfferStatus ELSE a.OfferStatus END ) WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproverStatus,
					a.OfferRemark as OfferRemark,
					COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
							(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
					COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
								(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
					IFNULL(h.ExpectedDOJ,rr.ExpectedDOJ) AS ExpectedDOJ,  ifnull(es.LogoPath, "") as LogoPath, 
					COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
							  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
					"" as RequestType,
                    to_base64(a.ConsultantID) as ConsIDB64,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64 ,
                    c.ESSURL as ESSURLLink
                    
					
					from ebnp_offer_approval a  
					LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
					LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
					join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
					LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
					LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
					join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
					LEFT JOIN (SELECT * FROM ebnp_offer_approval WHERE ConsultantID = iConsultantID AND CID = iCID AND RID=iRID AND OfferStatus = 0) n ON n.ConsultantID = a.ConsultantID and n.CID = a.CID
                    LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
					join ebnpsm_customer c on c.RID = a.CID 
					where a.RID = iRID and a.CID = iCID;
                    
                    -- Table 3
                        
                        WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID as FromEMail
				   FROM ebnpm_templates t WHERE t.CID = iCID  AND t.Type = 87 ORDER BY t.RID DESC LIMIT 1)
                  
				  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,IFNULL(mt.FromEMail,es.EMailID) AS FromEMail,ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID ;
                    -- Action Mailer CC AND BCC
                  
                  -- Table 4
                  
                  select "" as MailCC ,"" as MailBCC;
                
                    -- Action Mailer To Approver 
                    -- Table 5
                   
                   select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType IN (14,1,17) then 1 else 2 end) as ApproverType, 
					a.ApproverID,c.CustomerTitle  as CustomerName,
                    IFNULL(es.LogoName, "") as LogoName, 
				    IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				    IFNULL(es.EMailID,"") as FromEMail,	
					-- ReturnType 0->ApproverName
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
					IFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = a.CreatedUserID and u.CustomerID = a.CID ),"") as UserName,
					-- ReturnType 1->EMailID
				    --  COALESCE(FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1),mt.FromEmailID,amt.FromEmailID) as FromEMail, 
					IFNULL(FN_GET_APPROVER_NAME_TEXT(n.ApproverID,n.ApproverType,1),(SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID)) as ToEMail, 
					a.OfferLetterID as OfferLetterID,
					-- ReturnType 2->MobileNo
					IFNULL(FN_GET_APPROVER_NAME_TEXT(n.ApproverID,n.ApproverType,2),(SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID)) as MobileNo,
					a.ConsultantID as ConsultantID,
					TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
					, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
					i.EmployeeNo, 					
					(CASE (CASE WHEN ISNULL(n.RID) = FALSE THEN n.OfferStatus ELSE a.OfferStatus END ) WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproverStatus,
					a.OfferRemark as OfferRemark,
					COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
							(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
					COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
								(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
					IFNULL(h.ExpectedDOJ,rr.ExpectedDOJ) AS ExpectedDOJ, 
					COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
							  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
					"" as RequestType, 
					to_base64(a.ConsultantID) as ConsIDB64,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64 ,
                    c.ESSURL as ESSURLLink
					
					from ebnp_offer_approval a  
					LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
					LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
					LEFT join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
					LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
					LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
					join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
					LEFT JOIN (SELECT * FROM ebnp_offer_approval WHERE ConsultantID = iConsultantID AND CID = iCID AND OfferStatus = 0 AND RID=iRID ) n ON n.ConsultantID = a.ConsultantID and n.CID = a.CID
					LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
                    join ebnpsm_customer c on c.RID = a.CID 
					where a.RID = iRID and a.CID = iCID;
	
    else
    
                  -- 76 -> Return to Initiator / Final Approver
                  -- TABLE  0
				
                WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID 
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 76 ORDER BY t.RID DESC  LIMIT 1)
				  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,mt.FromEmailID AS FromEMail , ifnull(es.EMailShortName, "") as EMailShortName, 	 
					ifnull(es.LogoName, "") as LogoName, 
					ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
					ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID;
				  
                  -- TABLE  1
			     
                 with all_cc as (
				  WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 76 ORDER BY t.RID DESC LIMIT 1)
                  
				  SELECT mt.MailCC as MailCC, mt.MailBCC as MailBCC,a.CID
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (select EmailID from ebnp_cand_personal_info WHERE CID=a.CID and RID=a.ApproverID) as MailCC,
                  "" as MailBCC,a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (3,4,9,10,11,16) AND a.RID=iRID 
                  union 
                  select (select EmailID from ebnp_client_contact WHERE CID=a.CID and RID = a.ApproverID) as MailCC,
                  "" as MailBCC,a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (1,14,17) AND a.RID=iRID  
                  union 
                  select (select EmailID from ebnpsm_customer_user WHERE CustomerID=a.CID and RID=a.ApproverID ) as MailCC,
                  "" as MailBCC,a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 and a.ApproverType in (2,5,6,7,8,12,13,15,18) AND a.RID=iRID  ) 
                  select group_concat(distinct MailCC) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_offer_approval a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND a.RID=iRID AND a.ConsultantID=iConsultantID; 
             
                   -- TABLE  2
                   
					select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType IN (14,1,17) then 1 else 2 end) as ApproverType, 
					a.ApproverID,c.CustomerTitle  as CustomerName,
                    IFNULL(es.LogoName, "") as LogoName, 
				    IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				    IFNULL(es.EMailID,"") as FromEMail,
					-- ReturnType 0->ApproverName
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,					
					IFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = a.CreatedUserID and u.CustomerID = a.CID ),"") as UserName,
					
					-- ReturnType 1->EMailID
				  --  COALESCE(FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1),mt.FromEmailID,amt.FromEmailID) as FromEMail, 
					(SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as ToEMail, 
					a.OfferLetterID as OfferLetterID,
					
					-- ReturnType 2->MobileNo
					(SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MobileNo,
					a.ConsultantID as ConsultantID,
					
					TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
					, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
					i.EmployeeNo, 
					
					(CASE (CASE WHEN ISNULL(n.RID) = FALSE THEN n.OfferStatus ELSE a.OfferStatus END ) WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproverStatus,
					a.OfferRemark as OfferRemark,
					COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
							(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
					COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
								(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
					IFNULL(h.ExpectedDOJ,rr.ExpectedDOJ) AS ExpectedDOJ,  ifnull(es.LogoPath, "") as LogoPath, 
					COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
							  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
					"" as RequestType,
                    to_base64(a.ConsultantID) as ConsIDB64,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64 ,
                    c.ESSURL as ESSURLLink
					
					from ebnp_offer_approval a  
					LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
					LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
					join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
					LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
					LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
					join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
					LEFT JOIN (SELECT * FROM ebnp_offer_approval WHERE ConsultantID = iConsultantID  AND CID = iCID AND OfferStatus = 0 AND RID=iRID ) n ON n.ConsultantID = a.ConsultantID and n.CID = a.CID
					LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
                    join ebnpsm_customer c on c.RID = a.CID 
					where a.RID = iRID and a.CID = iCID;
                 
                 -- Table 3
                  WITH mail_tempaltes AS (SELECT t.RID, t.CID,t.MailSubject,t.MailBody,t.FromEmailID 
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 87 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,mt.FromEmailID AS FromEMail , ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID;
              
				   -- TABLE  4
                 
				   select "" as MailCC ,"" as MailBCC;
                
                  -- TABLE  5
                  
					select a.RID, (case when a.ApproverType in (0,3,4) then 0 when a.ApproverType IN (14,1) then 1 else 2 end) as ApproverType, 
					a.ApproverID,c.CustomerTitle as CustomerName,
                    IFNULL(es.LogoName, "") as LogoName, 
				    IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				    IFNULL(es.EMailID,"") as FromEMail,
					-- ReturnType 0->ApproverName
					FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,					
					IFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = a.CreatedUserID and u.CustomerID = a.CID ),"") as UserName,
					
					-- ReturnType 1->EMailID
				  --  COALESCE(FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1),mt.FromEmailID,amt.FromEmailID) as FromEMail, 
					(SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as ToEMail, 
					a.OfferLetterID as OfferLetterID,
					
					-- ReturnType 2->MobileNo
					(SELECT Mobile FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MobileNo,
					a.ConsultantID as ConsultantID,
					TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
					, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, i.EmployeeNo, 
					(CASE (CASE WHEN ISNULL(n.RID) = FALSE THEN n.OfferStatus ELSE a.OfferStatus END ) WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproverStatus,
					a.OfferRemark as OfferRemark,
					COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
							(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
					COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
								(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
					IFNULL(h.ExpectedDOJ,rr.ExpectedDOJ) AS ExpectedDOJ, 
					COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
							  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
					"" as RequestType,  
					to_base64(a.ConsultantID) as ConsIDB64,
					to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
					to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
					to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64 ,
                    c.ESSURL as ESSURLLink
					
					from ebnp_offer_approval a  
					LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
					LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
					join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
					LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
					LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
					join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
					LEFT JOIN (SELECT * FROM ebnp_offer_approval WHERE ConsultantID = iConsultantID  AND CID = iCID AND OfferStatus = 0 AND RID=iRID ) n ON n.ConsultantID = a.ConsultantID and n.CID = a.CID
					LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
                    join ebnpsm_customer c on c.RID = a.CID 
					where a.RID = iRID and a.CID = iCID;
				
                    
		END IF;			
  
  
			  -- 75- OfferRequestApproved (Offer Approver Reject Mailer)
              -- TABLE  5
               WITH mail_tempaltes AS (SELECT t.RID, t.CID, t.MailSubject,t.MailBody,t.FromEmailID 
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 75 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.RID, mt.CID,mt.MailSubject,mt.MailBody,mt.FromEmailID as FromEMail ,	ifnull(es.EMailShortName, "") as EMailShortName, 	 
				  ifnull(es.LogoName, "") as LogoName, 
				  ifnull(es.LogoPath, "") as LogoUrl, ifnull(es.LogoPath, "") as LogoPath, 
				  ifnull(es.EmailDeclaimerText, "") as EmailDeclaimerText
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
                  LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID;
            
            
                -- TABLE  6
				  with all_cc as ( WITH mail_tempaltes AS (SELECT t.MailCC,t.MailBCC,t.CID
				  FROM ebnpm_templates t WHERE t.CID = iCID AND t.Type = 75 ORDER BY t.RID DESC LIMIT 1)
				  SELECT mt.MailCC,mt.MailBCC,mt.CID
				  FROM  ebnp_offer_approval a 
                  LEFT JOIN mail_tempaltes mt ON mt.CID=a.CID
				  where a.CID=iCID AND a.ConsultantID=iConsultantID AND a.RID=iRID
                  UNION
                  select (SELECT EMailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID = a.CreatedUserID) as MailCC,
                  "" as MailBCC,a.CID
                  from   ebnp_offer_approval a 
                  where a.offerStatus=0 AND a.ConsultantID=iConsultantID AND a.RID=iRID ) 
                  select group_concat(distinct if (ac.MailCC ='', null, ac.MailCC)) AS MailCC,group_concat(distinct if (ac.MailBCC ='', null, ac.MailBCC)) AS MailBCC
                  from ebnp_offer_approval a 
                  LEFT JOIN all_cc ac on ac.CID=a.CID
                  WHERE a.CID=iCID AND a.RID=iRID AND a.ConsultantID=iConsultantID;  
				  
             
				-- TABLE  7		 
				select a.RID, 
				(case when a.ApproverType in (0,3,4) then 0 when a.ApproverType IN (1,14) then 1 else 2 end) as ApproverType, 
				a.ApproverID,c.CustomerTitle  as CustomerName,
                IFNULL(es.LogoName, "") as LogoName, 
				IFNULL(es.LogoPath, "") as LogoUrl, IFNULL(es.LogoPath, "") as LogoPath, 
				IFNULL(es.EMailID,"") as FromEMail,
				-- ReturnType 0->ApproverName
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,0) as ContactName,
				IFNULL((SELECT u.FullName FROM ebnpsm_customer_user u WHERE u.RID = a.CreatedUserID and u.CustomerID = a.CID ),"") as UserName,
				-- ReturnType 1->EMailID
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,1) as FromEMail, 
				COALESCE((SELECT EmailID FROM ebnpsm_customer_user WHERE CustomerID = a.CID AND RID= a.CreatedUserID), c.EMailID) as ToEMail ,
				a.OfferLetterID as OfferLetterID,
				-- ReturnType 2->MobileNo
				FN_GET_APPROVER_NAME_TEXT(a.ApproverID,a.ApproverType,2) as MobileNo,
				a.ConsultantID as ConsultantID,				
				TRIM(REPLACE(concat(FN_GET_SALUTATION_TEXT(i.Salutation)
					, " " , ifnull(i.FirstName, ""), " " ,ifnull(i.MiddleName, ""), " ", ifnull(i.LastName, "")),"  "," "))  as ConsultantName, 
				i.EmployeeNo, 
				(CASE a.OfferStatus WHEN 0 THEN "Pending" WHEN 1 THEN "Accepted" WHEN 2 THEN "Rejected" WHEN 3 THEN "Cancelled" ELSE "" END ) as ApproverStatus,
				a.OfferRemark as OfferRemark,-- mt.MailCC,mt.MailBCC,
				COALESCE((Select Title From ebnpm_general_master Where RID = rr.OfferedDesignationID),
						(Select Title From ebnpm_general_master Where RID = h.DesignationID), "") AS Designation,
				COALESCE((SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=si.WorkingLocationID),
							(SELECT l.LocationTitle from ebnpm_location l WHERE l.RID=rr.OfferedLocationID),"") AS WorkingLocation,
				IFNULL(h.ExpectedDOJ,rr.ExpectedDOJ) AS ExpectedDOJ, 
				COALESCE( CONCAT(rr.OfferedCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = rr.OfferedCTCFrequencyID), "") ),
						  CONCAT(h.PresentCTC, " ", IFNULL((Select Frequency FROM ebnpm_frequency WHERE RID = h.PresentCTCFrequencyID), "") ),"" ) as Salary,
				"" as RequestType,
                to_base64(a.ConsultantID) as ConsIDB64,
				to_base64(a.CID) as CIDB64, to_base64(a.StaffingID) as StaffingIDB64, to_base64(a.OfferLetterID) as OfferReqIDB64, 
				to_base64(a.ApproverType) as UserTypeB64, to_base64(a.ApproverID) as UserIDB64, to_base64(a.RID) as RIDB64, 
				to_base64("Details") as DetailsB64, to_base64("Approve") as ApproveB64, to_base64("Reject") as RejectB64 ,
				c.ESSURL as ESSURLLink

				
				from ebnp_offer_approval a 
				LEFT JOIN ebnp_cand_staffing_info si ON si.RID = a.StaffingID AND si.CID = a.CID 
				LEFT JOIN ebnp_req_resumes rr ON rr.RID = a.ReqConsID AND rr.CID = a.CID 
				join ebnp_client_contact cc on cc.CID = a.CID AND (cc.RID = si.ContactID OR cc.RID in (Select cr.ContactID From ebnp_client_requirements cr where cr.CID = a.CID AND cr.RID = rr.ReqID)) 
				LEFT join ebnp_cand_hr_details h on h.CID = a.CID AND h.ConsultantID = a.ConsultantID
				LEFT join ebnpsm_customer_user u on u.RID = h.ERManagerID AND u.CustomerID = a.CID 
				join ebnp_cand_personal_info i on i.RID = a.ConsultantID AND i.CID=a.CID
				LEFT JOIN ebnpsm_customer_email_settings es ON es.CID=a.CID
				join ebnpsm_customer c on c.RID = a.CID 
				where a.RID = iRID and a.CID = iCID and a.OfferStatus = 2 ;
    
END ;;
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_SAVE_CONS_FIELD_CHANGE_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_SAVE_CONS_FIELD_CHANGE_REQUEST`(
iCID BIGINT,
iConsultantID BIGINT,
iReqConsID BIGINT,
iStaffingID BIGINT,
iApproverStatus tinyint,
iRequestID BIGINT,
tRemarks TEXT,
iFixedApproverID BIGINT,
iApprover1 TINYINT,
iUserID BIGINT, 
OUT iStatus TINYINT,
Out tStatusMsg text, 
OUT iSavedRID BIGINT
)
BEGIN

	DECLARE iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID BIGINT DEFAULT 0;
	DECLARE iBranchDmID , iContractDmID , iClientDMID,iBusinessAnchorID, iCostCenterManagerID,iBUManagerID,iBUSalesAnchorID BIGINT default 0;
  
	SET iSavedRID=0; --  SET iStatus = 0 ; SET tStatusMsg = "" ;
     
    IF iStaffingID = 0 AND iReqConsID > 0 THEN 
		SELECT si.RID INTO iStaffingID 
				FROM ebnp_cand_staffing_info si 
				JOIN ebnp_req_resumes rr ON rr.CID = si.CID AND rr.ConsultantID = si.ConsultantID and rr.ClientID = si.ClientID and rr.ContractID = si.ContractID 
				WHERE si.CID = iCID AND rr.RID = iReqConsID AND rr.ConsultantID = iConsultantID ORDER BY si.RID DESC LIMIT 1;
		IF ISNULL(iStaffingID) = 1 THEN SET iStaffingID = 0; END IF;
    END IF;
	
	IF iStaffingID > 0 THEN 
	  SELECT si.ContactID, h.ERManagerID, si.ReportingPerson1ID, si.ReportingPerson2ID, c.AnchorID, IFNULL(p.ProjectPartnerID, h.ERManagerID) as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	, IFNULL(bu.AnchorID,0) AS BusinessAnchor, IFNULL(Cuc.ManagerID, 0) as CostCenterManagerID ,
                    IFNULL(bu.EmpManagerID,0) AS EmpManagerID, IFNULL(bu.SalesAnchorID,0) AS SalesAnchorID
		INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
				iClientDMID, iContractDmID, iBranchDmID , iBusinessAnchorID, iCostCenterManagerID, iBUManagerID,iBUSalesAnchorID
				
        from ebnp_cand_staffing_info si 
        JOIN ebnp_cand_hr_details h ON h.ConsultantID = si.ConsultantID and h.CID = si.CID 
		join ebnp_client_contracts c on c.RID = si.ContractID and c.CID = si.CID 
		join ebnp_clients cl on cl.RID = c.ClientID and cl.CID = si.CID 
		left join (select p.RID, p.ProjectPartnerID, p.ContractID from ebnp_client_contract_project p 
							left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
                         where p.CID = iCID order by t.RID desc, p.RID desc limit 1)
        p on p.ContractID = c.RID
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=cl.CID 
        LEFT JOIN ebnp_clients bu on bu.RID = si.BUID AND bu.CID = si.CID 
        LEFT JOIN ebnpsm_customer_cc Cuc on Cuc.RID = si.BillingCostCenterID AND Cuc.CustomerID = si.CID 
        WHERE si.CID = iCID AND si.RID = iStaffingID limit 1 ;
	ELSE
	  SELECT cr.ContactID, 0 as ERManagerID, 0 as ReportingPerson1ID, 0 as ReportingPerson2ID, c.AnchorID , 0 as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	
                    INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, 
					iClientAnchorID , iClientDMID, iContractDmID, iBranchDmID 
				
        from ebnp_req_resumes si 
		JOIN ebnp_client_requirements cr ON cr.CID = si.CID AND cr.RID = si.ReqID  
		LEFT join ebnp_client_contracts c on c.RID = cr.ContractID and c.CID = si.CID 
		LEFT join ebnp_clients cl on cl.RID = si.ClientID  and cl.CID = si.CID 
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=si.CID        
        WHERE si.CID = iCID AND si.RID = iReqConsID limit 1 ;
	END IF;

	/*-- UPDATE ebnp_offer_approval SET Status = 1 where CID=iCID AND ConsultantID=iConsultantID and ((ReqConsID = iReqConsID AND iReqConsID > 0) OR (StaffingID = iStaffingID AND iStaffingID > 0));
	
	IF EXISTS(Select RID FROM ebnp_req_resumes_extend WHERE ReqResumeID = iReqConsID and CID = iCID) THEN 
		UPDATE ebnp_req_resumes_extend SET OfferApprovalStatus = 1, OAInitiatedDate = CURRENT_TIMESTAMP(), OAInitatedUserID = iUserID WHERE ReqResumeID = iReqConsID and CID = iCID;
	ELSE
		INSERT INTO ebnp_req_resumes_extend (CID, ConsultantID, ReqResumeID, OfferApprovalStatus, OAInitiatedDate, OAInitatedUserID, CreatedUserID) 
									VALUES  (iCID, iConsultantID, iReqConsID, 1, CURRENT_TIMESTAMP(), iUserID, iUserID);
	END IF;
*/
	IF iFixedApproverID = 0 THEN 
			Select (CASE iApprover1 WHEN 1 then iContactID WHEN 2 THEN iERManagerID
								  WHEN 3 THEN iReportingPerson1ID WHEN 4 THEN iReportingPerson2ID 
								  WHEN 5 THEN iContractAnchorID WHEN 6 THEN iProjectPartnerID
								  WHEN 7 THEN iClientAnchorID WHEN 9 THEN iClientDMID
								  WHEN 10 THEN iBranchDmID  WHEN 11 THEN iContractDmID 
                                  WHEN 12 THEN iBusinessAnchorID WHEN 13 THEN iCostCenterManagerID 
								  WHEN 14 THEN iFixedApproverID WHEN 15 THEN iFixedApproverID 
								  WHEN 16 THEN iFixedApproverID WHEN 17 then iBUManagerID WHEN 18 then iBUSalesAnchorID 
								  ELSE 0 END) INTO iFixedApproverID;
	END IF;
        
	if (iApprover1 != 0 ) then
		  INSERT INTO ebnp_cons_field_change_approval (CID, ConsultantID, ReqConsID, StaffingID, RequestID, Remarks, ApproverType, ApproverID,CreatedUserID)
												VALUES(iCID,iConsultantID, iReqConsID, iStaffingID, iRequestID, tRemarks, iApprover1, iFixedApproverID, iUserID);
		 SET iSavedRID = @@IDENTITY;
	END IF;
	 
	SET iStatus = 1;
	SET tStatusMsg = "Approval request saved";

	IF iStatus != 1 THEN 
		SET iStatus = -5;
		SET tStatusMsg = "Cancel and re-submit for Approvals";
	END IF;
    
END ;;
DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_SAVE_CONS_ONBOARD_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_SAVE_CONS_ONBOARD_REQUEST`(
iRID BIGINT,
iCID BIGINT,
iConsultantID BIGINT,
iStaffingID BIGINT,
iReqConsID BIGINT,
iApprover1 TINYINT,
iUserID BIGINT,
iFixedApproverID BIGINT,
OUT iStatus SMALLINT,
OUT tStatusMsg TEXT,
OUT iSavedRID BIGINT
)
BEGIN
	DECLARE iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID BIGINT DEFAULT 0;
    Declare iWeekOffTemplateID, iHolidayTemplateID, iBusinessAnchorID, iCostCenterManagerID , iClientDMID, iContractDmID, iBranchDmID,iBUManagerID,iBUSalesAnchorID bigint DEFAULT 0;
    DECLARE iClientID, iBranchID, iContractID BIGINT DEFAULT 0;
    
	SET iStatus = 0;
    SET tStatusMsg = "";
    SET iSavedRID = 0;
    
    IF iStaffingID > 0 THEN 
		SELECT ClientID, BranchID, ContractID INTO iClientID, iBranchID, iContractID FROM ebnp_cand_staffing_info WHERE RID = iStaffingID AND CID=iCID AND ConsultantID=iConsultantID LIMIT 1;
    ELSEIF iReqConsID > 0 THEN
		SELECT ClientID, BranchID, ContractID INTO iClientID, iBranchID, iContractID FROM ebnp_req_resumes WHERE RID = iReqConsID AND CID=iCID AND ConsultantID=iConsultantID  LIMIT 1;
    END IF;
    
    IF iStaffingID > 0 THEN 
			SELECT si.ContactID, h.ERManagerID, si.WeekOffTemplateID, si.HolidayTemplateID, si.ReportingPerson1ID, si.ReportingPerson2ID, c.AnchorID, IFNULL(p.ProjectPartnerID, 
								h.ERManagerID) as ProjectPartnerID, cl.AnchorID , IFNULL(bu.AnchorID,0) AS BusinessAnchor , IFNULL(cc.ManagerID,0) AS CostCenterManager,
									IFNULL(bu.EmpManagerID,0) AS EmpManagerID, IFNULL(bu.SalesAnchorID,0) AS SalesAnchorID
					INTO iContactID, iERManagerID, iWeekOffTemplateID, iHolidayTemplateID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID, iProjectPartnerID,
									iClientAnchorID  , iBusinessAnchorID, iCostCenterManagerID,iBUManagerID,iBUSalesAnchorID
				from ebnp_cand_staffing_info si 
				JOIN ebnp_cand_hr_details h ON h.ConsultantID = si.ConsultantID AND h.CID = si.CID 
				join ebnp_client_contracts c on c.RID = si.ContractID AND si.CID = si.CID 
				join ebnp_clients cl on cl.RID = c.ClientID AND cl.CID = si.CID 
				left join (select p.RID, p.ProjectPartnerID, p.ContractID from ebnp_client_contract_project p 
									left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
								 where p.CID = iCID order by t.RID desc, p.RID desc limit 1)
						p on p.ContractID = c.RID 
				LEFT join ebnp_clients bu on bu.RID = si.BUID AND bu.CID = si.CID 
				LEFT JOIN ebnpsm_customer_cc cc ON cc.RID=si.BillingCostCenterID AND cc.CustomerID=si.CID AND cc.ManagerID IN (SELECT RID FROM ebnpsm_customer_user WHERE CustomerID = si.CID )
				
				WHERE si.CID = iCID AND si.RID = iStaffingID ; 
        
      ELSEIF  iReqConsID > 0 THEN
			SELECT cr.ContactID, 0 as ERManagerID, 0 as ReportingPerson1ID, 0 as ReportingPerson2ID, c.AnchorID, 0 as ProjectPartnerID,
						cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	, 0 , 0		
			INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
					iClientDMID, iContractDmID, iBranchDmID  , iBusinessAnchorID, iCostCenterManagerID
					
			from ebnp_req_resumes si 
			JOIN ebnp_client_requirements cr ON cr.CID = si.CID AND cr.RID = si.ReqID  
			join ebnp_client_contracts c on c.RID = cr.ContractID and c.CID = si.CID 
			join ebnp_clients cl on cl.RID = si.ClientID  and cl.CID = si.CID 
			JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=si.CID     
			WHERE si.CID = iCID AND si.RID = iReqConsID limit 1 ;
      
      END IF;
	
    
    IF iRID = 0 THEN
	
		UPDATE ebnp_cand_onboarding_initiate_approve SET IsLatest = 0 
			WHERE CID = iCID AND ConsultantID = iConsultantID AND StaffingID = iStaffingID AND ReqConsID = iReqConsID AND IsLatest = 1;
    
		INSERT INTO ebnp_cand_onboarding_initiate_approve(CID, ConsultantID, StaffingID, ReqConsID, ClientID, BranchID, ContractID, Status,CreatedUserID )
												 VALUES(iCID, iConsultantID, iStaffingID, iReqConsID, iClientID, iBranchID, iContractID, 1,iUserID);
         
         SET iSavedRID = @@identity;
         
         IF iFixedApproverID = 0 and (iApprover1 != 0 ) THEN 
			Select (CASE iApprover1 WHEN 1 then iContactID WHEN 2 THEN iERManagerID
								  WHEN 3 THEN iReportingPerson1ID WHEN 4 THEN iReportingPerson2ID 
								  WHEN 5 THEN iContractAnchorID WHEN 6 THEN iProjectPartnerID
								  WHEN 7 THEN iClientAnchorID WHEN 9 THEN iClientDMID
								  WHEN 10 THEN iBranchDmID  WHEN 11 THEN iContractDmID 
                                  WHEN 12 THEN iBusinessAnchorID WHEN 13 THEN iCostCenterManagerID 
								  WHEN 14 THEN iFixedApproverID WHEN 15 THEN iFixedApproverID 
								  WHEN 16 THEN iFixedApproverID WHEN 17 THEN iBUManagerID WHEN 18 THEN iBUSalesAnchorID 
								  ELSE 0 END) INTO iFixedApproverID;
		END IF;
        
        if iApprover1 != 0 then
			INSERT INTO ebnp_cand_onboarding_initiate_approve_details (CID, RequestID, ConsultantID, StaffingID,ReqConsID, ApproverType,ApproveStatus, ApproverID)
							VALUES(iCID, iSavedRID, iConsultantID, iStaffingID,iReqConsID, iApprover1,1,iFixedApproverID);
		ELSE 			
			UPDATE ebnp_cand_onboarding_initiate_approve set LastAppStatus = 1 where RID = iSavedRID;
		END IF;
        
		SET iStatus = 2;
        SET tStatusMsg = "OnBoard Approval request raised.";
	ELSE 
		SET iStatus = -5;
        SET tStatusMsg = "Cancel and re-apply for OnBoard request";
    END IF;
    
END ;;
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_SAVE_OFFER_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_SAVE_OFFER_REQUEST`(
iCID BIGINT,
iConsultantID BIGINT,
iReqConsID BIGINT,
iStaffingID BIGINT,

iApproverStatus tinyint,
tOfferRemark TEXT,

iApprover1 TINYINT,
iUserID BIGINT, 
iFixedApproverID BIGINT,
OUT iStatus TINYINT,
Out tStatusMsg text, 
OUT iSavedRID BIGINT
)
BEGIN

	DECLARE iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID BIGINT DEFAULT 0;
	DECLARE iBranchDmID , iContractDmID , iClientDMID,iBusinessAnchorID, iCostCenterManagerID,iBUManagerID,iBUSalesAnchorID BIGINT default 0;
  
	SET iSavedRID=0; --  SET iStatus = 0 ; SET tStatusMsg = "" ;
      
    
	IF iStaffingID = 0 AND iReqConsID > 0 THEN 
		SELECT si.RID INTO iStaffingID 
				FROM ebnp_cand_staffing_info si 
				JOIN ebnp_req_resumes rr ON rr.CID = si.CID AND rr.ConsultantID = si.ConsultantID and rr.ClientID = si.ClientID and rr.ContractID = si.ContractID 
				WHERE si.CID = iCID AND rr.RID = iReqConsID AND rr.ConsultantID = iConsultantID ORDER BY si.RID DESC LIMIT 1;
		IF ISNULL(iStaffingID) = 1 THEN SET iStaffingID = 0; END IF;
	END IF;    
	
	IF iStaffingID > 0 THEN 
	  SELECT si.ContactID, h.ERManagerID, si.ReportingPerson1ID, si.ReportingPerson2ID, c.AnchorID, IFNULL(p.ProjectPartnerID, h.ERManagerID) as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	, IFNULL(bu.AnchorID,0) AS BusinessAnchor, 
                    IFNULL(Cuc.ManagerID, 0) as CostCenterManagerID ,
                    IFNULL(bu.EmpManagerID,0) AS EmpManagerID, IFNULL(bu.SalesAnchorID,0) AS SalesAnchorID
		INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID, iContractAnchorID , iProjectPartnerID, iClientAnchorID ,
				iClientDMID, iContractDmID, iBranchDmID , iBusinessAnchorID, iCostCenterManagerID, iBUManagerID,iBUSalesAnchorID
				
        from ebnp_cand_staffing_info si 
        JOIN ebnp_cand_hr_details h ON h.ConsultantID = si.ConsultantID and h.CID = si.CID 
		join ebnp_client_contracts c on c.RID = si.ContractID and c.CID = si.CID 
		join ebnp_clients cl on cl.RID = c.ClientID and cl.CID = si.CID 
		left join (select p.RID, p.ProjectPartnerID, p.ContractID from ebnp_client_contract_project p 
							left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
                         where p.CID = iCID order by t.RID desc, p.RID desc limit 1)
        p on p.ContractID = c.RID
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=cl.CID 
        LEFT JOIN ebnp_clients bu on bu.RID = si.BUID AND bu.CID = si.CID 
        LEFT JOIN ebnpsm_customer_cc Cuc on Cuc.RID = si.BillingCostCenterID AND Cuc.CustomerID = si.CID 
        WHERE si.CID = iCID AND si.RID = iStaffingID limit 1 ;
	ELSE
	  SELECT cr.ContactID, 0 as ERManagerID, 0 as ReportingPerson1ID, 0 as ReportingPerson2ID, c.AnchorID , 0 as ProjectPartnerID,
					cl.AnchorID , cl.EmpManagerID , c.EmpManagerID , b.EmpManagerID	
                    INTO iContactID, iERManagerID, iReportingPerson1ID, iReportingPerson2ID,  iContractAnchorID , iProjectPartnerID, 
					iClientAnchorID , iClientDMID, iContractDmID, iBranchDmID 
				
        from ebnp_req_resumes si 
		JOIN ebnp_client_requirements cr ON cr.CID = si.CID AND cr.RID = si.ReqID  
		LEFT join ebnp_client_contracts c on c.RID = cr.ContractID and c.CID = si.CID 
		LEFT join ebnp_clients cl on cl.RID = si.ClientID  and cl.CID = si.CID 
        LEFT JOIN ebnp_client_branchs b ON b.RID = si.BranchID AND b.CID=si.CID        
        WHERE si.CID = iCID AND si.RID = iReqConsID limit 1 ;
	END IF;

	UPDATE ebnp_offer_approval SET Status = 1 where CID=iCID AND ConsultantID=iConsultantID and ((ReqConsID = iReqConsID AND iReqConsID > 0) OR (StaffingID = iStaffingID AND iStaffingID > 0));
	
	IF EXISTS(Select RID FROM ebnp_req_resumes_extend WHERE ReqResumeID = iReqConsID and CID = iCID) THEN 
		UPDATE ebnp_req_resumes_extend SET OfferApprovalStatus = 1, OAInitiatedDate = CURRENT_TIMESTAMP(), OAInitatedUserID = iUserID WHERE ReqResumeID = iReqConsID and CID = iCID;
	ELSE
		INSERT INTO ebnp_req_resumes_extend (CID, ConsultantID, ReqResumeID, OfferApprovalStatus, OAInitiatedDate, OAInitatedUserID, CreatedUserID) 
									VALUES  (iCID, iConsultantID, iReqConsID, 1, CURRENT_TIMESTAMP(), iUserID, iUserID);
	END IF;
	
    IF iFixedApproverID = 0 and (iApprover1 != 0 ) THEN 
		Select (CASE iApprover1 WHEN 1 then iContactID WHEN 2 THEN iERManagerID
							  WHEN 3 THEN iReportingPerson1ID WHEN 4 THEN iReportingPerson2ID 
							  WHEN 5 THEN iContractAnchorID WHEN 6 THEN iProjectPartnerID
							  WHEN 7 THEN iClientAnchorID WHEN 9 THEN iClientDMID
							  WHEN 10 THEN iBranchDmID  WHEN 11 THEN iContractDmID 
                              WHEN 12 THEN iBusinessAnchorID WHEN 13 THEN iCostCenterManagerID 
							  WHEN 14 THEN iFixedApproverID WHEN 15 THEN iFixedApproverID 
							  WHEN 16 THEN iFixedApproverID WHEN 17 then iBUManagerID WHEN 18 then iBUSalesAnchorID 
							  ELSE 0 END) INTO iFixedApproverID;
	END IF;
	
    IF (iApprover1 != 0 ) then
		INSERT INTO ebnp_offer_approval (CID, ConsultantID, ReqConsID, StaffingID, ApproverType, ApproverID,CreatedUserID)
								  VALUES(iCID,iConsultantID, iReqConsID, iStaffingID, iApprover1,iFixedApproverID,iUserID);
		SET iSavedRID = @@IDENTITY;
	END IF;
    
	SET iStatus = 1;
	SET tStatusMsg = "Offer Approval request saved";

	IF iStatus != 1 THEN 
		SET iStatus = -5;
		SET tStatusMsg = "Cancel and re-submit for Offer Approvals";
	END IF;
    
END ;;
DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_UPDATE_TIMESHEET_DETAILS`;
DELIMITER ;;
CREATE PROCEDURE `SP_UPDATE_TIMESHEET_DETAILS`(
iRID bigint,
iCID bigint,
iConsultantID bigint,
iStaffingID BIGINT,
iTSType tinyint,
dPayPeriod decimal(16,2),
dLOP decimal(16,2),
dBillPeriod decimal(16,2),
dLOB decimal(16,2),

dWorkDayOTHours decimal(16,2),
dWOOTHours decimal(16,2),
dHOTHours decimal(16,2),
dOHOTHours decimal(16,2),

dAdditionalPayPeriod decimal(16,2),
dAdditionalBillPeriod decimal(16,2),
dBillableHours DECIMAL(16,2),
iUserID bigint,
OUT iStatus TINYINT,
OUT iSavedID TEXT
)
BEGIN
	SET iStatus = 0;
    set iSavedID = 0;
    
	set iSavedID = iRID;
    if iTSType = 0 then
		update ebnp_temp_consultant_time_sheet set 
											PayPeriod = dPayPeriod, LOP = dLOP, BillPeriod = dBillPeriod, LOB = dLOB, 
                                            OTHrs = dWorkDayOTHours, WOOT = dWOOTHours, HOT = dHOTHours, ROT = dOHOTHours, 
                                            ExtraDaysPayable = dAdditionalPayPeriod, ExtraDaysBillable = dAdditionalBillPeriod 
											where TSID = iRID AND CID = iCID AND StaffingID = iStaffingID and UserID = iUserID;
	else 
		update ebnp_consultant_time_sheet set 
											PayPeriod = dPayPeriod, LOP = dLOP, BillPeriod = dBillPeriod, LOB = dLOB, 
                                            OTHrs = dWorkDayOTHours, WOOT = dWOOTHours, HOT = dHOTHours, ROT = dOHOTHours, 
                                            ExtraDaysPayable = dAdditionalPayPeriod, ExtraDaysBillable = dAdditionalBillPeriod,
                                            BillableHours=dBillableHours, ModifiedUserID = iUserID
											where IsDeleted = 0 and RID = iRID AND CID = iCID AND StaffingID = iStaffingID; 
	end if;
    set iStatus = 2;
	
END ;;
DELIMITER ;
DROP PROCEDURE IF EXISTS `SP_VALIDATE_CONS_FIELD_CHANGE_REQUEST`;
DELIMITER $$
CREATE  PROCEDURE `SP_VALIDATE_CONS_FIELD_CHANGE_REQUEST`(
iRID BIGINT,
iCID BIGINT,
iConsultantID BIGINT,
iStaffingID BIGINT,
iChangeType TINYINT,
iUserID BIGINT,

out iApproveType smallint,
OUT iStatus SMALLINT,
out tStatusMsg text,
OUT iFixedApproverID BIGINT
)
BEGIN
	declare iContractID ,iClientID,iReqConsID bigint default 0;
    DECLARE iBranchDmID , iContractDmID , iClientDMID BIGINT default 0;
    declare tAllApprType text default "";
    declare iType tinyint default 0;
   
    set iApproveType = 0 ;
	SET iStatus = 0;
    set tStatusMsg = "";    
    set iReqConsID = 0;     
    set iFixedApproverID = 0;     
 
    IF iCID = 0 or NOT EXISTS(SELECT RID FROM ebnpsm_customer WHERE RID = iCID) THEN
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Customer');
	END IF;
    
    IF iUserID = 0 OR NOT EXISTS(SELECT RID FROM ebnpsm_customer_user WHERE CustomerID = iCID AND RID = iUserID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid User');
	END IF;
    
	IF iConsultantID = 0 OR NOT EXISTS(SELECT RID FROM ebnp_cand_personal_info WHERE CID = iCID AND RID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Employee');
	END IF;
	
	IF iStaffingID = 0 AND iReqConsID = 0 THEN 
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Employee Reference');
	END IF;
    
    IF iStaffingID = 0 AND iReqConsID > 0 THEN 
		SELECT si.RID INTO iStaffingID 
				FROM ebnp_cand_staffing_info si 
				JOIN ebnp_req_resumes rr ON rr.CID = si.CID AND rr.ConsultantID = si.ConsultantID and rr.ClientID = si.ClientID and rr.ContractID = si.ContractID 
				WHERE si.CID = iCID AND rr.RID = iReqConsID AND rr.ConsultantID = iConsultantID ORDER BY si.RID DESC LIMIT 1;
		IF ISNULL(iStaffingID) = 1 THEN SET iStaffingID = 0; END IF;
    END IF;
     
    IF iStaffingID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_cand_staffing_info WHERE CID = iCID AND RID = iStaffingID AND ConsultantID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Staffing');	
	ELSEIF iReqConsID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID AND ConsultantID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Sourcing');			
	END IF;
    
	IF iStaffingID > 0 THEN 
		SELECT ClientID, ContractID INTO iClientID, iContractID	FROM ebnp_cand_staffing_info WHERE CID = iCID AND RID = iStaffingID;
	ELSEIF iReqConsID > 0 THEN 
		SELECT ClientID, ContractID INTO iClientID, iContractID	FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID;
	END IF;
	
	IF iRID = 0 and EXISTS (SELECT RID FROM ebnp_consultant_field_change_request WHERE CID = iCID AND ConsultantID = iConsultantID AND ChangeType = iChangeType AND Status = 0) THEN
		SET tStatusMsg = CONCAT(tStatusMsg, "/Field approval request already raised");
	END IF;
    
    IF iRID = 0 AND EXISTS (SELECT RID FROM ebnp_consultant_field_change_request WHERE CID = iCID AND ConsultantID = iConsultantID AND ChangeType = iChangeType AND Status = 0) THEN
		SET tStatusMsg = "/Request already in pending";
    END IF;
    
    -- CTC CHANGE => Re-request can be raised only previous status is in Processed / Rejected 
    IF iChangeType = 0 AND iRID = 0 AND EXISTS (SELECT RID FROM ebnp_consultant_field_change_request WHERE CID = iCID AND ConsultantID = iConsultantID AND ChangeType = iChangeType AND Status not in (2,3) order by rid desc limit 1 ) THEN
		SET tStatusMsg = "/Previous Request not yet Processed";
    END IF;
    
    -- 9 - Transfer
    IF iChangeType = 9 AND iRID = 0 AND iStaffingID > 0 THEN
		IF EXISTS(Select RID From ebnp_consultant_register Where CID = iCID AND ConsultantID = iConsultantID AND StaffingID= iStaffingID AND IsDeleted = 0 and Status = 0) Then
			Set tStatusMsg = CONCAT(tStatusMsg, "/Old Staffing's E&D is Pending, Kindly process or remove ");
        END IF;
    END IF;
    
    -- (enum) ChangeType = '0-CTCChange, 1-BillRateChange, 2-EmploymentStatusChange, 3-ProbationConfirmation, 4-OnboardingInitiate, 
    -- 			5-JoiningConfirmation, 6-ResignationConfirmation, 7-FNFApproval, 8-StaffingDtlsChange, 9-StaffingTransfer'
    
	SET iType = (case iChangeType WHEN 0 THEN 12 WHEN 1 THEN 16 WHEN 2 THEN 17 WHEN 3 THEN 18 WHEN 4 THEN 19 WHEN 5 THEN 20 WHEN 6 THEN 21 WHEN 7 THEN 22 WHEN 8 THEN 23 WHEN 9 THEN 24 END);
   
    
	     -- ebnpm_ess_approval_settings.Type = 12-CTCChange, 16-BillRateChange, 17-EmploymentStatusChange, 18-ProbationConfirmation, 19-OnboardingInitiate, 
		 -- 20-JoiningConfirmation, 21-ResignationConfirmation, 22-FNFApproval, 23-StaffingDtlsChange, 24-StaffingTransfer'
    IF NOT EXISTS (Select RID FROM ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = iType) THEN 
		SET iClientID = 0;
	END IF;
            
	if not exists(select RID from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = iType) then
		Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid approver, Please contact to HR");
	else 
		begin
			select group_concat(ApproveType) into tAllApprType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = iType;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(1, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID and ContactID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Staffing Reporting Manager missing for request approve. Please contact HR ");
				end if;
			ELSE
				if (select find_in_set(1, tAllApprType)) and exists (select rr.RID from ebnp_req_resumes rr 
								JOIN ebnp_client_requirements cr ON cr.RID = rr.ReqID AND cr.CID = rr.CID 
									where rr.CID = iCID AND rr.RID = iReqConsID and cr.ContactID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Requirement Contact missing for request approve. Please contact HR ");
				end if;
			END IF;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(2, tAllApprType)) and exists (select RID from ebnp_cand_hr_details where CID = iCID AND ConsultantID = iConsultantID and ERManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/ER Manger missing for Offer request approve. Please contact HR ");
				end if;
			ELSE
				if (select find_in_set(2, tAllApprType)) and exists (select rr.RID from ebnp_req_resumes rr 
								JOIN ebnp_client_requirements cr ON cr.RID = rr.ReqID AND cr.CID = rr.CID 
									where rr.RID = iReqConsID and cr.AnchorID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Requirement Anchor missing for request approve. Please contact HR ");
				end if;
			END IF;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(3, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID and ReportingPerson1ID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Primary Reporting Manager missing for request approve. Please contact HR ");
				end if;
			ELSE
				IF find_in_set(3, tAllApprType)THEN
				set tStatusMsg = CONCAT(tStatusMsg, "/Primary Reporting Manager missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(4, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID and ReportingPerson2ID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Secondary Reporting Manager missing for request approve. Please contact HR ");
				end if;
			ELSE
				IF find_in_set(4, tAllApprType) THEN
				set tStatusMsg = CONCAT(tStatusMsg, "/Secondary Reporting Manager missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			if (select find_in_set(5, tAllApprType)) and exists (select RID from ebnp_client_contracts where CID = iCID AND RID = iContractID and AnchorID = 0) then
				set tStatusMsg = CONCAT(tStatusMsg, "/Contract Anchor missing for request approve. Please contact HR ");
			end if;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(6, tAllApprType)) and  (select p.ProjectPartnerID from ebnp_client_contract_project p 
																			left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID AND t.CID = p.CID 
																			where p.CID = iCID order by t.RID desc, p.RID desc limit 1
													) = 0 then
					set tStatusMsg = CONCAT(tStatusMsg, "/Project Manager missing for request approve. Please contact HR ");
				end if;
			ELSE 
				IF find_in_set(6, tAllApprType) THEN
				set tStatusMsg = CONCAT(tStatusMsg, "/Project Manager missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(7, tAllApprType)) and  exists (select RID from ebnp_clients where CID = iCID AND RID = (select ClientID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID) and AnchorID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Client/Business Anchor missing for request approve. Please contact HR ");
				END IF;
			ELSE
				if (select find_in_set(7, tAllApprType)) and  exists (select RID from ebnp_clients where CID = iCID AND RID = (select ClientID from ebnp_req_resumes where CID = iCID AND RID = iReqConsID) and AnchorID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Client/Business Anchor missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			-- ApproverType = 8 is HR Manager/Core App User updated status
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(9, tAllApprType)) and exists (select RID from ebnp_clients where CID = iCID AND RID = (select ClientID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID) and EmpManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Client Department Manager missing for request approve. Please contact HR ");
				END IF;
			ELSE
				if (select find_in_set(9, tAllApprType)) and exists (select RID from ebnp_clients where CID = iCID AND RID = (select ClientID from ebnp_req_resumes where CID = iCID AND RID = iReqConsID) and EmpManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Client Department Manager missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(10, tAllApprType)) and exists (select RID from ebnp_client_branchs where CID = iCID AND RID = (select BranchID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID) and EmpManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Branch Department Manager missing for request approve. Please contact HR ");
				END IF;
			else
				if (select find_in_set(10, tAllApprType)) and exists (select RID from ebnp_client_branchs where CID = iCID AND RID = (select BranchID from ebnp_req_resumes where CID = iCID AND RID = iReqConsID) and EmpManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Branch Department Manager missing for request approve. Please contact HR ");
				END IF;
			END IF;
			
			if (select find_in_set(11, tAllApprType)) and exists (select RID from ebnp_client_contracts where CID = iCID AND RID = iContractID and EmpManagerID = 0) then
				set tStatusMsg = CONCAT(tStatusMsg, "/Contract Department Manager missing for request approve. Please contact HR ");
			END IF; 
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(12, tAllApprType)) and NOT EXISTS (select RID from ebnpsm_customer_user where CustomerID = iCID AND RID = (Select AnchorID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Anchor missing for request approve. Please contact HR ");
				END IF; 
			ELSE 
				IF find_in_set(12, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Anchor missing for request approve. Please contact HR ");
				END IF; 
			END IF; 
			
			IF iStaffingID > 0 THEN 
				IF (select find_in_set(13, tAllApprType)) and not exists (select RID from ebnpsm_customer_user where RID = (select cc.ManagerID from ebnpsm_customer_cc cc 
																					JOIN ebnp_cand_staffing_info s ON s.BillingCostCenterID = cc.RID and s.CID=cc.CustomerID and s.RID = iStaffingID) ) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Cost Center Manager missing for request approve. Please contact HR ");
				END IF;
			ELSE 
				IF find_in_set(13, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Cost Center Manager missing for request approve. Please contact HR ");
				END IF; 
			END IF; 
			
            IF iStaffingID > 0 THEN 
				if (select find_in_set(17, tAllApprType)) and NOT EXISTS (select RID from ebnp_client_contact where CID = iCID AND RID = (Select EmpManagerID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Manager missing for request approve. Please contact HR ");
				END IF; 
			ELSE 
				IF find_in_set(17, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Manager missing for request approve. Please contact HR ");
				END IF; 
			END IF; 
			
			IF iStaffingID > 0 THEN 
				if (select find_in_set(18, tAllApprType)) and NOT EXISTS (select RID from ebnpsm_customer_user where CustomerID = iCID AND RID = (Select SalesAnchorID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Sales Anchor missing for request approve. Please contact HR ");
				END IF; 
			ELSE 
				IF find_in_set(18, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Business Sales Anchor missing for request approve. Please contact HR ");
				END IF; 
			END IF;
            
		end;
	end if;
    
    -- 12-CTCChange, 16-BillRateChange, 17-EmploymentStatusChange, 23-StaffingDtlsChange, 24-StaffingTransfer
    IF iType IN (12,16,17,23,24) THEN 
		select ifnull(ApproveType, 0), ApproverID into iApproveType, iFixedApproverID from ebnpm_ess_approval_settings 
					where CID = iCID and ClientID = iClientID AND IsDeleted = 0 and Type = iType order by SlNo limit 1;
	ELSE
		select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings 
					where CID = iCID and ClientID = iClientID and IsDeleted = 0 and Type = iType order by SlNo limit 1;
	END IF;
    
	IF tStatusMsg != "" THEN
		SET iStatus = -5;
        set iClientID = 0;
		IF SUBSTRING(tStatusMsg, 1, 1) = "/" THEN
			SET tStatusMsg = SUBSTRING(tStatusMsg, 2);
		END IF;
	ELSE 
		 SET tStatusMsg = "Valid";
	END IF;
    
END $$
DELIMITER ;

DROP PROCEDURE IF EXISTS `SP_VALIDATE_CONS_ONBOARD_REQUEST`;
DELIMITER ;;
CREATE PROCEDURE `SP_VALIDATE_CONS_ONBOARD_REQUEST`(
iRID BIGINT,
iCID BIGINT,
iConsultantID BIGINT,
iStaffingID BIGINT,
iReqConsID BIGINT,

iUserID BIGINT,
OUT iStatus SMALLINT,
OUT tStatusMsg TEXT,
OUT iApproveType TINYINT,
OUT iFixedApproverID BIGINT 
)
BEGIN

    DECLARE iClientID, iContractID BIGINT DEFAULT 0;
    DECLARE iMandOnBoardInitateApp TINYINT DEFAULT 0;
    DECLARE tAllApprType TEXT DEFAULT "";
        
	SET iStatus = 0;
    SET tStatusMsg = "";
    SET iApproveType = 0;SET iFixedApproverID = 0;
    
    Select MandOnBoardInitateApp INTO iMandOnBoardInitateApp FROM ebnpsm_customer_app_config WHERE CID = iCID ORDER BY RID DESC LIMIT 1; 
    
    IF iRID > 0 THEN
		SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard already processed, Kindly cancel and raise a new request."); 
	END IF;
            
     IF iCID = 0 or NOT EXISTS(SELECT RID FROM ebnpsm_customer WHERE RID = iCID) THEN
			SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Customer');
	END IF;
		
	IF iConsultantID = 0 OR NOT EXISTS(SELECT RID FROM ebnp_cand_personal_info WHERE CID = iCID AND RID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Consultant');
	END IF; 
    
    IF iReqConsID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Resume ID');
	END IF;      
    
	IF iStaffingID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_cand_staffing_info WHERE CID = iCID AND RID = iStaffingID AND ConsultantID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Staffing');
	ELSEIF iReqConsID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID AND ConsultantID = iConsultantID ) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Resume ID');    
	ELSEIF tStatusMsg = "" THEN 
		BEGIN
			IF iStaffingID > 0 THEN 
				SELECT  ClientID, ContractID INTO  iClientID, iContractID 					
					FROM ebnp_cand_staffing_info 
					WHERE RID = iStaffingID AND CID = iCID AND ConsultantID = iConsultantID;
			ELSEIF iReqConsID > 0 THEN 
				SELECT  ClientID, ContractID INTO  iClientID, iContractID 					
					FROM ebnp_req_resumes 
					WHERE RID = iReqConsID AND CID = iCID AND ConsultantID = iConsultantID;
            END IF;
			

			IF iStaffingID > 0 AND EXISTS (select rid from ebnp_cand_onboarding_initiate_approve where CID = iCID AND RID != iRID and StaffingID = iStaffingID and Status = 1 ) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard request already raised");
			ELSEIF iReqConsID > 0 AND EXISTS (select rid from ebnp_cand_onboarding_initiate_approve where CID = iCID AND RID != iRID and ReqConsID = iReqConsID and Status =1 ) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard request already raised");
			END IF;
           
           IF iStaffingID > 0 AND EXISTS (select rid from ebnp_cand_onboarding_initiate_approve where CID = iCID AND RID != iRID and StaffingID = iStaffingID and Status = 2 ) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard request already processed");
			ELSEIF iReqConsID > 0 AND EXISTS (select rid from ebnp_cand_onboarding_initiate_approve where CID = iCID AND RID != iRID and ReqConsID = iReqConsID and Status = 2 ) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard request already processed");
			END IF;
           
            /*
			IF iRID > 0 AND exists (select rid from ebnp_cand_onboarding_initiate_approve where cid = iCID AND RID = iRID and Status = 3 ) 
							and exists(select rid from ebnpsm_customer_app_config where CID = iCID and iMandOnBoardInitateApp != 0) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Onboard Request already processed, Edit restricted. Contact HR");
			END IF; */
			
			if exists(select RID from ebnpsm_customer_app_config where CID = iCID and MandOnBoardInitateApp = 0) then
				SET tStatusMsg = CONCAT(tStatusMsg, "/Access Denied");
			END IF;
            
			IF NOT EXISTS (Select RID FROM ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10) THEN 
				SET iClientID = 0;
			END IF;
            
            -- Checking for Approver    
            if exists(Select RID from ebnpsm_customer_app_config WHERE CID = iCID and MandOnBoardInitateApp = 1) then
				if not exists(select RID from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10) then
					Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid OnBoard approver, please contact to HR");
				else 
					begin
						select group_concat(ApproveType) into tAllApprType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10;
                        
                        if (select find_in_set(1, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ContactID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Staffing Reporting Manager missing for request approve. Please contact HR ");
						end if;
                        
                        if (select find_in_set(2, tAllApprType)) and exists (select RID from ebnp_cand_hr_details where ConsultantID = iConsultantID and ERManagerID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/ER Manger missing for request approve. Please contact HR ");
						end if;
                        
                        if (select find_in_set(3, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson1ID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Primary Reporting Manager missing for request approve. Please contact HR ");
						end if;
                        
                        if (select find_in_set(4, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson2ID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Secondary Reporting Manager missing for request approve. Please contact HR ");
						end if;
                        
                        if (select find_in_set(5, tAllApprType)) and exists (select RID from ebnp_client_contracts where RID in (select ContractID from ebnp_cand_staffing_info where RID = iStaffingID) and AnchorID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Contract Anchor missing for request approve. Please contact HR ");
						end if;
                        
                        if (select find_in_set(6, tAllApprType)) and  (select p.ProjectPartnerID from ebnp_client_contract_project p 
																					left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
																					where p.CID = iCID order by t.RID desc, p.RID desc limit 1
															) = 0 then
							set tStatusMsg = CONCAT(tStatusMsg, "/Project Manager missing for request approve. Please contact HR ");
						end if;
                        
                        IF (select find_in_set(7, tAllApprType)) and  exists (select RID from ebnp_clients where RID = (select ClientID from ebnp_cand_staffing_info where RID = iStaffingID) and AnchorID = 0) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Client/Business Anchor missing for request approve. Please contact HR ");
						END IF;
                        
                        IF (select find_in_set(12, tAllApprType)) and not exists (select RID from ebnpsm_customer_user where RID = (Select AnchorID FROM ebnp_clients where RID = (select BUID from ebnp_cand_staffing_info where RID = iStaffingID)) ) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Business Anchor missing for request approve. Please contact HR ");
						END IF;
                        
                        IF (select find_in_set(13, tAllApprType)) and not exists (select RID from ebnpsm_customer_user where RID = (select cc.ManagerID from ebnpsm_customer_cc cc 
																							JOIN ebnp_cand_staffing_info s ON s.BillingCostCenterID = cc.RID and s.CID=cc.CustomerID and s.RID = iStaffingID) ) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Cost Center Manager missing for request approve. Please contact HR ");
						END IF;
                        
						if (select find_in_set(17, tAllApprType)) and NOT EXISTS (select RID from ebnp_client_contact where CID = iCID AND RID = (Select EmpManagerID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Business Manager missing for request approve. Please contact HR ");
						END IF; 
                        
						if (select find_in_set(18, tAllApprType)) and NOT EXISTS (select RID from ebnpsm_customer_user where CustomerID = iCID AND RID = (Select SalesAnchorID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
							set tStatusMsg = CONCAT(tStatusMsg, "/Business Sales Anchor missing for request approve. Please contact HR ");
						END IF; 
                        
                    END;
				END IF;
			END IF;   

			IF tStatusMsg = "" THEN
				if exists(Select RID from ebnpsm_customer_app_config WHERE CID = iCID and MandOnBoardInitateApp = 1) then       
					begin
						
                        select ifnull(ApproveType, 0),ApproverID into iApproveType,iFixedApproverID from ebnpm_ess_approval_settings where 
							CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 order by SlNo limit 1;
                        
                        if iApproveType = 1 then
							if exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ContactID = 0) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 2 then
							if exists (select RID from ebnp_cand_hr_details where ConsultantID = iConsultantID and ERManagerID = 0) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 3 then
							if exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson1ID = 0) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 4 then
							if exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson2ID = 0) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 5 then
							if exists (select RID from ebnp_client_contracts where RID in (select ContractID from ebnp_cand_staffing_info where RID = iStaffingID) and AnchorID = 0) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 6 then
							if (select p.ProjectPartnerID from ebnp_client_contract_project p 
																					left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
																					where p.CID = iCID order by t.RID desc, p.RID desc limit 1
								) = 0 then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 12 then
							if exists (select RID from ebnpsm_customer_user where CustomerID = iCID and RID = (Select AnchorID FROM ebnp_clients where CID = iCID and RID = (select BUID from ebnp_cand_staffing_info where CID = iCID and RID = iStaffingID))) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
                        elseif iApproveType = 13 then
							if exists (select RID from ebnpsm_customer_user where RID = (select cc.ManagerID from ebnpsm_customer_cc cc 
													JOIN ebnp_cand_staffing_info s ON s.BillingCostCenterID = cc.RID and s.CID=cc.CustomerID and s.RID = iStaffingID)) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 17 then
							if exists (select RID from ebnp_client_contact where CID = iCID and RID = (Select EmpManagerID FROM ebnp_clients where CID = iCID and RID = (select BUID from ebnp_cand_staffing_info where CID = iCID and RID = iStaffingID))) then
								select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and Type = 10 
											and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and 
											Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
							end if;
						elseif iApproveType = 18 then
								if exists (select RID from ebnpsm_customer_user where CustomerID = iCID and RID = (Select SalesAnchorID FROM ebnp_clients where CID = iCID and RID = (select BUID from ebnp_cand_staffing_info where CID = iCID and RID = iStaffingID))) then
									select ifnull(ApproveType, 0) into iApproveType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and Type = 10 
												and SlNo > IFNULL((select SlNo from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID and IsDeleted = 0  and 
												Type = 10 and ApproveType = iApproveType), 0) order by SlNo limit 1;
								end if;
						end if;
                        
					end;		
				else 
					set iApproveType = 0;
				end if; 
			END IF;
		END;
	END IF;
    
	IF tStatusMsg != "" THEN
		SET iStatus = -5;

		IF SUBSTRING(tStatusMsg, 1, 1) = "/" THEN
			SET tStatusMsg = SUBSTRING(tStatusMsg, 2);
		END IF;
	ELSE 
		SET iStatus = 0;
		SET tStatusMsg = "Valid";
	END IF;
    
END ;;
DELIMITER ;


DROP PROCEDURE IF EXISTS `SP_VALIDATE_OFFER_REQUEST`;
DELIMITER $$
CREATE  PROCEDURE `SP_VALIDATE_OFFER_REQUEST`(
iCID BIGINT,
iConsultantID BIGINT,
iReqConsID BIGINT,
iStaffingID BIGINT,

iApproverStatus tinyint,
tOfferRemark TEXT,

iUserID BIGINT,

out iApproveType smallint,
OUT iStatus SMALLINT,
out tStatusMsg text,
OUT iFixedApproverID BIGINT
)
BEGIN
	declare iContractID ,iClientID bigint default 0;
    DECLARE iBranchDmID , iContractDmID , iClientDMID,iCCManagerID BIGINT default 0;
    declare tAllApprType text default "";
   
    set iApproveType = 0 ;
	SET iStatus = 0;
	SET iFixedApproverID = 0;
    set tStatusMsg = "";    
 
    IF iCID = 0 or NOT EXISTS(SELECT RID FROM ebnpsm_customer WHERE RID = iCID) THEN
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Customer');
	END IF;
    
    IF iUserID = 0 OR NOT EXISTS(SELECT RID FROM ebnpsm_customer_user WHERE CustomerID = iCID AND RID = iUserID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid User');
	END IF;
    
	IF iConsultantID = 0 OR NOT EXISTS(SELECT RID FROM ebnp_cand_personal_info WHERE CID = iCID AND RID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Employee');
	END IF;
	
	IF iStaffingID = 0 AND iReqConsID = 0 THEN 
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Employee Reference');
	END IF;
    
    IF iStaffingID = 0 AND iReqConsID > 0 THEN 
		SELECT si.RID INTO iStaffingID 
				FROM ebnp_cand_staffing_info si 
				JOIN ebnp_req_resumes rr ON rr.CID = si.CID AND rr.ConsultantID = si.ConsultantID and rr.ClientID = si.ClientID and rr.ContractID = si.ContractID 
				WHERE si.CID = iCID AND rr.RID = iReqConsID AND rr.ConsultantID = iConsultantID ORDER BY si.RID DESC LIMIT 1;
		IF ISNULL(iStaffingID) = 1 THEN SET iStaffingID = 0; END IF;
    END IF;
	
    IF iStaffingID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_cand_staffing_info WHERE CID = iCID AND RID = iStaffingID AND ConsultantID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Staffing');	
	ELSEIF iReqConsID > 0 AND NOT EXISTS(SELECT RID FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID AND ConsultantID = iConsultantID) then
		SET tStatusMsg = CONCAT(tStatusMsg, '/Invalid Sourcing');			
	END IF;
    
	IF iStaffingID > 0 THEN 
		SELECT ClientID, ContractID INTO iClientID, iContractID	FROM ebnp_cand_staffing_info WHERE CID = iCID AND RID = iStaffingID;
	ELSEIF iReqConsID > 0 THEN 
		SELECT ClientID, ContractID INTO iClientID, iContractID	FROM ebnp_req_resumes WHERE CID = iCID AND RID = iReqConsID;
	END IF;
	
    -- IF NOT EXISTS(select RID from ebnp_client_contracts_options where EnableOfferApproval = 1 and CID = iCID AND ContractID=iContractID  ) then
	
	IF NOT EXISTS(select RID FROM ebnpm_hr_options where EnableOfferApproval = 1 and  RID = (SELECT HROptionID from  ebnp_client_contracts c 
																				where c.RID =iContractID  and  c.CID = iCID )) then
		set tStatusMsg = concat(tStatusMsg,"/Offer approval not applicable");
    end if;

	IF EXISTS(Select RID FROM ebnp_req_resumes_extend WHERE CID = iCID AND ReqResumeID = iReqConsID AND ConsultantID = iConsultantID AND OfferApprovalStatus = 1) THEN 
		SET tStatusMsg = CONCAT(tStatusMsg, "/Offer approval request already raised");
	END IF;
	     
    IF NOT EXISTS (Select RID FROM ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 9) THEN 
		SET iClientID = 0;
	END IF;
            
	-- if exists(Select RID from ebnp_client_contracts_options WHERE CID = iCID and EnableOfferApproval = 1) then
	
    if iStaffingID > 0 then
		select RID into iCCManagerID from ebnpsm_customer_user where RID = (select cc.ManagerID from ebnpsm_customer_cc cc 
		JOIN ebnp_cand_staffing_info s ON s.BillingCostCenterID = cc.RID and s.CID=cc.CustomerID and s.RID = iStaffingID);
		if isnull(iCCManagerID) = 1 then set iCCManagerID = 0 ; end if;
    End if;
   
	IF  EXISTS(select RID FROM ebnpm_hr_options where EnableOfferApproval = 1 and  RID = (SELECT HROptionID from  ebnp_client_contracts c 
																				where c.RID = iContractID and c.CID = iCID )) then
	
		if not exists(select RID from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 9) then
			Set tStatusMsg = CONCAT(tStatusMsg, "/Invalid Offer approver, Please contact to HR");
		else 
			begin
				select group_concat(ApproveType) into tAllApprType from ebnpm_ess_approval_settings where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 9;
				
				IF iStaffingID > 0 THEN 
					if (select find_in_set(1, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ContactID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Staffing Reporting Manager missing for request approve. Please contact HR ");
					end if;
				ELSE
					if (select find_in_set(1, tAllApprType)) and exists (select rr.RID from ebnp_req_resumes rr 
									JOIN ebnp_client_requirements cr ON cr.RID = rr.ReqID AND cr.CID = rr.CID 
										where rr.RID = iReqConsID and cr.ContactID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Requirement Contact missing for request approve. Please contact HR ");
					end if;
				END IF;
				
				IF iStaffingID > 0 THEN 
					if (select find_in_set(2, tAllApprType)) and exists (select RID from ebnp_cand_hr_details where ConsultantID = iConsultantID and ERManagerID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/ER Manger missing for Offer request approve. Please contact HR ");
					end if;
				ELSE
					if (select find_in_set(2, tAllApprType)) and exists (select rr.RID from ebnp_req_resumes rr 
									JOIN ebnp_client_requirements cr ON cr.RID = rr.ReqID AND cr.CID = rr.CID 
										where rr.RID = iReqConsID and cr.AnchorID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Requirement Anchor missing for request approve. Please contact HR ");
					end if;
				END IF;
				
                IF iStaffingID > 0 THEN 
					if (select find_in_set(3, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson1ID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Primary Reporting Manager missing for request approve. Please contact HR ");
					end if;
				ELSE
					IF find_in_set(3, tAllApprType)THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Primary Reporting Manager missing for request approve. Please contact HR ");
					END IF;
                END IF;
                
                IF iStaffingID > 0 THEN 
					if (select find_in_set(4, tAllApprType)) and exists (select RID from ebnp_cand_staffing_info where RID = iStaffingID and ReportingPerson2ID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Secondary Reporting Manager missing for request approve. Please contact HR ");
					end if;
				ELSE
					IF find_in_set(4, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Secondary Reporting Manager missing for request approve. Please contact HR ");
					END IF;
                END IF;
                
				if (select find_in_set(5, tAllApprType)) and exists (select RID from ebnp_client_contracts where RID = iContractID and AnchorID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Contract Anchor missing for request approve. Please contact HR ");
				end if;
				
                IF iStaffingID > 0 THEN 
					if (select find_in_set(6, tAllApprType)) and  (select p.ProjectPartnerID from ebnp_client_contract_project p 
																				left join ebnp_cand_staffing_projects t on t.StaffingID = iStaffingID and t.ProjectID = p.RID
																				where p.CID = iCID order by t.RID desc, p.RID desc limit 1
														) = 0 then
						set tStatusMsg = CONCAT(tStatusMsg, "/Project Manager missing for request approve. Please contact HR ");
					end if;
				ELSE 
					IF find_in_set(6, tAllApprType) THEN
					set tStatusMsg = CONCAT(tStatusMsg, "/Project Manager missing for request approve. Please contact HR ");
					END IF;
                END IF;
				
				IF iStaffingID > 0 THEN 
					if (select find_in_set(7, tAllApprType)) and  exists (select RID from ebnp_clients where RID = (select ClientID from ebnp_cand_staffing_info where RID = iStaffingID) and AnchorID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Client/Business Anchor missing for request approve. Please contact HR ");
					END IF;
				ELSE
					if (select find_in_set(7, tAllApprType)) and  exists (select RID from ebnp_clients where RID = (select ClientID from ebnp_req_resumes where RID = iReqConsID) and AnchorID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Client/Business Anchor missing for request approve. Please contact HR ");
					END IF;
				END IF;
                
				-- ApproverType = 8 is HR Manager/Core App User updated status
				
				IF iStaffingID > 0 THEN 
					if (select find_in_set(9, tAllApprType)) and exists (select RID from ebnp_clients where RID = (select ClientID from ebnp_cand_staffing_info where RID = iStaffingID) and EmpManagerID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Client Department Manager missing for request approve. Please contact HR ");
					END IF;
				ELSE
					if (select find_in_set(9, tAllApprType)) and exists (select RID from ebnp_clients where RID = (select ClientID from ebnp_req_resumes where RID = iReqConsID) and EmpManagerID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Client Department Manager missing for request approve. Please contact HR ");
					END IF;
				END IF;
                
				IF iStaffingID > 0 THEN 
					if (select find_in_set(10, tAllApprType)) and exists (select RID from ebnp_client_branchs where RID = (select BranchID from ebnp_cand_staffing_info where RID = iStaffingID) and EmpManagerID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Branch Department Manager missing for request approve. Please contact HR ");
					END IF;
				else
					if (select find_in_set(10, tAllApprType)) and exists (select RID from ebnp_client_branchs where RID = (select BranchID from ebnp_req_resumes where CID = iCID AND RID = iReqConsID) and EmpManagerID = 0) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Branch Department Manager missing for request approve. Please contact HR ");
					END IF;
				END IF;
                
				if (select find_in_set(11, tAllApprType)) and exists (select RID from ebnp_client_contracts where RID = iContractID and EmpManagerID = 0) then
					set tStatusMsg = CONCAT(tStatusMsg, "/Contract Department Manager missing for request approve. Please contact HR ");
				END IF; 
				
                IF iStaffingID > 0 THEN 
					if (select find_in_set(12, tAllApprType)) and NOT EXISTS (select RID from ebnpsm_customer_user where CustomerID = iCID AND RID = (Select AnchorID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Anchor missing for request approve. Please contact HR ");
					END IF; 
				ELSE 
					IF find_in_set(12, tAllApprType) THEN
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Anchor missing for request approve. Please contact HR ");
					END IF; 
				END IF; 
            
                IF iStaffingID > 0 then
					if (select find_in_set(13, tAllApprType)) and ifnull(iCCManagerID,0) = 0 then
						set tStatusMsg = CONCAT(tStatusMsg, "/Cost Center Manager missing for request approve. Please contact HR ");
					END IF;
                ELSE 
					IF find_in_set(13, tAllApprType) THEN
						set tStatusMsg = CONCAT(tStatusMsg, "/Cost Center Manager missing for request approve. Please contact HR ");
					END IF; 
                END IF;
                
                IF iStaffingID > 0 THEN 
					if (select find_in_set(17, tAllApprType)) and NOT EXISTS (select RID from ebnp_client_contact where CID = iCID AND RID = (Select EmpManagerID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Manager missing for request approve. Please contact HR ");
					END IF; 
				ELSE 
					IF find_in_set(17, tAllApprType) THEN
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Manager missing for request approve. Please contact HR ");
					END IF; 
				END IF; 
                
                IF iStaffingID > 0 THEN 
					if (select find_in_set(18, tAllApprType)) and NOT EXISTS (select RID from ebnpsm_customer_user where CustomerID = iCID AND RID = (Select SalesAnchorID FROM ebnp_clients where CID = iCID AND RID = (select BUID from ebnp_cand_staffing_info where CID = iCID AND RID = iStaffingID)) ) then
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Sales Anchor missing for request approve. Please contact HR ");
					END IF; 
				ELSE 
					IF find_in_set(18, tAllApprType) THEN
						set tStatusMsg = CONCAT(tStatusMsg, "/Business Sales Anchor missing for request approve. Please contact HR ");
					END IF; 
				END IF;
                
			end;
		end if;
	end if; 
    
	-- if exists(Select RID from ebnp_client_contracts_options WHERE CID = iCID AND ContractID = iContractID and EnableOfferApproval = 1) then
		
	IF  EXISTS(select RID FROM ebnpm_hr_options where EnableOfferApproval = 1 and  RID = (SELECT HROptionID from ebnp_client_contracts c 
																				where c.RID =iContractID  and  c.CID = iCID )) then
	
		select ifnull(ApproveType, 0),ApproverID into iApproveType,iFixedApproverID from ebnpm_ess_approval_settings 
					where CID = iCID and ClientID = iClientID  and IsDeleted = 0 and Type = 9 order by SlNo limit 1;
	ELSE 
		set iApproveType = 0; 
	end if;
    
	IF tStatusMsg != "" THEN
		SET iStatus = -5;
        set iClientID = 0;
		IF SUBSTRING(tStatusMsg, 1, 1) = "/" THEN
			SET tStatusMsg = SUBSTRING(tStatusMsg, 2);
		END IF;
	ELSE 
		 SET tStatusMsg = "Valid";
	END IF;
    
END $$
DELIMITER ;
